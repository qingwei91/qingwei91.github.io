<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[All models are wrong]]></title><description><![CDATA[I write stuff so I can forget.]]></description><link>https://qingwei91.github.io</link><generator>GatsbyJS</generator><lastBuildDate>Wed, 30 Oct 2019 10:46:37 GMT</lastBuildDate><item><title><![CDATA[Thoughts]]></title><description><![CDATA[My random thoughts Efficient organization should be organized like clean code, leader should be able to use people like an API, where…]]></description><link>https://qingwei91.github.io/thoughts/</link><guid isPermaLink="false">https://qingwei91.github.io/thoughts/</guid><pubDate>Sun, 14 Jul 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;My random thoughts&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Efficient organization should be organized like clean code, leader should be able to use people like an API, where implementation details are hidden, and only results are reported back&lt;/li&gt;
&lt;li&gt;Code architecture is more important than code style&lt;/li&gt;
&lt;li&gt;Sometimes you have to make decision without all information you need, this is almost always better than not making decision&lt;/li&gt;
&lt;li&gt;The fundamental benefits of software is that software is extremely malleable, and we should focus on flexibility when building software&lt;/li&gt;
&lt;li&gt;Ability to write well is key to scaling engineering organization&lt;/li&gt;
&lt;li&gt;Knowledge is one of the most important asset of a software engineering organization, organization should have a strategy to store, retrieve, and communicate knowledge, and code is NOT the best way &lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Understanding Free Monad]]></title><description><![CDATA[Understanding Free Monad I recently find out I dont really understand Free Monad, I have some high level understanding about Free Monad…]]></description><link>https://qingwei91.github.io/free-monad/</link><guid isPermaLink="false">https://qingwei91.github.io/free-monad/</guid><pubDate>Sun, 14 Jul 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Understanding Free Monad&lt;/h2&gt;
&lt;p&gt;I recently find out I dont really understand Free Monad, I have some high level understanding about Free Monad:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Free monad allow you to convert a Higher Kinded type &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; to Monad for free if there exists a &lt;code class=&quot;language-text&quot;&gt;Functor[F]&lt;/code&gt; instance.&lt;/li&gt;
&lt;li&gt;Free monad allow us to build a program as tree-like recursive data structure, when can then be interpreted into runtime effect.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;but I never really understand why Free Monad (aka Free in the rest of this post) is the way it is, so I when on to read and this post is to write down what I’ve learned.&lt;/p&gt;
&lt;h3&gt;How you might have re-invent Free Monad&lt;/h3&gt;
&lt;p&gt;Our goal is to figure out a way to represent program as data structure, let’s use a ~simple~ cool example: &lt;code class=&quot;language-text&quot;&gt;Making a half boiled egg&lt;/code&gt;  &lt;/p&gt;
&lt;p&gt;Here’s a recipe to make 3 &lt;a href=&quot;https://www.malaysianchinesekitchen.com/half-boiled-eggs/&quot;&gt;half boiled eggs&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Pour 700ml of water into a sauce pan&lt;/li&gt;
&lt;li&gt;Heat the saucepan&lt;/li&gt;
&lt;li&gt;Wait until water is boiled&lt;/li&gt;
&lt;li&gt;Turn off the stove and put 3 eggs into the saucepan &lt;/li&gt;
&lt;li&gt;Wait for 7 minutes&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Let’s try to create a type to represent this process&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// version 1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; HalfBoiledEgg
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; PourWaterIntoPan &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; TurnOnTheGas &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; CheckIfBoiled &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; TurnOffTheGas &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PlaceEggInPan&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;quantity&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; WaitFor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minute&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We converted the english instructions in recipe into an ADT in Scala, and we want to create a program by running these instructions 1 by 1.&lt;/p&gt;
&lt;p&gt;Can we put instructions into a List? then they will express the idea of one followed by another.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;List&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  PourWaterIntoPan&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  TurnOnTheGas&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  CheckIfBoiled&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Nope, it does not work, we are stuck on step 4, because we wanted to check if the water is boiled, and react on it conditionally, meaning we need to get the result of &lt;code class=&quot;language-text&quot;&gt;CheckIfBoiled&lt;/code&gt; query, and make decision accordingly.&lt;/p&gt;
&lt;p&gt;Let’s try to model the idea of query, ie. to run a command and get a result back, we can specify the return type as a type parameter, when interpreted will return a value of the type. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// version 2&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; PourWaterIntoPan &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; TurnOnTheGas &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; CheckIfBoiled &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; TurnOffTheGas &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PlaceEggInPan&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;quantity&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; WaitFor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minute&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Hmm, this looks neat, it captures the essence of our domain, it uses the type param to communicate return type of each operation.&lt;/p&gt;
&lt;p&gt;Except that it lacks the ability to describe branching logic. We want to express something like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;  PourWaterIntoPan then 
  TurnOnTheGas then
  CheckIfBoiled then 
    if boiled do TurnOffTheGas
    else WaitFor(1) then CheckIfBoiled ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We need a way to express the idea of &lt;code class=&quot;language-text&quot;&gt;if Boiled do X, else do Y&lt;/code&gt;, one can think of it as some form of continuation, let’s model the idea of continuation into our tiny HalfBoiledEgg language.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PourWaterIntoPan&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; TurnOnTheGas&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; CheckIfBoiled&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; TurnOffTheGas&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PlaceEggInPan&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;quantity&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; WaitFor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minute&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Finished&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;endWith&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This time we add a &lt;code class=&quot;language-text&quot;&gt;next: HalfBoiledEgg[A]&lt;/code&gt; to all of our previous commands, to model the idea of continuation. We can keep continuing, since that would use up too much gas and eggs, so we introduce a &lt;code class=&quot;language-text&quot;&gt;Finished&lt;/code&gt; type to indicate reaching an end, and we might want to end our egg cooking process differently (maybe end it with a song?) so &lt;code class=&quot;language-text&quot;&gt;Finished&lt;/code&gt; takes a generic parameter.&lt;/p&gt;
&lt;p&gt;Now let’s try to write our egg boiling program to see if it works&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; checkUntilBoiled&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HalfBoiledEgg&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; CheckIfBoiled&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  boiled &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;boiled&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; next &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    WaitFor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; checkUntilBoiled&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; 

PourWaterIntoPan&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  TurnOnTheGas&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    checkUntilBoiled&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      TurnOffTheGas&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        PlaceEggInPan&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          WaitFor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Finished&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Voila, we are able to form a program that not just does &lt;code class=&quot;language-text&quot;&gt;if else&lt;/code&gt; branch, but we are also able to express loop by creating recursion data.&lt;/p&gt;
&lt;p&gt;It seems like such a structure is not unique to our problem, there should be other problem domain that can be expressed in similar structure, eg. grill a burger, make a pizza etc :D&lt;/p&gt;
&lt;p&gt;Are we able to refactor common components out into reusable pieces? &lt;/p&gt;
&lt;p&gt;Let’s revise what we have
a) A &lt;code class=&quot;language-text&quot;&gt;Finished&lt;/code&gt; type to indicate the end of the program and returns a value
b) A few types that allow expressing continuation via &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt;
c) A &lt;code class=&quot;language-text&quot;&gt;CheckIfBoiled&lt;/code&gt; type that express branching via &lt;code class=&quot;language-text&quot;&gt;a:A =&amp;gt; next&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Is there a way to define a structure that provides all 3 capabilities in a generic way, so that we can apply it to a different domain?&lt;/p&gt;
&lt;p&gt;Ideally we wish to only write our domain language like how we did with &lt;code class=&quot;language-text&quot;&gt;HalfBoiledEgg version 2&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So we have a &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; which has the kind of &lt;code class=&quot;language-text&quot;&gt;* =&amp;gt; *&lt;/code&gt;, and we wish to create a construct that can convert a &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; into a domain language that support the 3 capabilities mentioned.&lt;/p&gt;
&lt;p&gt;Assuming our generic construct is called &lt;code class=&quot;language-text&quot;&gt;Program&lt;/code&gt;, we want a &lt;code class=&quot;language-text&quot;&gt;F[_] =&amp;gt; Program&lt;/code&gt;, but we dont know what &lt;code class=&quot;language-text&quot;&gt;Program&lt;/code&gt; should looks like yet, let’s get started&lt;/p&gt;
&lt;p&gt;Describing the end of a program is straightforward&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; Program
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; TheEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Program 
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Continue&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; B&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cont&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;B&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Program
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Start&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Program&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here’s my first try&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Fix point type for GADT (Scala)]]></title><description><![CDATA[Prerequisite This article assumes the reader already know about Higher Kinded type (HKT) Fix point type Fix point type is a type that…]]></description><link>https://qingwei91.github.io/higher-fix/</link><guid isPermaLink="false">https://qingwei91.github.io/higher-fix/</guid><pubDate>Fri, 08 Feb 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Prerequisite&lt;/h2&gt;
&lt;p&gt;This article assumes the reader already know about&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Higher Kinded type (HKT)&lt;/li&gt;
&lt;li&gt;Fix point type&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Fix point type is a type that generically describes recursive data. By abstracting over a recursive data structure, we can define a generic operation that works on any recursive data structure.&lt;/p&gt;
&lt;p&gt;To learn more about HKT and Fix point type, check these links.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://typelevel.org/blog/2016/08/21/hkts-moving-forward.html&quot;&gt;Typelevel blogs for HKT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=7xSfLPD6tiQ&quot;&gt;Rob Norris’s awesome video about Fix Point Type and more&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://free.cofree.io/2017/11/13/recursion/&quot;&gt;Recursion Schemes in Scala&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Setup&lt;/h2&gt;
&lt;p&gt;You can run all code snippets in &lt;a href=&quot;https://ammonite.io&quot;&gt;ammonite-repl&lt;/a&gt;, for ADT definition, you need to enclose them in a curly brace like &lt;code class=&quot;language-text&quot;&gt;{ ...adt definition }&lt;/code&gt; before pasting to ammonite repl.&lt;/p&gt;
&lt;h2&gt;What this post is about?&lt;/h2&gt;
&lt;p&gt;You can find all of the code used in this post &lt;a href=&quot;https://gist.github.com/qingwei91/8079d8c731d352259e2d6334b2135300&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This post aims to document how to retain type information of Generalized Algebraic Data Type (GADT) with Fix point type. I will illustrate the technique by refactoring a GADT with direct recursion into another GADT without recursion and implement &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt; method for it.&lt;/p&gt;
&lt;p&gt;This technique can be useful when the type param of your original recursive GADT propagates through the layers of your recursive data structure. It might not make sense now, I suggest carry on reading :)&lt;/p&gt;
&lt;p&gt;The following code snippet shows a GADT that describes how to query a recursive data (e.g., JSON). It is super simple, it can only query String or Boolean by path, but we can add things like QueryByWithCondition later (not in the scope of this article).&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// simplified&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryString &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryBool &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// sample data&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   &quot;oh&quot;: {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//     &quot;my&quot;: &quot;zsh&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   }&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// }&lt;/span&gt;


&lt;span class=&quot;token comment&quot;&gt;// expression to query _.oh.my from JSON above&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; expression &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you might have noticed, the &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt; ADT is recursive, and the type param &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; is recursive too, when constructing &lt;code class=&quot;language-text&quot;&gt;QueryPath&lt;/code&gt; which extends &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt;, the type param is determined by the &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt; argument of &lt;code class=&quot;language-text&quot;&gt;QueryPath&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; typeMatch&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; B&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; B&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; eq&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;B&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; queryString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; queryNestedString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

typeMatch&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryString&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; queryNestedString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// compiles&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Having a type param is useful because, for any recursive query, we can know the result type statically without traversing the tree, which is a runtime property.&lt;/p&gt;
&lt;p&gt;The following steps are common when applying recursion schemes.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Refactor Recursive ADT to abstract recursion away&lt;/li&gt;
&lt;li&gt;Construct recursive data structure using Fix Point Type&lt;/li&gt;
&lt;li&gt;Define a Functor instance for the new Non-Recursive ADT&lt;/li&gt;
&lt;li&gt;Implement (or use them from a library) operations like &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;anamorphism&lt;/code&gt; on our recursive data structure&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;(For common use cases, we can use operations from recursion schemes library, e.g. &lt;a href=&quot;https://github.com/slamdata/matryoshka&quot;&gt;Matryoshka&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;We are going to follow the same steps here.&lt;/p&gt;
&lt;h3&gt;Step 1: Refactor GADT to remove recursion&lt;/h3&gt;
&lt;p&gt;The goal of this step is to remove recursion from our ADT, in our case, &lt;code class=&quot;language-text&quot;&gt;QueryPath&lt;/code&gt; should no longer refer to &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt; in its definition&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryStringF &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Nothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryBoolF &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Nothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above is the GADT after transformation, they are suffixed by &lt;code class=&quot;language-text&quot;&gt;F&lt;/code&gt; to differentiate with the previous GADT, few things to note&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We added a Higher Kinded Type (HKT) param &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; to &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt; base trait, and make it a covariant&lt;/li&gt;
&lt;li&gt;On &lt;code class=&quot;language-text&quot;&gt;QueryStringF&lt;/code&gt;, we specify &lt;code class=&quot;language-text&quot;&gt;Nothing&lt;/code&gt; on the &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; position, so that &lt;code class=&quot;language-text&quot;&gt;QueryStringF&lt;/code&gt; is a subtype of &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;, same for &lt;code class=&quot;language-text&quot;&gt;QueryBoolF&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;We removed the recursion on &lt;code class=&quot;language-text&quot;&gt;QueryPathF&lt;/code&gt;, by abstracting &lt;code class=&quot;language-text&quot;&gt;next: QueryF[A]&lt;/code&gt; into &lt;code class=&quot;language-text&quot;&gt;next: F[A]&lt;/code&gt;, this is why we have to introduce &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; on &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;, so that we can abstract over the original &lt;code class=&quot;language-text&quot;&gt;Query[A]&lt;/code&gt; which is a HKT.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Now let’s see how to form a query using the new ADT.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// compiles with `-Ypartial-unification` compiler flag&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; expression &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryStringF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see, it’s similar to our previous example, which is a hint that our new generic representation is as powerful as the previous, more concrete representation in terms of expressivity.&lt;/p&gt;
&lt;h3&gt;Step 2: Construct recursive data structure using Fix Point Type&lt;/h3&gt;
&lt;p&gt;Let’s revise what Fix Point Type is, &lt;code class=&quot;language-text&quot;&gt;fix&lt;/code&gt; is a structure that conforms to the following rule:&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fix(f) = f(fix(f)) for all f&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The rule above is abstract, in the sense that it can apply to different domain, for example when &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt; is function, then &lt;code class=&quot;language-text&quot;&gt;fix&lt;/code&gt; is commonly known as &lt;code class=&quot;language-text&quot;&gt;Y-combinator&lt;/code&gt; which describes recursive function, when &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt; is a type then we get &lt;code class=&quot;language-text&quot;&gt;Fix Point Type&lt;/code&gt; which describe recursive type.&lt;/p&gt;
&lt;p&gt;Below is a straight forward way to define &lt;code class=&quot;language-text&quot;&gt;Fix point type&lt;/code&gt; in Scala:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Fix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;unfix&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Fix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It follows the rule above in that every &lt;code class=&quot;language-text&quot;&gt;Fix[F]&lt;/code&gt; is equivalent to &lt;code class=&quot;language-text&quot;&gt;F[Fix[F]]&lt;/code&gt; for all F.&lt;/p&gt;
&lt;p&gt;Unfortunately, we cannot use this definition of &lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; to construct a recursive version of &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// does not compile&lt;/span&gt;
Fix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;key&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Fix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryStringF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Because the type signature does not match, &lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; constructor takes a type param with &lt;code class=&quot;language-text&quot;&gt;* -&amp;gt; *&lt;/code&gt; kind (commonly pronounce as Star to Star), encoded as &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; in Scala, but &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt; has kind of &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; * -&amp;gt; *&lt;/code&gt;, as it takes a &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; and returns a proper type (ie. a Star type)&lt;/p&gt;
&lt;p&gt;The solution for this problem is to create a new &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt; type that matches the type signature of &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;unfix&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This looks a bit scary, let’s try to break it down.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the 1st type param &lt;code class=&quot;language-text&quot;&gt;F[_[_], _]&lt;/code&gt; is a type constructor that takes 2 type params, a HKT &lt;code class=&quot;language-text&quot;&gt;* -&amp;gt; *&lt;/code&gt; and a proper type &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;2nd type param is just a proper type, bind to symbol &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;unfix&lt;/code&gt; becomes &lt;code class=&quot;language-text&quot;&gt;F[HFix[F, ?], A]&lt;/code&gt;, remember &lt;code class=&quot;language-text&quot;&gt;F&lt;/code&gt; takes a &lt;code class=&quot;language-text&quot;&gt;* -&amp;gt; *&lt;/code&gt; on 1st type param, which is the kind of &lt;code class=&quot;language-text&quot;&gt;HFix[F, ?]&lt;/code&gt;, the 2nd type param would then be &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; so that we propagate it across layers of recursion&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I think it’s worth to emphasize 2 points&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;It allows us to relate an extra type param between layers, ie. both &lt;code class=&quot;language-text&quot;&gt;HFix[F[_[_], _], A]&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;F[HFix[F, ?], A]&lt;/code&gt; contains type &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;It abstracts over a type with this shape &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; * -&amp;gt; *&lt;/code&gt;, encoded as &lt;code class=&quot;language-text&quot;&gt;F[_[_], _]&lt;/code&gt;, which match our &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt; type&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Sample usage of &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; queryString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryStringF&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Query&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; queryBool &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryBoolF&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; queryPath&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    queryString
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

res32&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryStringF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Cool, so we can create a recursive structure that expresses querying a string at path &lt;code class=&quot;language-text&quot;&gt;oh.my&lt;/code&gt;, note the type of this structure is &lt;code class=&quot;language-text&quot;&gt;HFix[QueryF, String]&lt;/code&gt;, which is great because we retain the knowledge that it results in a &lt;code class=&quot;language-text&quot;&gt;String&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;Step 3: Define Functor instance for GADT&lt;/h3&gt;
&lt;p&gt;Defining a Functor instance is essential, it describes how to transform recursive data structure. Unfortunately, due to the usage of GADT, a standard Functor wouldn’t work, it’s similar to the issue with standard Fix Point type.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; Functor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above is the interface of Functor, we can define &lt;code class=&quot;language-text&quot;&gt;Functor&lt;/code&gt; for any type with kind &lt;code class=&quot;language-text&quot;&gt;* -&amp;gt; *&lt;/code&gt;, but Query has a type of &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; * -&amp;gt; *&lt;/code&gt; as we’ve seen earlier.&lt;/p&gt;
&lt;p&gt;The solution is similar to how to solve the issue with Fix; we need to define another Functor like structure that fit our type.&lt;/p&gt;
&lt;p&gt;When using ordinary ADT, we want a Functor instance so that we can transform the type param of our ADT, eg. &lt;code class=&quot;language-text&quot;&gt;F[A] =&amp;gt; F[B]&lt;/code&gt;, but now we have &lt;code class=&quot;language-text&quot;&gt;QueryF[F[_], A]&lt;/code&gt;, which contains 2 type params, what should we transform?&lt;/p&gt;
&lt;p&gt;The most generic way would be to transform both type params but to simplify the problem, we are only transforming the 1st type param, e.g., &lt;code class=&quot;language-text&quot;&gt;QueryF[F[_], A] =&amp;gt; QueryF[G[_], A]&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; $ivy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;`org&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;typelevel&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;cats&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;core&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1.6&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;`

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;~&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; hmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; I &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This typeclass describes the ability transform the 1st type param of an arbitrary type F, where F has kind of &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; * -&amp;gt; *&lt;/code&gt;, which is what we need.&lt;/p&gt;
&lt;p&gt;Next, we need to implement an instance of &lt;code class=&quot;language-text&quot;&gt;HFunctor&lt;/code&gt; for &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; queryHFunctor&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; hmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; I &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          a &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryStringF            &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; QueryStringF
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryBoolF              &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; QueryBoolF
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; query&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nt&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The implementation is relatively straight-forward, basically we try to handle every case of GADT and change the &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; type param, for bottom type (ie. when F is Nothing), we dont have to change anything because we define F as covariant.&lt;/p&gt;
&lt;h3&gt;Step 4: Implement catamorphism&lt;/h3&gt;
&lt;p&gt;Finally, after all the ceremony, we are in the position to define &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;On a high-level view, &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt; is an operation that collapses a recursive structure into a single value by collapsing each layer of the data structure recursively.&lt;/p&gt;
&lt;p&gt;It is generic in that user can define how to collapse each layer.&lt;/p&gt;
&lt;p&gt;It looks like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;G&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; G

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; hCata&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; I&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;alg&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;hfix&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; I&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; F&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; inner &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hfix&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unfix
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; nt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hmap&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hCata&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;alg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fa&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;inner&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  alg&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The flow of &lt;code class=&quot;language-text&quot;&gt;hCata&lt;/code&gt; is similar to normal &lt;code class=&quot;language-text&quot;&gt;cata&lt;/code&gt; method, by trying to peel off the outer layer of &lt;code class=&quot;language-text&quot;&gt;HFix[F, I]&lt;/code&gt;, we recursively dive into the inner-most layer of the recursive structure, then we apply &lt;code class=&quot;language-text&quot;&gt;HAlgebra&lt;/code&gt; while traversing back to the top layer.&lt;/p&gt;
&lt;p&gt;Note: You can try to implement anamorphism and other operations :D&lt;/p&gt;
&lt;p&gt;We defined everything we need, let’s try to use it.&lt;/p&gt;
&lt;p&gt;We’ll go through 2 examples, using the query we created earlier.&lt;/p&gt;
&lt;p&gt;a) Print recursive query in a human-readable format&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; nestedQuery &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                    &lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                      &lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                      queryString
                    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// a trick to fold into String, this is interesting as it shows that&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// generalized type constructor is super powerful; it can represent a&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// more specialized type easily&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// important part: convert each layer of query into a string&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; print&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;JustString&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    fa &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryStringF                 &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;as[String]&quot;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryBoolF                   &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;as[Bool]&quot;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;JustString&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; s&lt;span class=&quot;token string&quot;&gt;&quot;${q.path}.${q.next}&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

hCata&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;print&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nestedQuery&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// res44: JustString[String] = &quot;oh.my.as[String]&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;b) Convert our query description a circe Decoder&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; $ivy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;`io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;circe&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;circe&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;parser&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.10&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;`

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;circe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Decoder

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; toDecoder&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Decoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fa &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryBoolF   &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decodeBoolean
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryStringF &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decodeString
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Decoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
      Decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;instance &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; cursor &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        cursor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hCata&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toDecoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nestedQuery&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; parse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
    {
      &quot;oh&quot;: {
        &quot;my&quot;: &quot;20202&quot;
      }
    }
&quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;right&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get

decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Right(&quot;20202&quot;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I tried to use simpler examples, for more complicated examples, check these projects:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/nuttycom/xenomorph/blob/master/modules/argonaut/src/main/scala/xenomorph/argonaut/FromJson.scala#L51&quot;&gt;Xenomorph&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/qingwei91/basil/blob/master/core/src/main/scala/basil/parser/JsonParse.scala#L447&quot;&gt;Basil&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Conclusion:&lt;/h2&gt;
&lt;p&gt;We’ve walked through how to apply recursion schemes on a GADT. The basic idea is similar to applying recursion schemes on ordinary ADT; the main difference is that we need to operate on higher order types, eg.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Functor&lt;/code&gt; that takes a function (&lt;code class=&quot;language-text&quot;&gt;* -&amp;gt; *&lt;/code&gt;) becomes HFunctor that takes natural transformation &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; (* -&amp;gt; *)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; with shape &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; *&lt;/code&gt; becomes &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt; with shape &lt;code class=&quot;language-text&quot;&gt;((* -&amp;gt; *) -&amp;gt; (* -&amp;gt; *)) -&amp;gt; (* -&amp;gt; *)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Algebra&lt;/code&gt; with &lt;code class=&quot;language-text&quot;&gt;(* -&amp;gt; *) -&amp;gt; * -&amp;gt; *&lt;/code&gt; becomes HAlgebra &lt;code class=&quot;language-text&quot;&gt;((* -&amp;gt; *) -&amp;gt; (* -&amp;gt; *)) -&amp;gt; (* -&amp;gt; *) -&amp;gt; (* -&amp;gt; *)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Notice there’s a common theme, the number of stars doubled in the process, I haven’t fully understood why but I hope this article is still useful.&lt;/p&gt;
&lt;h2&gt;Credit&lt;/h2&gt;
&lt;p&gt;I learn most of the techniques described here from &lt;a href=&quot;https://github.com/nuttycom/xenomorph&quot;&gt;Xenomorph&lt;/a&gt; by Nuttycom, I find it interesting and thought would be good to write it down.&lt;/p&gt;
&lt;p&gt;Thanks Nuttycomb for sharing his idea with the open source world! I also wish to thanks my coworker &lt;a href=&quot;https://github.com/Baccata/&quot;&gt;Olivier&lt;/a&gt; for introducing the idea of recursion scheme to me, and Alex for correcting me on notation of higher kinded type.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[My reflection for 2018]]></title><description><![CDATA[2018 Reflection What went well? More responsibility at work Getting more responsibility is stressful and fun at the same time, luckily my…]]></description><link>https://qingwei91.github.io/2018-reflection/</link><guid isPermaLink="false">https://qingwei91.github.io/2018-reflection/</guid><pubDate>Tue, 25 Dec 2018 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;2018 Reflection&lt;/h1&gt;
&lt;h2&gt;What went well?&lt;/h2&gt;
&lt;h3&gt;More responsibility at work&lt;/h3&gt;
&lt;p&gt;Getting more responsibility is stressful and fun at the same time, luckily my team leads and project manager are good at helping me.&lt;/p&gt;
&lt;p&gt;One of the main changes when leading is that my decision starts to impact a larger part of the project, for better or worse. This means that I need to be more cautious when making decision, and strike a better balance between ensuring safety and making progress.&lt;/p&gt;
&lt;h3&gt;I learned a lot more about functional programming&lt;/h3&gt;
&lt;p&gt;I am thankful to be in the same team with Olivier, which he taught us a lot about functional programming. In addition, our team leads have been open with advanced technique which allow us to learn things on our job.&lt;/p&gt;
&lt;h4&gt;Recursion Schemes&lt;/h4&gt;
&lt;p&gt;I’ve learn some basic of recursion schemes, and manage to apply it in an open source project &lt;a href=&quot;https://github.com/qingwei91/basil&quot;&gt;basil&lt;/a&gt;&lt;/p&gt;
&lt;h4&gt;Tagless Final&lt;/h4&gt;
&lt;p&gt;I am starting to appreciate interpreter pattern more. By separating definition and execution, one can gain a lot of power without paying huge refactoring cost.&lt;/p&gt;
&lt;p&gt;Example: Execute a program with &lt;code class=&quot;language-text&quot;&gt;debounce&lt;/code&gt; Effect to prevent rate limit exception from a remote API&lt;/p&gt;
&lt;h3&gt;Wrote an interesting library: &lt;a href=&quot;https://github.com/qingwei91/basil&quot;&gt;basil&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;I wrote this library out of curiosity, and learn a lot in the process, I’ve learn about &lt;code class=&quot;language-text&quot;&gt;higher kinded fix&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;FreeApplicative&lt;/code&gt; and a lot more.&lt;/p&gt;
&lt;p&gt;It’s cool to (re)discover that I am most motivated when exploring new stuff, even if it’s not useful.&lt;/p&gt;
&lt;h3&gt;Reboot my own blog: &lt;a href=&quot;https://qingwei91.github.io&quot;&gt;https://qingwei91.github.io&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;While my company blog undergone some changes which makes it harder to submit a blogpost, I decided to start my own blog again.&lt;/p&gt;
&lt;p&gt;I didn’t write as many blog as I wanted, let’s hope I will do it more in the coming year.&lt;/p&gt;
&lt;h3&gt;Formed a habit to gym&lt;/h3&gt;
&lt;p&gt;I am very happy that I am going to gym more often, it’s started to form a habit. This &lt;a href=&quot;https://www.youtube.com/user/JDCav24/featured&quot;&gt;youtube channel&lt;/a&gt; is one of my favorite channel about working out, thanks Jeff !&lt;/p&gt;
&lt;h3&gt;Enhanced my culinary skills&lt;/h3&gt;
&lt;p&gt;I enjoy cooking and have been trying out different recipes, hurray !&lt;/p&gt;
&lt;h2&gt;What went wrong?&lt;/h2&gt;
&lt;h3&gt;Investment went deep down, I mean deep down&lt;/h3&gt;
&lt;p&gt;I made a couple of big mistakes:&lt;/p&gt;
&lt;p&gt;a) Invest (speculate ?) without knowing how to make valuation
b) Not knowing to cut-loss and take profit
c) Putting all pressure on my wife which is an amateur&lt;/p&gt;
&lt;p&gt;these combined with uncertainty brought by trade war, and slow down of global economy means a bad year for our investment&lt;/p&gt;
&lt;h3&gt;Mistakes in work due to carelessness&lt;/h3&gt;
&lt;p&gt;I realized I get carried away rather easily, there’s a part of me that behaves like an enthusiastic dog that is eager to do whatever I am tasked to do :D&lt;/p&gt;
&lt;p&gt;While being enthusiastic is not a bad thing, it certainly isn’t an excuse for recklessness, I need to be more mindful when making decision or taking actions.&lt;/p&gt;
&lt;h3&gt;Fail to develop an arbitrage software I planned earlier of the year&lt;/h3&gt;
&lt;p&gt;I wanted to build an arbitrage engine but didn’t finish it, couple of reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the project turns out to be quite difficult and messy due to external api changes&lt;/li&gt;
&lt;li&gt;I didn’t have a clear plan when developing&lt;/li&gt;
&lt;li&gt;It’s not as fun as I originally envision&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I need to work on my energy management and be more focus on my goal, it’s ok to give up but there has to be a good reason&lt;/p&gt;
&lt;h2&gt;Action Points&lt;/h2&gt;
&lt;h3&gt;Improve my investment skills&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Develop a methodology to evaluate a stock&lt;/li&gt;
&lt;li&gt;Develop a strategy to take profit and cut loss&lt;/li&gt;
&lt;li&gt;Iterate the strategy by learning from historical actions&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Be more careful and cautious&lt;/h3&gt;
&lt;p&gt;I think it’s hard to suddenly become a careful person, I can however starts with some actionable things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Double check a decision with experts&lt;/li&gt;
&lt;li&gt;Think thrice when pulling a dependency, a dependency is a backdoor waiting to happen&lt;/li&gt;
&lt;li&gt;Act slower when you’re dealing with something new that you aren’t familiar&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Scalameta tutorial: Cache decorator]]></title><description><![CDATA[This is a tutorial to show how to use Scalameta to develop a generic, parameterized annotation.
To know how to setup a project to use…]]></description><link>https://qingwei91.github.io/scalameta-tut/</link><guid isPermaLink="false">https://qingwei91.github.io/scalameta-tut/</guid><pubDate>Sat, 06 May 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;This is a tutorial to show how to use Scalameta to develop a &lt;strong&gt;generic, parameterized annotation&lt;/strong&gt;.
To know how to setup a project to use &lt;code class=&quot;language-text&quot;&gt;scalameta&lt;/code&gt;, refer to &lt;a href=&quot;http://scalameta.org/tutorial/#Setup&quot;&gt;official docs&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;What is scalameta?&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://scalameta.org/&quot;&gt;Scala-meta&lt;/a&gt; is the de-facto toolkit for metaprogramming in Scala. For those who are new to metaprogramming, it means programming against code/syntax/&lt;a href=&quot;https://en.wikipedia.org/wiki/Abstract_syntax_tree&quot;&gt;AST&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Metaprogramming is very useful when you notice a repeating pattern in your code, but you are not able to refactor it due to limitations of the programming language.&lt;/p&gt;
&lt;p&gt;Conceptually, scalameta allows you to access your code as data (Abstract Syntax Tree), and manipulate it at compile time.&lt;/p&gt;
&lt;h2&gt;Problem: Caching&lt;/h2&gt;
&lt;p&gt;Caching is a common technique that almost all programmers are familiar with. In this tutorial, we will develop a &lt;code class=&quot;language-text&quot;&gt;cache&lt;/code&gt; macro that&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;has low syntatic overhead, ie. it should not change the cached function much&lt;/li&gt;
&lt;li&gt;able to support different cache storage, eg. In memory cache, elastic search etc&lt;/li&gt;
&lt;li&gt;able to cache methods with multiple arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Naive implementation&lt;/h2&gt;
&lt;p&gt;Let’s start with a simple implementation without using macro&lt;/p&gt;
&lt;p&gt;Code to support cache function&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; CacheBackEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; mutable&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Map&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// ignore the fact it is not thread safe&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// `compute` is a function, only evaluated in case of cache miss&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; getOrElse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; compute&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; V &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; v       &lt;span class=&quot;token comment&quot;&gt;// cache hit&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; compute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        v
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheStorage&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CacheBackEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; V &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
    cacheStorage&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getOrElse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Calling cache function&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// this is slow .....&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; n &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cacheBackend &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; CacheBackEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cachedFib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fib&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheBackend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// alternatively, we can inline the logic&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cachedFib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cache &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; n &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheBackend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Analysis&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it’s simple and easy to understand&lt;/li&gt;
&lt;li&gt;it supports different cache storage&lt;/li&gt;
&lt;li&gt;able to work on methods of different arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It is a bit intrusive, notice the implementation of &lt;code class=&quot;language-text&quot;&gt;cachedFib&lt;/code&gt; needs to be changed&lt;/li&gt;
&lt;li&gt;It is awkward to work with functions with multiple arguments, because our CacheBackend can only takes in &lt;code class=&quot;language-text&quot;&gt;K, V&lt;/code&gt; as type param, so if you have a function with signature &lt;code class=&quot;language-text&quot;&gt;def fn(x: Int, y: Int): Int&lt;/code&gt; , you need to combine &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; into &lt;code class=&quot;language-text&quot;&gt;(Int, Int)&lt;/code&gt; so that it fit into CacheBackend’s type signature&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s see how we can improve it using scala meta.&lt;/p&gt;
&lt;h2&gt;Scalameta Implementation 1&lt;/h2&gt;
&lt;p&gt;Here, we are going to implement cache function as a macro, the end goal is to support syntax like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// the signature is slightly different, as our macro need to access `get` and `put` method, but not `getOrElse`&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// you can implement both signature though&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; SyncCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Option&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; put&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cacheBackend &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; SyncCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token annotation punctuation&quot;&gt;@cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheBackend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; n &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Before we jump into implementation, we can observe a few difference with previous implementation&lt;/p&gt;
&lt;h3&gt;Observations&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;The syntax is cleaner, it does not change the method’s definition at all&lt;/li&gt;
&lt;li&gt;It also supports different cache storage&lt;/li&gt;
&lt;li&gt;Too much MAGIC, how does it even work?&lt;/li&gt;
&lt;li&gt;Does it support function with multiple arguments?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s answer the 1st question, how does it works?&lt;/p&gt;
&lt;p&gt;Below is the implementation of the &lt;code class=&quot;language-text&quot;&gt;cache&lt;/code&gt; macro, let’s go through the comments to understand what it does&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// @param backend - parameter for `cache` annotation&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;backend&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; SyncCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; scala&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;annotation&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;StaticAnnotation &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// @param defn - the annotated method (it can also be other scala building block like class, but we are restricting here&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;//               using some checks below&lt;/span&gt;
  inline &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;defn&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Any&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; meta &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    defn &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// this annotation should only be annotate on `method`, represented as `Defn.Def` in scalameta&apos;s AST&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; defn&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Defn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Def &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// this represent the instatiated annotation, ie. `@cache(xxx)`&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

          &lt;span class=&quot;token comment&quot;&gt;// Quasiquote in action, it&apos;s a way to pattern match scala AST&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `new`               match instantiation&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `$_`                match the name of the annotation&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `[..$tpr]`          match type params and bind to `tpr`&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `($backendParam)`   match SINGLE argument used in instatiation and bind to `backendParam`&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//                        Note: To match multiple arguments or multiple arguments list (curried), you need different                                           syntax&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token string&quot;&gt;&quot;new $_[..$tpr]($backendParam)&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;

            &lt;span class=&quot;token comment&quot;&gt;// we use the element we captured to generate code we want, we will look into details next&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; body&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Term &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; CacheMacroImpl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expand&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tpr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; backendParam&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; defn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

            &lt;span class=&quot;token comment&quot;&gt;// we only want to replace the method body, so this will do&lt;/span&gt;
            defn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;copy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;body &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; x &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
            abort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token string&quot;&gt;&quot;Unrecognized pattern $x&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; _ &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        abort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;This annotation only works on `def`&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// abort if annotated to anything other than methods&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So here is quite some amount of info, especially around quasiquote. You might have a few questions, like what is the type signature of &lt;code class=&quot;language-text&quot;&gt;tpr&lt;/code&gt; that we’ve captured? I will go through them in next section, but here I wish you get familiar with the general flow, basically we are trying to&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;use pattern matching to capture relevant information from the AST [Compile Time]&lt;/li&gt;
&lt;li&gt;perform transformation on the AST [Compile Time]&lt;/li&gt;
&lt;li&gt;transformed AST will then get compiled into artifact that is invoked at runtime&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;if you’re interested to know more about quasiquote, &lt;a href=&quot;https://github.com/scalameta/scalameta/blob/master/notes/quasiquotes.md&quot;&gt;here&lt;/a&gt; is the reference for all quasiquote syntax&lt;/p&gt;
&lt;p&gt;Now let’s inspect the implementation of AST transformation logic, ie. &lt;code class=&quot;language-text&quot;&gt;CacheMacroImpl.expand(tpr, backendParam, defn)&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; CacheMacroImpl &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;/**
    *
    * @param fnTypeParams - Type params of annotation instance, remember our cache macro is generic `class cache[K, V]`,
                            this will capture Seq(K, V)
    * @param cacheExpr    - Argument pass to `cache` macro, should be type of `CacheBackEnd[K, V]`
    * @param annotatedDef - Methods that is annotated
    */&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; expand&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fnTypeParams&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Seq&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Type&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cacheExpr&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Arg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; annotatedDef&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Defn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Def&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Term &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheExpr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;syntax&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// convert Term.Arg to Term.Name&lt;/span&gt;

    annotatedDef &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// Another Quasiquote pattern match&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `..$_`                   match any modifier&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `def`                    match only method&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `$methodName`            bind method name to $methodName&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `[..$tps]`               match some type params of method and bind to $tps&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `(..$nonCurriedParams)`  match non-curried argument list and binf to $nonCurriedParams&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `$rtType`                bind return type to $rtType&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `$expr`                  bind method&apos;s body to $expr&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token string&quot;&gt;&quot;..$_ def $methodName[..$tps](..$nonCurriedParams): $rtType = $expr&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// here is the trick to handle different arg size&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nonCurriedParams&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

          &lt;span class=&quot;token comment&quot;&gt;// if only 1 arg, use the arg as key of cache&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; paramAsArg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nonCurriedParams&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;head&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          q&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;
            // here we are generating code that call the CacheBackend
            val result: ${rtType} = $cache.get($paramAsArg) match {
              case Some(v) =&gt; v
              case None =&gt;
                val value = ${expr}
                $cache.put($paramAsArg, value)
                value
            }
            result
           &quot;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; paramAsArg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; nonCurriedParams&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          q&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&quot;

            // if there are multiple arg, convert them in tuple, as use the tuple as key
            val result: ${rtType} = $cache.get((..$paramAsArg)) match {
              case Some(v) =&gt; v
              case None =&gt;
                val value = ${expr}
                $cache.put((..$paramAsArg), value)
                value
            }
            result
           &quot;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; other &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; abort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token string&quot;&gt;&quot;Expected non-curried method, got $other&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I hope the implementation is not too intimidating, it does the following&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Check if the annotation methods is allowed or not (curried method is not allowed)&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Check the number of arguments&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If 1, use it as is&lt;/li&gt;
&lt;li&gt;If multiple, convert them into a tuple, and use the tuple as key of cache&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Try to get data from cache using &lt;code class=&quot;language-text&quot;&gt;cache.get(key)&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If cache hit, return the cached value&lt;/li&gt;
&lt;li&gt;If cache miss, evaluate the original annotated method, cache the result using &lt;code class=&quot;language-text&quot;&gt;cache.put(k, v)&lt;/code&gt;, and return the result&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Analysis&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it supports different cache storage, eg. you could implement a Cache Backend that support TTL&lt;/li&gt;
&lt;li&gt;it has almost zero syntatic overhead on caller&lt;/li&gt;
&lt;li&gt;able to work on methods of different arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It is more complicated to implement&lt;/li&gt;
&lt;li&gt;The implementation is harder to debug&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Here we end this tutorial, as we shown how could you create a generic, parameterize macro using scalameta.
The code is availble &lt;a href=&quot;https://github.com/buaya91/scala-cache&quot;&gt;here&lt;/a&gt;
As an exercise for readers, you can try to improve the cache so that it support async get and put.&lt;/p&gt;
&lt;p&gt;Note: I am not claiming &lt;code class=&quot;language-text&quot;&gt;cache&lt;/code&gt; annotation is a good use-case of macro, ultimately it depends on your team and problem on hand. Nonetheless, I believe everyone should learn a bit of it to enhance your skills, and also to have better understanding on how compiler view your code.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[How multiplayer game sync their state? (Part 2)]]></title><description><![CDATA[Recap In part 1 of the series, we discussed the following: Challenges faced in multiplayer game How to solve unresponsive UI by client…]]></description><link>https://qingwei91.github.io/multiplayer-game2/</link><guid isPermaLink="false">https://qingwei91.github.io/multiplayer-game2/</guid><pubDate>Mon, 01 May 2017 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Recap&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;In &lt;a href=&quot;./multiplayer-game1&quot;&gt;part 1 of the series&lt;/a&gt;, we discussed the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Challenges faced in multiplayer game&lt;/li&gt;
&lt;li&gt;How to solve unresponsive UI by client predictions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I did however gloss over essential server implementation details, which
we will focus on in this article.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Disclaimer: I am not a professional game developer, most of
the knowledge shared is based on what I read and my experience of
small hobby projects. The main goal of this article is to provide
an easy to understand introduction for networking in a multiplayer 
game.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;What’s the role of server?&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Let’s start by defining what a server should do, typically a server should serve as&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;a) Connection point for players&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;In a multiplayer game, players need to access a common endpoint
to reach each other, this is one of the roles of a server
program, even in the P2P communication model, there will be a
connection point for players to exchange their network
information before a P2P connection can be established.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;b) Processing unit&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;In many cases, the server runs the game simulation code, process all
inputs from player and updates the game state. Note that this is not
always the case, some modern games offload lots of processing to the
client side. In this article we will assume it&amp;#39;s the server&amp;#39;s
responsibility to process the game, ie. Make the game tick.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;c) Single source of truth on game state&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;In many multiplayer games, the server program also has authority on 
game state, the main reason is to prevent cheating, and it&amp;#39;s also
easier to reason about when there&amp;#39;s is a single point to get the
correct game state.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Naive Server Implementation&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Let’s start to implement the server in the most straightforward fashion,
then improve from there.&lt;/p&gt;
&lt;p&gt;The core of the game server is a loop that keeps updating the GameState
using a player’s input, commonly know as a TICK, the function signature
is as follows:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff6600;&quot;&gt;(STATE&lt;sub&gt;n&lt;/sub&gt; , INPUT&lt;sub&gt;n&lt;/sub&gt;) =&gt; STATE&lt;sub&gt;n+1&lt;/sub&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;A simplified server code snippet would looks like this&lt;/p&gt;
&lt;h3&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Discussion&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;I hope the code snippets look intuitive and straightforward, the server simply take all inputs from the buffer and applies them in the next &lt;code class=&quot;language-text&quot;&gt;TICK&lt;/code&gt; function to get new GameState. Let’s call this approach &lt;code class=&quot;language-text&quot;&gt;Greedy Game Loop&lt;/code&gt;, as it tries to process things as fast as it could. It is all good, until we think about our lovely universe where sunlight takes 8 minutes to  reach the earth. &lt;/p&gt;
&lt;p&gt;Latency strikes again!&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn2.hubspot.net/hubfs/323094/qingwei/speed_of_light_meme.jpg&quot; title=&quot;speed_of_light_meme.jpg&quot;&gt;&lt;/p&gt;
&lt;p&gt;The fact that the server processes all input from buffer in every &lt;code class=&quot;language-text&quot;&gt;TICK&lt;/code&gt;,
means the GameState will depends on network latency. Diagram
below illustrates why this is a problem&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-side-latency-issue-single.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;The image shows 2 clients sending inputs to server, we observe 2
interesting facts.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Requests took different time from different client to server, 
&lt;strong&gt;1&lt;/strong&gt; unit of time from &lt;span style=&quot;background-color: #fab9d9;&quot;&gt;Client A&lt;/span&gt; to &lt;span style=&quot;background-color: #ccffcc;&quot;&gt;Server&lt;/span&gt;,  &lt;strong&gt;1.5&lt;/strong&gt; unit of time from &lt;span style=&quot;background-color: #ccffff;&quot;&gt;Client B&lt;/span&gt; to &lt;span style=&quot;background-color: #ccffcc;&quot;&gt;Server&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Requests took different time from same client to server,
1st request took &lt;strong&gt;1&lt;/strong&gt; unit of time, 2nd request took &lt;strong&gt;2&lt;/strong&gt; unit of time.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In short, latency is inconsistent, even on the same connection.&lt;/p&gt;
&lt;p&gt;Inconsistent latency combined with &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Greedy Game Loop&lt;/code&gt;&lt;/strong&gt; gives several problems, let look at these further.&lt;/p&gt;
&lt;table style=&quot;border-color: #000000; background-color: #ffffff;&quot; border=&quot;3&quot; cellpadding=&quot;5&quot;&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;h4 style=&quot;padding-left: 30px;&quot;&gt;Client Side Prediction will&amp;nbsp;not work&lt;/h4&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;p style=&quot;text-align: left;&quot;&gt;
                    &lt;span style=&quot;font-size: 13px;&quot;&gt;
                    If&amp;nbsp;we cannot predict when the&amp;nbsp;server would
                    receive input (due to latency), we can&apos;t make any
                    predictions with high accuracy. (Forgot how Client
                    Side Prediction works? read&amp;nbsp;
                    &lt;a href=&quot;http://www.cakesolutions.net/teamblogs/how-does-multiplayer-game-sync-their-state-part-1#client-side-prediction&quot;&gt;here&lt;/a&gt;)
                    &lt;/span&gt;
                &lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;h4 style=&quot;padding-left: 30px;&quot;&gt;Low latency players&amp;nbsp;get advantages&lt;/h4&gt;
            &lt;/td&gt;
            &lt;td style=&quot;width: 642px;&quot;&gt;
                &lt;span style=&quot;font-size: 13px;&quot;&gt;
                If input takes a shorter time to reach server, it will
                be processed sooner, creating unfair advantage for
                players with fast networks. eg. Two players
                shoot&amp;nbsp;each other at the same time,
                they are supposed to kill each other at the same time,
                but Player B has a lower latency thus killed Player A
                before Player A&apos;s&amp;nbsp;command is processed.
                &lt;/span&gt;
            &lt;/td&gt;
         &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;There is a simple solution to mitigate inconsistent latency,
&lt;a href=&quot;./multiplayer-game1#lockstep&quot;&gt;Lockstep State Update&lt;/a&gt; that we discussed in the previous article. The idea is that server does not proceed until it received input from all players, it has 2 benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it does not require client side prediction&lt;/li&gt;
&lt;li&gt;all players will appear to have the same latency as the slowest
player, removing the advantage we mentioned&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;However, it does not work for fast-paced action games as the
responsiveness is low. (More details can be found on previous article,
thus I will not repeat here.)&lt;/p&gt;
&lt;p&gt;Next section, we will talk about how to make the server side work for
fast paced games.&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Server Reconcilation&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;To solve the problem of inaccurate client side predictions, 
we need to make the client-server interaction more predictable 
from the client point of view. When a Player presses a key on client
side, the client program needs to know when this input would being
processed on server side.&lt;/p&gt;
&lt;p&gt;One possible way is to &lt;strong&gt;let the client suggest when the input should
be applied&lt;/strong&gt;, this way, client side would be able to predict it
reliably. The term &lt;code class=&quot;language-text&quot;&gt;suggest&lt;/code&gt; is used as server might reject the
suggestion if it’s invalid, for example trying to cast a magic when 
your magic power is empty.&lt;/p&gt;
&lt;p&gt;The input should be applied shortly after user input, ie.
&lt;span style=&quot;color: #993366;&quot;&gt;&lt;strong&gt;T&lt;sub&gt;input&lt;/sub&gt; + X&lt;/strong&gt;&lt;/span&gt;,
where X is the delay. The exact value depends on game, normally less
than 100ms to be responsive. Note X can also be zero, in this case
it should happen immediately after user provides input.&lt;/p&gt;
&lt;p&gt;Let’s say we choose X = 30ms, which translates into roughly 1 frame
for 30fps (frame per second), and it takes 150ms for input to travel
to server, there’s a good chance when input reaches the server,
the target frame for input had passed.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-side-independent-latency.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;Looking at the diagram, User A pressed a key at &lt;strong&gt;T&lt;/strong&gt;, which supposed
to be processed at &lt;strong&gt;T + 30ms&lt;/strong&gt;, but the input is received by server
at &lt;strong&gt;T + 150ms&lt;/strong&gt;, due to latency, which already passed &lt;strong&gt;T + 30ms&lt;/strong&gt;.
This is the problem we are going to solve in this section&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;How does server apply input that should happen in the past?&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;The Concept&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;You might have recalled client side prediction has a similar issue of
incorrect predictions due to lacking information of opponents, and
the incorrect predictions will later be corrected by state updates
from server using &lt;strong&gt;&lt;a href=&quot;./multiplayer-game1#reconcilation&quot;&gt;Reconcilation&lt;/a&gt;&lt;/strong&gt;.
The same technique can be used here, the only difference is that
we are correcting the GameState on server using user input from clients.&lt;/p&gt;
&lt;p&gt;All user input needs to be tagged with a timestamp, this timestamp will then be used to tell the server when to process this input.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-side-reconcilation1.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;sub&gt;Note: On the first dotted line, it’s &lt;span style=&quot;color: #000000;&quot;&gt;&lt;strong&gt;Time X&lt;/strong&gt;&lt;/span&gt; on Client side, but &lt;span style=&quot;color: #000000;&quot;&gt;&lt;strong&gt;Time Y&lt;/strong&gt;&lt;/span&gt; on Server side, this is an interesting nature of multiplayer game (and many other distributed system), as client and server &lt;g class=&quot;gr_ gr_201 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace&quot; id=&quot;201&quot; data-gr-id=&quot;201&quot;&gt;runs&lt;/g&gt; independently, the time of client and server typically will be different,  our algorithm will handle the difference.&lt;/sub&gt;&lt;/p&gt;
&lt;p&gt;Diagram above shows interaction between 1 Client and the Server,&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Client sends an Input with timestamp telling server this input of
Client A should happen on &lt;span style=&quot;color: #ff0000;&quot;&gt;Time X&lt;/span&gt;. &lt;/li&gt;
&lt;li&gt;Server received the request on &lt;span style=&quot;color: #008000;&quot;&gt;Time Y&lt;/span&gt;,
let’s assume Time X is older than Time Y for the sake of discussion.
When developing our algorithm, we should not
assume &lt;span style=&quot;color: #008000;&quot;&gt;Time Y&lt;/span&gt; is bigger or less
than &lt;span style=&quot;color: #ff0000;&quot;&gt;Time X&lt;span style=&quot;color: #000000;&quot;&gt;,
this will give us more flexibility.&lt;/span&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
The &lt;span style=&quot;color: #ff0000;&quot;&gt;&lt;strong&gt;RED BOX&lt;/strong&gt;&lt;/span&gt; is where
reconcilation happens, the server needs to apply the Input X to the
latest game state so that it appears that input X happens
on &lt;span style=&quot;color: #ff0000;&quot;&gt;Time X&lt;/span&gt;.&lt;/li&gt;
&lt;li&gt;GameState from server also includes timestamp, which is required 
for both server side and client side reconcilation.&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;Details of Reconcilation (&lt;strong&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;the RED BOX&lt;/span&gt;&lt;/strong&gt;)&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Server needs to maintain&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;span style=&quot;color: #000000;&quot;&gt;GameStateHistory        &lt;/span&gt;&lt;/strong&gt;&lt;span style=&quot;color: #000000;&quot;&gt;- history of GameState within a time frame &lt;strong&gt;P&lt;/strong&gt;, eg. all GameState since a second ago&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ProcessedUserInput&lt;/strong&gt; - history of UserInput processed within a time frame &lt;strong&gt;P&lt;/strong&gt;, ie. same value as time frame of GameStateHistory&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;UnprocessedUserInput&lt;/strong&gt; - UserInput received, but not processed yet, also within time frame &lt;strong&gt;P&lt;/strong&gt;
&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-buffer0.png?raw=true&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When server received an input from user, it should be inserted into the &lt;strong&gt;UnprocessedUserInput&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-buffer1.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Next, when server ticks, &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Check if there is any user input in the &lt;strong&gt;UnprocessedUserInput&lt;/strong&gt; which is older than the current frame&lt;/li&gt;
&lt;li&gt;If not, you are good, simply run the game logic with latest GameState and corresponding Inputs (if any), and broadcast to clients.&lt;/li&gt;
&lt;li&gt;If yes, it means some of the game states generated previously are wrong due to missing information, we need to correct it&lt;/li&gt;
&lt;li&gt;First we need to find the oldest unprocessed user input, let say it is on Time N, (Tips: this operation is fast if the **UnprocessedUserInput **is sorted).&lt;/li&gt;
&lt;li&gt;Then we need to obtain the corresponding GameState on Time N from &lt;strong&gt;GameStateHistory&lt;/strong&gt;, and the processed user input on Time N from &lt;strong&gt;ProcessedUserInput&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Using these 3 pieces of data, we can create a new GameState which is more accurate.
&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-buffer2.png?raw=true&quot;&gt;&lt;/li&gt;
&lt;li&gt;Then move the Unprocessed Input N to ProcessedUserInput, so that we can use it for reconcilation in the future.&lt;/li&gt;
&lt;li&gt;Update the GameState N in &lt;strong&gt;GameStateHistory&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Repeat step 4 to 7, for &lt;code class=&quot;language-text&quot;&gt;N+1, N+2 ...&lt;/code&gt;, until we get latest GameState.&lt;/li&gt;
&lt;li&gt;Server sends out the latest frame to all players. &lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Discussion&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;Server side reconcilation suffers similar problems as client side
reconcilation, when we reconcile, it means we did something wrong,
and we are correcting by changing history. This means we cannot apply
irreversible outcomes, i.e, killing a players, such irreversible
outcomes will only be applied when it goes out of the
&lt;strong&gt;GameStateHistory&lt;/strong&gt;, ie. when it cannot be rewriten anymore.&lt;/p&gt;
&lt;p&gt;In addition, the incorrect GameState sometime causes awful UI jump.
Diagram below illustrate how it happens&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-error0.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;Entity starts at top left corner, it is moving toward
right hand side, 5 ticks later, it shifted towards right, but
then server received the user input saying that the entity changed
direction on Tick N, so the server reconciles the game state, and
now suddenly the entity &lt;strong&gt;jumps&lt;/strong&gt; to the bottom left on the canvas.&lt;/p&gt;
&lt;p&gt;I might be exaggerating the effect, sometimes entity does not move
that much, thus the jump would less obvious, but it is still noticeable
in many cases. We can control the jump by changing the size
of &lt;strong&gt;GameStateHistory&lt;/strong&gt;, &lt;strong&gt;UnprocessedUserInput&lt;/strong&gt; and &lt;strong&gt;ProcessedUserInput&lt;/strong&gt;,
the smaller the buffer size, the less jump there would be, because
we would be less tolerant on input that arrives late, eg. If Input
that is late for more than 100ms is ignored, player with ping &gt; 200ms
wont be able to play the game.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;We can trade &lt;strong&gt;network latency tolerance&lt;/strong&gt; for more &lt;strong&gt;accurate game state update&lt;/strong&gt;,
or vice versa.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;One popular technique to overcome the problem of inaccurate Game State 
is &lt;strong&gt;Entity Interpolation&lt;/strong&gt;, the idea is to smoothen the jump by
spreading it out within a short amount of time.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-error1.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;I will not include implementation details of &lt;strong&gt;Entity Interpolation&lt;/strong&gt;
in this article, however some references will be provided at the bottom of article.&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Wrapping Up&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;We have talked about how both client and server might work in a multiplayer game.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/wrapup.png?raw=true&quot;&gt;In general, a multiplayer game has 3 loosely coupled loops, &lt;strong&gt;Server Game Loop&lt;/strong&gt;, &lt;strong&gt;&lt;g class=&quot;gr_ gr_149 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace&quot; id=&quot;149&quot; data-gr-id=&quot;149&quot;&gt;Client side&lt;/g&gt; prediction Loop&lt;/strong&gt;, and &lt;strong&gt;&lt;g class=&quot;gr_ gr_150 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace&quot; id=&quot;150&quot; data-gr-id=&quot;150&quot;&gt;Client side&lt;/g&gt; UI Rendering Loop&lt;/strong&gt;. By having some sort of buffer in between them, their execution can be decoupled, giving us &lt;g class=&quot;gr_ gr_205 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace&quot; id=&quot;205&quot; data-gr-id=&quot;205&quot;&gt;flexibility&lt;/g&gt; to create better gaming experience.&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Here ends my article on Multiplayer games, I learned much of this
knowledge from experts in this field, building a 
&lt;a href=&quot;https://github.com/buaya91/scalajs-snake&quot;&gt;simple multiplayer game&lt;/a&gt; also helps a lot.
I’ve only show one way to implement a multiplayer server,
there are more other ways, depending on what kind of game you’re
building, I encourage you to explore some of those ideas by building a simple game.&lt;/p&gt;
&lt;p&gt;Thanks for reading, happy hacking !&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;&lt;strong&gt;References and Further Reading&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;[Entity Interpolation] - &lt;a href=&quot;http://www.gabrielgambetta.com/fpm3.html&quot;&gt;http://www.gabrielgambetta.com/fpm3.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://gafferongames.com/networked-physics/snapshots-and-interpolation/&quot;&gt;&lt;span&gt;[Entity Interpolation] - &lt;/span&gt;http://gafferongames.com/networked-physics/snapshots-and-interpolation/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;[Lag Compensation] - &lt;a href=&quot;https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking#Lag_compensation&quot;&gt;https://developer.valvesoftware.com/wiki/Source&lt;em&gt;Multiplayer&lt;/em&gt;Networking#Lag_compensation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Fantastic meetings and where to find them]]></title><description><![CDATA[Anecdotally most people in the software industry hate meetings; a meeting is a soul-sucking dementor. Jokes aside, I think it’s fair to say…]]></description><link>https://qingwei91.github.io/meetings/</link><guid isPermaLink="false">https://qingwei91.github.io/meetings/</guid><pubDate>Sat, 01 Apr 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Anecdotally most people in the software industry hate meetings; a meeting is a soul-sucking dementor. Jokes aside, I think it’s fair to say that people feel meetings are taking too much time and the process is often painful.&lt;/p&gt;
&lt;p&gt;In this post, I’ll try to provide a few rules of thumb that I believe can make meetings less painful and more efficient.&lt;/p&gt;
&lt;h2&gt;Rule 1: Always reiterate your goal before start&lt;/h2&gt;
&lt;p&gt;How many times do you attend a meeting without a goal in mind?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Me: Dozens of them&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The &lt;code class=&quot;language-text&quot;&gt;why&lt;/code&gt; is the first question you should answer before stepping into a meeting room. If you can’t tell why are we are having a meeting, there is something missing in your communication process. You should fix it ASAP.&lt;/p&gt;
&lt;p&gt;In many cases, only a few people know the goal clearly. If we conduct a meeting without communicating the goal to the rest of team, one or more of the following might happen:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;People realize they don’t know the goal and start asking questions to figure it out&lt;/li&gt;
&lt;li&gt;The rest of the team thought they knew the goal well enough and are using this incorrect understanding to make decisions&lt;/li&gt;
&lt;li&gt;People who feel the goal isn’t clear and then tend to follow an other’s opinion&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In first case, you lost time but still can reach the goal eventually. For #2 and #3 it gets worse:
you will get false sense of validation or invalidation on a decision as people agree (or disagree) without enough information.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A quick remedy for this problem is to simply reiterate the goal in a straightforward manner before meeting start.&lt;/strong&gt; This will likely be a responsibility of meeting initiator. If you call for a meeting, you should make it clear why to have one. If you are attending a meeting without a goal, ask for one to be added to the invite.&lt;/p&gt;
&lt;p&gt;This extra step only cost you a few minutes but the benefit is huge. It’s important to discover what people don’t know as soon as possible (like catching bug in software).&lt;/p&gt;
&lt;h2&gt;Rule 2: Limit the level of details in discussion&lt;/h2&gt;
&lt;p&gt;A common theme in meetings is &lt;code class=&quot;language-text&quot;&gt;discussion&lt;/code&gt;. Software development is largely about making decisions. Quite often individuals can make decisions on things on their own but sometimes a decision happens to have bigger implications. This warrants a meeting among the team or between several teams.&lt;/p&gt;
&lt;p&gt;It is important to conduct discussion in an efficient way. Unsurprisingly, this is not the case for many organizations.&lt;/p&gt;
&lt;p&gt;From my admittedly limited experience, one big problem in meeting is that people tends to open up related questions before a discussion point is concluded.&lt;/p&gt;
&lt;p&gt;For example, when we are trying to reach agreement on domain model, an engineer might unconciously start asking questions about implementation, eg. how does a domain model map into relational model of our favorite RDBMS.&lt;/p&gt;
&lt;p&gt;Sometimes, derail is a necessary evil. Some high level decisions depend on some very specific details of low level components, for example when deciding what latency a service should guarantee. We must consider technical feasibility to make informed decision.&lt;/p&gt;
&lt;p&gt;However, in general, it is completely avoidable.&lt;/p&gt;
&lt;p&gt;To avoid this problem, we have to &lt;strong&gt;scope the level of detail during discussion&lt;/strong&gt;. There are several techniques can be used:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Assign someone to guide the direction of discussion and try to resolve discussion point by point&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Be explicit throughout the process (like a sport commentator) by&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Repeating the discussion point (preferably in question form) before start&lt;/li&gt;
&lt;li&gt;Note sub-conclusion points whenever an agreement/disagreement is reached&lt;/li&gt;
&lt;li&gt;Note a conclusion to close the discussion before proceeding to next point&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Derailment is only allowed if justification is provided, e.g. we need to discuss project budget first as it affects our decision of team resource distribution.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; The &lt;code class=&quot;language-text&quot;&gt;sub-conclusion&lt;/code&gt; can be really simple. Just reiterate on every significant progress in the meeting, eg. “It seems like no one thinks option B is going to work, so we are left with option A and C. Let’s focus on A first to see if it fits our usecase”&lt;/p&gt;
&lt;p&gt;Despite it’s simplicity, you’ll be surprised how effective point #2 is when put into practice. By explicitly stating the progress of meeting, you’ll be able to grab people’s attention and give the team a sense of progress by having fast feedback loop (We all love feedback loop!)&lt;/p&gt;
&lt;h2&gt;Rule 3: Always have an agenda&lt;/h2&gt;
&lt;p&gt;We’ve talked about having clear goals and limit the discussion. It’s natural to think about meeting agendas, I believe having a meeting agenda facilitates earlier points we’ve discussed.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;An agenda should be derived from the goal(s) of the meeting and be arranged in a logical way that eventually leads to the goal&lt;/strong&gt; (this sounds recursive, bear with me).&lt;/p&gt;
&lt;p&gt;For example, if we are trying to decide what protocol to be used for multiple microservices, the agenda might look like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;* Problem to be solved including requirements
* Proposals
* Benefit cost analysis of each proposal
* Discussion and decisions&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By trying to come out with an agenda, you will discover more details before having a meeting. Items like analysis and proposals should really be prepared before the meeting; people only care about the result of the analysis, not the progress. It is easier for people to prepare before meeting with a clear agenda.&lt;/p&gt;
&lt;p&gt;The agenda definition can be driven by meeting initiator and collaboration with the team, allowing the rest of the team to add missing points in advance.&lt;/p&gt;
&lt;p&gt;Things like this may sounds obvious but still it was frequently neglected and causes unnecessary confusion.&lt;/p&gt;
&lt;h2&gt;Rule 4: Choose the right people to be in the meeting&lt;/h2&gt;
&lt;p&gt;Another common problem of meetings is that it involves the wrong people. Sometimes we include more people than necessary. Sometimes we leave out important people that can provide crucial information. Sometimes both.&lt;/p&gt;
&lt;p&gt;People are sometimes lazy to figure out who to invite and invite the whole team. Such a strategy might work but it is not very efficient. People specialize for a reason and letting people focus on their expertise is more productive.&lt;/p&gt;
&lt;p&gt;On the other hand, it’s also easy to leave out important people, especially when they are in different team, and we need to make a decision involving cross team effort.&lt;/p&gt;
&lt;p&gt;Choosing the correct people is only possible if you have a clear understanding on what to discuss and more importantly what NOT to discuss (see #1 and #2).&lt;/p&gt;
&lt;p&gt;This rule, when executed properly, will save your organization substantial amount of time.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;To summarize, a fantastic meeting usually consists of&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Clear goal&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Well defined agenda&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Close to zero derailment&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;People with the right information&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I hope you find this post useful. Feedback is welcome. Feel free to drop me a message =)&lt;/p&gt;</content:encoded></item><item><title><![CDATA[How multiplayer game sync their state? (Part 1)]]></title><description><![CDATA[The main problem in multiplayer game In multiplayer game, one of the most complex issue is to keep all player’s state in sync with server…]]></description><link>https://qingwei91.github.io/multiplayer-game1/</link><guid isPermaLink="false">https://qingwei91.github.io/multiplayer-game1/</guid><pubDate>Wed, 01 Mar 2017 00:00:00 GMT</pubDate><content:encoded>&lt;h3&gt;The main problem in multiplayer game&lt;/h3&gt;
&lt;p&gt;In multiplayer game, one of the most complex issue is to keep all player’s state in sync with server state.
There are a few good articles around this topic on the internet. However, some details are missing here and there, which may be confusing for beginners in field of game programming, I hope I can clear things up in this article.&lt;/p&gt;
&lt;p&gt;I’ll present a few techniques commonly used in this problem space.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Before&lt;/strong&gt; we jump into the problem, let’s have an overview on how multiplayer game generally works.&lt;/p&gt;
&lt;p&gt;Typically, a game program needs to simulate&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the changes in an environment with respect of time and players input&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Game is stateful program, it depends on time (be it real or logical time), for example, PACMAN is simulating an environment that ghosts will keep moving.&lt;/p&gt;
&lt;p&gt;A multiplayer game is no exception, just that the complexity is higher due to interaction between multipler players.&lt;/p&gt;
&lt;p&gt;Let’s use the classic Snake Game as an example, assume we use a server-client settings. The core game logic works like this&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Read user inputs which can be one of [←, ↑, →, ↓], to change the direction of snake.&lt;/li&gt;
&lt;li&gt;Apply user input if any, which change the direction of snake.&lt;/li&gt;
&lt;li&gt;Move snake by 1 unit space&lt;/li&gt;
&lt;li&gt;Check if any snakes bump into enemy/wall/self, remove them from the game.&lt;/li&gt;
&lt;li&gt;Repeat&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This logic will be run at a fixed interval on server side, as below, each loop is a called a &lt;code class=&quot;language-text&quot;&gt;frame&lt;/code&gt; or a &lt;code class=&quot;language-text&quot;&gt;tick&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/**
      * 1. Read user inputs which can be one of [←, ↑, →, ↓], to change the direction of snake.
      * 2. Apply user input if any, which change the direction of snake.
      * 3. Move snake by 1 unit space
      * 4. Check if any snakes bump into enemy/wall/self, remove them from the game.
      * 5. Broadcast the new game state to all clients
      */&lt;/span&gt;
      Thread&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sleep&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the simplest client would just listen to server update and render every frame received to players.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Client &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; onServerUpdate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; GameState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      renderGameState&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;The problem&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;How do we sync the game world between server and different players in real time?&lt;/p&gt;
&lt;h2&gt;Lockstep State update&lt;/h2&gt;
&lt;h3&gt;Concept&lt;/h3&gt;
&lt;p&gt;To make sure all client are in sync, the simplest way is to let client send update to server in a fixed interval,
let’s say every 30ms. The update would contains user input, it can also represent &lt;code class=&quot;language-text&quot;&gt;no user input&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Once server gather input from &lt;strong&gt;all user&lt;/strong&gt;, it can then proceed with next tick using those inputs.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/lockstep-single.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;The image above show how one client interact with server, I hope the problem is obivous, client will stay idle from &lt;strong&gt;T0&lt;/strong&gt; to &lt;strong&gt;T1&lt;/strong&gt;, waiting for server update to proceed. The latency can range from 50ms to 500ms, depending on network quality, and human will notice any delay over 100ms, so freezing the user interface for 200ms can be big problem for some games. This is not the only issue with lockstep approach.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/lockstep-multi.png&quot; alt=&quot;img&quot;&gt;
This image is slightly more complicated, showing multi-client interaction with server, you can see that client B have a slower network connection, thus although both A and B send input to server at &lt;strong&gt;T0&lt;/strong&gt;, update from B reach server at &lt;strong&gt;T2&lt;/strong&gt; instead of &lt;strong&gt;T1&lt;/strong&gt;, server only proceed once it receive all updates which is &lt;strong&gt;T2&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This means&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the latency of the game is now the latency of the most lagged player&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;we are punishing all players because one of them is lagging, eventually all players will leave your game …&lt;/p&gt;
&lt;p&gt;Not to say there’s a possiblity that client B might be disconnected, thus will block the server until connection timeout.&lt;/p&gt;
&lt;h3&gt;Discussion&lt;/h3&gt;
&lt;p&gt;There are some problems including 2 of which we just mentioned :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Client will not be responding until receive state update from server, horrible user experience.&lt;/li&gt;
&lt;li&gt;Game responsiveness depends on the most lagged players, playing with a friend with DSL connection? Have Fun&lt;/li&gt;
&lt;li&gt;The connection would be really chatty, clients need to send some useless heartbeat data regularly so that server can confirm it have got all information needed to step forward, which is not efficient.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;First of all, certain kind of games are immune to these problems, most &lt;code class=&quot;language-text&quot;&gt;Turn-based&lt;/code&gt; game actually use some variant of
such model, as client are supposed to wait. For slow-paced game, small amount of delay is acceptable too, for example Farm Ville.&lt;/p&gt;
&lt;p&gt;A great example is &lt;strong&gt;Chess&lt;/strong&gt;, where 2 players take their own turn, assuming each turn takes 10 secs&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;user are expect to wait each other for 10 secs, they can wait&lt;/li&gt;
&lt;li&gt;2 players take turn alternatively, so lagged player does not affect other player&lt;/li&gt;
&lt;li&gt;each turn takes on average 5 secs, 1 request every 5 secs is fine&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;But for fast-paced game, like all FPS, all of these problems make lockstep approach not suitable for them.
We will see how we can solve these problem in the rest of articles.&lt;/p&gt;
&lt;h2&gt;Client Predictions&lt;/h2&gt;
&lt;p&gt;Let’s first solve the problem of user-responsiveness, game response after 500 millis after user press a key destroy
the gaming experience. How to solve this problem?&lt;/p&gt;
&lt;h3&gt;Concept&lt;/h3&gt;
&lt;p&gt;Some of you might have already have the answer, instead of waiting on server update, client can actually emulate the game by running game logic locally (ie. on the client’s machine).&lt;/p&gt;
&lt;p&gt;Let’s assume to produce game state at &lt;code class=&quot;language-text&quot;&gt;Tn&lt;/code&gt;, we need state at &lt;code class=&quot;language-text&quot;&gt;Tn-1&lt;/code&gt; and all user input at &lt;code class=&quot;language-text&quot;&gt;Tn-1&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-single.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;The idea is simple, let’s have a fixed update rate, which is &lt;code class=&quot;language-text&quot;&gt;1 unit of time&lt;/code&gt; in this example, client send input to server at &lt;strong&gt;T0&lt;/strong&gt;, and emulate the game state at &lt;strong&gt;T1&lt;/strong&gt;, so client can then render the game without having to wait the state update from server, which only arrive at &lt;strong&gt;T3&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This approach only works if&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Game state update logic is deterministic, ie. no randomness, or in some way, referentially transparent, so that server and client produce the same game state given the same input.&lt;/li&gt;
&lt;li&gt;Client have all information required to run game logic&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;1 is not always true, but we can try to make it as similar as possible, and ignore the small differences, ie. floating points computation of different platform, use the same seed for pseudo-random algorithm.&lt;/p&gt;
&lt;p&gt;2 is also not true, for example&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-multi.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;In the image above, Client A still try to emulate game state at &lt;strong&gt;T1&lt;/strong&gt; using the information it has from &lt;strong&gt;T0&lt;/strong&gt;, but Client B also submitted input at &lt;strong&gt;T0&lt;/strong&gt;, which Client A is not aware of, this means Client A’s prediction of &lt;strong&gt;T1&lt;/strong&gt; will be wrong. Luckily, since Client A still receive state of &lt;strong&gt;T1&lt;/strong&gt; from server, at &lt;strong&gt;T3&lt;/strong&gt;, client have the chance to correct it’s mistake.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Client side need to figure out if the previous emulation is correct, and how to resolve the conflicts.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The resolution of conflicts is normally called &lt;strong&gt;Reconcilation&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Implementation of &lt;strong&gt;Reconcilation&lt;/strong&gt; varies depending on use case, I’ll show a simple one, which we just throw away our prediction and replace it with the correct state from server.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Client need to maintain 2 buffers, one for predictions, one for user input, which can be used to compute predictions.
Remember, &lt;strong&gt;State Tn&lt;/strong&gt; is computed using &lt;strong&gt;State Tn-1&lt;/strong&gt; and &lt;strong&gt;Input Tn-1&lt;/strong&gt;, it will be empty at first.
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-initbuffer.png&quot; alt=&quot;img&quot;&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When player press an arrow key, the input in stored in InputBuffer, and client will also produce predictions which is then used to render the view, the prediction is stored in PredictionBuffer.&lt;/p&gt;
&lt;div&gt;
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-buffer1.png&quot;&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-buffer2.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;
&lt;p&gt;When server State0 is received, and does not match with the client Prediction0, we can replace Prediction0 with State0, and recompute Prediction1 using Input0 and State0.&lt;/p&gt;
&lt;div&gt;
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-reconciledbuffer.png&quot; style=&quot;display:block;&quot;&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;After reconcilation, we can safely removed State0 and Input0 from the buffer, as we can confirm we got it correct.
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-droppedbuffer.png&quot; alt=&quot;img&quot;&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Note: this reconcilaton comes with a drawback, there might be glitches on view if server state and client prediction differ too much, for example if we predict enemy is moving south on &lt;strong&gt;T0&lt;/strong&gt;, but at &lt;strong&gt;T3&lt;/strong&gt; we realize it move towards north, and reconcile by simply using state from server, the enemy will bounce from towards north to reflect it’s correct position. There are ways to handle this problem, but it will not be in this article.&lt;/p&gt;
&lt;h3&gt;Discussion&lt;/h3&gt;
&lt;p&gt;Client prediction technique gives us a big benefit&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Client run on it’s own update rate, independent to server update rate, so that if server is having hiccups, it does not affect client side frame rate.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It inevitably comes with some complexity :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We need to handle more state and logic on client side, (Prediction buffer, state buffer, prediction logic).&lt;/li&gt;
&lt;li&gt;We need to decide how to handle conflict between prediction and real state from server.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;And it still leave us with some problem :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;View glitches due to wrong predictions&lt;/li&gt;
&lt;li&gt;Chatty connection&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;In this article, we went through 2 ways of approaching multiplayer game networking :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Lockstep state update&lt;/li&gt;
&lt;li&gt;Client prediction&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Each comes with it’s own set of trade off, so far we havent get a closer look on the server side, which will be covered in next article some time later.&lt;/p&gt;
&lt;p&gt;Thanks for reading !&lt;/p&gt;</content:encoded></item></channel></rss>