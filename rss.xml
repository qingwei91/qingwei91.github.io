<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[All models are wrong]]></title><description><![CDATA[I write stuff so I can forget.]]></description><link>https://qingwei91.github.io</link><generator>GatsbyJS</generator><lastBuildDate>Sat, 11 Feb 2023 08:17:33 GMT</lastBuildDate><item><title><![CDATA[Build Stateful with fs2, cats-effect]]></title><description><![CDATA[Stateful-ness Raft Algorithm Raft is a distributed consensus algorithm, it allows a number of processes to reach consensus on a value over…]]></description><link>https://qingwei91.github.io/stateful-app/</link><guid isPermaLink="false">https://qingwei91.github.io/stateful-app/</guid><content:encoded>&lt;h1&gt;Stateful-ness&lt;/h1&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;def &lt;span class=&quot;token function&quot;&gt;someApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Int&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Int

&lt;span class=&quot;token function&quot;&gt;someApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 20&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;someApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 40&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;h2&gt;Raft Algorithm&lt;/h2&gt;
&lt;p&gt;Raft is a distributed consensus algorithm, it allows a number of processes to reach consensus on a value over asynchronous network. &lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;Some properties of Raft&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Leader based, all writes go through Leader&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Two inter-process RPC:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Leader election&lt;/li&gt;
&lt;li&gt;
&lt;h2&gt;Log Replication&lt;/h2&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Raft Cluster Client Api&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;RaftCluster&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// return null&lt;/span&gt;

RaftCluster&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

RaftCluster&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// return 20&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;h2&gt;Cluster Setup&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/someimg&quot; alt=&quot;ThreeNodesDiagram&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;Leader Election&lt;/h2&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Initial&lt;/th&gt;
&lt;th&gt;Desired&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;img src=&quot;&quot; alt=&quot;img&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;img src=&quot;&quot; alt=&quot;img&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2&gt;Leader election flow&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Periodically run a checking process   &lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Start an election if needed:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Update state to become candidate, and vote for self&lt;/li&gt;
&lt;li&gt;broadcast VotingRequest&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;1a. Periodic check&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;effect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Timer
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; fs2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Stream

trait RaftAlgorithm&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  def raftProcess&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Timer&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;randomTime&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;FiniteDuration&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Stream&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    Stream&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;repeatEval &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        wait &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; randomTime
        _    &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; Timer&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wait&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; 
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    
  def needElection&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Boolean&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;??&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;1b. Check existing cluster state&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;effect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Timer
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; fs2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Stream

trait RaftAlgorithm&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
      
  def state&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Ref&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; NodeState&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    
  def needElection&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Boolean&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      st &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get
      noLeader  &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; st&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;leader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isEmpty
      responses  &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;noLeader&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tpe &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Candidate&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
              &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; getVotes
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;pure&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;empty&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// do nothing &lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
       &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;  
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  
  def getVotes&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Map&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; VoteRequest&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;??&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;NodeState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;tpe&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// Follower, Candidate, Leader&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;leader&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Option&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;String&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;hr&gt;
&lt;h4&gt;Ref&lt;/h4&gt;
&lt;p&gt;var on steroid, used to model mutable state that is accessed concurrently&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;trait Ref&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  def get&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  def &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function-variable function&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;A&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Unit&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[SQL Server how to write many rows quicker]]></title><description><![CDATA[I’ve been dealing with SQL Server lately, mostly on the write side, one of the biggest challenge is to make the write faster. Context: We…]]></description><link>https://qingwei91.github.io/sqlserver/upsert-perf/</link><guid isPermaLink="false">https://qingwei91.github.io/sqlserver/upsert-perf/</guid><content:encoded>&lt;p&gt;I’ve been dealing with SQL Server lately, mostly on the write side, one of the biggest challenge is to make the write faster.&lt;/p&gt;
&lt;p&gt;Context: We have a simple pipeline that read from kafka and upsert the records into SQL Server, reusing the key from kafka messages.&lt;/p&gt;
&lt;p&gt;Below are some tips I’ve learned:&lt;/p&gt;
&lt;h2&gt;Do not use auto-commit when writing multiple rows&lt;/h2&gt;
&lt;p&gt;By default, MS SQL jdbc driver use implicit transaction when writing to SQL Server, this is undesirable because the overhead of transaction is very high.&lt;/p&gt;
&lt;p&gt;This is so far the most significant factor in my case.&lt;/p&gt;
&lt;h2&gt;Prefer Table Valued Parameters over single row&lt;/h2&gt;
&lt;p&gt;According to MSDN docs, table valued param should perform better than updating row by row, it makes sense from a logical standpoint, but I’ve yet observe significant differences.
Note that to use Table Valued Parameters, you need to define your update operation using a Stored Procedure, and define a corresponding Table Type on the server.&lt;/p&gt;
&lt;p&gt;In jdbc connector, there are 3 apis that can be use to model TableValue Parameters, anedoctally, the ISQLServerDataRecord is better than SQLServerDataTable because of its streaming purpose, I am not entirely convinced and havent find evidence on this yet.&lt;/p&gt;
&lt;h2&gt;There are 2 types of batching, client side and server side&lt;/h2&gt;
&lt;p&gt;One tip that come up a lot about SQL performance is batching, but this term can mean different thing in different cases;&lt;/p&gt;
&lt;p&gt;If the application performing write is using MSSQL JDBC driver, then one can perform batching from the client, it essentially combine many commands into a single unit of work. This is useful when you are submitting many commands, but if you are using Table Value Parameters then you dont have to batch as there’s only a single command.&lt;/p&gt;
&lt;p&gt;Another type of batching happen on server side, typically defined in Stored Procedures by T-SQL.&lt;/p&gt;
&lt;p&gt;The idea is to have a stored procedure taking Table Value Parameters, and then break it into chunks and perform update in chunk in a loop.&lt;/p&gt;
&lt;p&gt;I’ve read a few articles claiming this is the best way, but I havent try it out. It sounds plausible because it has the least network overhead and looping is done on server side.&lt;/p&gt;
&lt;h2&gt;Where to find docs&lt;/h2&gt;
&lt;p&gt;Oh god, MSDN doc on SQL Server is either too verbose or not on point, at least for my usage.&lt;/p&gt;
&lt;p&gt;I did however learn to look for AzureSQL docs even if you’re not using Azure, looks like that got more love.&lt;/p&gt;
&lt;h2&gt;Concurrent commands from different clients dont work well&lt;/h2&gt;
&lt;p&gt;This is not unexpected, as SQL Server being a ACID compliant RDBMS uses locks extensively, so concurrent commands tend to create lock contentions.&lt;/p&gt;
&lt;p&gt;Depending on the batch size, SQL Server will decide to use row-level lock or table level lock, I’ve seen people suggest 5000 is the threshold that control this lock escalation.&lt;/p&gt;
&lt;p&gt;Beyond this, every row lock also correpond to a page lock because data is really stored on page, and multiple concurrent changes of different rows can still access the same page, leading to contention.&lt;/p&gt;
&lt;p&gt;If you use clustered index (which you typically should), then your rows are layout according to the index, for example, if your clustered index is defined on an Int column in ascending order, then rows are stored on pages close to each other according to their index value, row 1 and row 2 are likely to be on the same page, where row 300000 might be further away in a different page.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Random thoughts on coding interview]]></title><description><![CDATA[An idea to do coding interview more effectively A major complaint we have as an industry is LeetCode style coding interview, people hates it…]]></description><link>https://qingwei91.github.io/coding-interview/</link><guid isPermaLink="false">https://qingwei91.github.io/coding-interview/</guid><pubDate>Sat, 11 Jun 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;An idea to do coding interview more effectively&lt;/h2&gt;
&lt;p&gt;A major complaint we have as an industry is LeetCode style coding interview, people hates it, and some claims its not effective and generate too much false negatives.&lt;/p&gt;
&lt;p&gt;I thought a random idea to make it more useful.&lt;/p&gt;
&lt;p&gt;The idea is to setup a leetcode style coding challenge, and provide multiple choices of solutions written in English (or whatever language of your choice). We then let the candidate to choose the right solution, and implement it in their programming language of choice.&lt;/p&gt;
&lt;p&gt;Once completed, interviewer can discuss the solution with the candidate.&lt;/p&gt;
&lt;p&gt;There are a few things we can tweak:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Obviously we can choose question that fit the domain of the role&lt;/li&gt;
&lt;li&gt;The choices, we should consider mixing correct and incorrect answer, optimal and non-optimal answer&lt;/li&gt;
&lt;li&gt;We can also choose the timing to present these options, maybe we let the candidate to try for the 1st 10 mins, then provide these options to help them&lt;/li&gt;
&lt;li&gt;You can also throw in code solution into the mix, if you want to assess candidate’s ability to read such code.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;More often than not, a software engineer’s job is not to design novel algorithm but to understand existing algorithm, reason about it. Sometimes, we might also need to read some poorly written papers, understand it and codify the approach in our solution. So I think this approach will provide a better Signal/Noise ratio.&lt;/p&gt;
&lt;p&gt;I won’t be going into the pros and cons of coding interview, the fact is many companies rely on them, and making it more useful should be a net-win. &lt;/p&gt;
&lt;p&gt;Thanks for reading!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Code Readability 9527]]></title><description><![CDATA[Code Readability, Tip #9527 Note: This is a short post, more akin to a brain dump. To optimize for Code Readability, you should aim to…]]></description><link>https://qingwei91.github.io/code-readability/</link><guid isPermaLink="false">https://qingwei91.github.io/code-readability/</guid><pubDate>Tue, 24 May 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Code Readability, Tip #9527&lt;/h2&gt;
&lt;p&gt;Note: This is a short post, more akin to a brain dump.&lt;/p&gt;
&lt;p&gt;To optimize for Code Readability, you should aim to communicate intent, not implementation specificity, unless implementation specificity is your intent.&lt;/p&gt;
&lt;p&gt;Implementation specificity is typically (part of) your intent when your code is performance sensitive.&lt;/p&gt;
&lt;p&gt;Whatever you optimize for will become apparent to the future reader, and if you apply such rule consistently, it will train people to assume intent to be invariants, and can liberally change the underlying mechanism.&lt;/p&gt;
&lt;p&gt;I feel that this is related to my preference towards Tagless Final pattern, where one try to express intent as algebra without implementation, compose those algebras to produce the final program, and then provide implementations to adhere to the algebras. There is a downside to this workflow though, it can be quite annoying when you’re exploring the solution space as you dont know the algebra yet, so it can take a few iterations to get there. One alternative is to write scrappy code to explore more of the solution space before encoding them into proper algebra.&lt;/p&gt;
&lt;p&gt;TODO: I should try to find some examples to support my take.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Different levels of beliefs]]></title><description><![CDATA[I noticed something interesting in day to day communication, when someone make a statement, for example, , there are multi degrees of…]]></description><link>https://qingwei91.github.io/diff-levels-of-belief/</link><guid isPermaLink="false">https://qingwei91.github.io/diff-levels-of-belief/</guid><pubDate>Thu, 05 May 2022 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;I noticed something interesting in day to day communication, when someone make a statement, for example, &lt;code class=&quot;language-text&quot;&gt;Fire is red&lt;/code&gt;, there are multi degrees of beliefs. But it is too nuanced to differentiate them purely based on our day to day language.&lt;/p&gt;
&lt;p&gt;Let’s say Alice and Tom is having a conversation, and Alice said &lt;code class=&quot;language-text&quot;&gt;Earth is Flat&lt;/code&gt;, there are at least 3 interpretations&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Alice believe what she said, and she also think Tom should agree with her unless Tom is unreasonable or stupid or both.&lt;/li&gt;
&lt;li&gt;Alice believe what she said, but she acknowledge this isnt a widespread knowledge, so she expect Tom to not agree with her and be wrong.&lt;/li&gt;
&lt;li&gt;Alice believe what she said, but acknowledge this is a controversial take, and people disagreeing with her can be as reasonable as her.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For the lack of better word, I am calling this 3 levels of self belief. I frequently see people failing to differentiate them, especially between the 3rd and 2nd level. In the context of online forum, this makes people feel offended, and make communication less effective.&lt;/p&gt;
&lt;p&gt;I believe the best way to engage (assuming a non-competitive context) is to always interpret other’s position in the best possible way.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CRDT implemented using Typeclass]]></title><description><![CDATA[Overview This article shows how to implement CRDT using typeclass in Scala 3. I used this exercise to learn more about CRDT, while picking…]]></description><link>https://qingwei91.github.io/crdt/</link><guid isPermaLink="false">https://qingwei91.github.io/crdt/</guid><pubDate>Sun, 17 Apr 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;Overview&lt;/h1&gt;
&lt;p&gt;This article shows how to implement CRDT using typeclass in Scala 3. I used this exercise to learn more about CRDT, while picking up some new features from Scala 3.&lt;/p&gt;
&lt;p&gt;For readers who are unfamiliar to CRDT, CRDT is a kind of data structure that are replicated (typically across network), they can be updated independently and is guarantee to converge eventually without the need of a centralized controller (ie. a server).&lt;/p&gt;
&lt;p&gt;One of the most common use case is collaborative text editing.&lt;/p&gt;
&lt;p&gt;To learn more, I recommend this survey study: &lt;a href=&quot;https://hal.inria.fr/inria-00555588/document&quot;&gt;A comprehensive study of Convergent and Commutative Replicated Data Types&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Note all source code used in this post can be found &lt;a href=&quot;https://github.com/qingwei91/crdt-scala3/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h1&gt;CmRDT Algebras&lt;/h1&gt;
&lt;p&gt;CmRDT (Commutative Replicated Data Types) is a type of CRDT, it is sometimes called op-based CRDT. The key characteristic of it is that changes on data are synced by operations instead of sending the whole state. This is in contrast with CvRDT, which sync by sending the whole state over the network, there are some trade-off between these 2 types, but we wont delve into them in this piece.&lt;/p&gt;
&lt;p&gt;We will explore the algebra of CmRDT, and encode them in Scala 3.&lt;/p&gt;
&lt;p&gt;To fully define CmRDT and corresponding algebra, we need to define a few concepts:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;State&lt;/code&gt; refers to data structure that represents CmRDT&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Local Copy&lt;/code&gt; refers to CmRDT’s state that is local with respect to the operations&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Local Operation&lt;/code&gt; is data structure that represents operations on a local copy&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Remote Copy&lt;/code&gt; refers to CmRDT’s state that is remote with respect to the operations&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Remote Operation&lt;/code&gt; is data structure that represents operations on a remote copy, and need to be sync to a local copy&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Before defining the algebra, let’s go through the overall flow informally just to get a feel of CmRDT, I will use the most trivial CmRDT as a example, which is a Counter.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6328353ce0b4de6ed49eeb9fcdc9ab40/e088a/counter-crdt.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 102.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAABibAAAYmwFJdYOUAAAByklEQVQ4y5WS6W6jQBCE/f4vFuVHlMjK5tpFAR8BvDAwzH0AKTMOMTYiSssyoumvp3qqV/0Q1lqljLVeKd11XX8VbdsKLZRT+HfeheQqPJpGxnHx9JSkKXXOn2Ndf+xlvX3YPtxGt3fJHdc85E8wpfL9vXx+3qVp45y7ho0z62x9E93cp/dMs2O++4KhlnPNmMIPCq9le++JIKUoS14aayayQyelVb8YgvPzG1kFjlSEk4Ym5QKJw6N9XZKa0vobRrPtx45lNX3MpVEomoU5F+uEbXbZ/0P+PTMebddqKqvo4FuvtVZKwbxxeLRDRkr1uiFCme4rf5pZSmmM0UaP8wPWQ+ATyNBIDIHKMPnoc4MilF4sBpJFUaRpWg4hOAOMsgkcTkPL8RVugwQfVDhradP8S1IujkImsrshQsvjJgoxVoxhrPuzE29RvEniyZIEGTg5z/P9fp9l2cUIQctjXDOh29ZfLgmiqqrxMmaDVBQuDzcv0WsVnKANrXNyePn4YcOECL7gFkCd4LfoL9kW4pW0fbcMX60neCxJo+qk+PHkCQwBMBBKGGdcit/BwUbYA/HnPs8GBp6RHdzCt2UYizgPByeXYWg8f/0E5VTPAFi6WtkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;counter-crdt&quot;
        title=&quot;counter-crdt&quot;
        src=&quot;/static/6328353ce0b4de6ed49eeb9fcdc9ab40/fcda8/counter-crdt.png&quot;
        srcset=&quot;/static/6328353ce0b4de6ed49eeb9fcdc9ab40/12f09/counter-crdt.png 148w,
/static/6328353ce0b4de6ed49eeb9fcdc9ab40/e4a3f/counter-crdt.png 295w,
/static/6328353ce0b4de6ed49eeb9fcdc9ab40/fcda8/counter-crdt.png 590w,
/static/6328353ce0b4de6ed49eeb9fcdc9ab40/efc66/counter-crdt.png 885w,
/static/6328353ce0b4de6ed49eeb9fcdc9ab40/e088a/counter-crdt.png 1015w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;We can view this sequence diagram from top to bottom.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The system contains 2 data structures, replicated, labeled as Local copy and Remote copy respectively, both initialized to 0.&lt;/li&gt;
&lt;li&gt;Local copy performs &lt;code class=&quot;language-text&quot;&gt;Add 2&lt;/code&gt; operation, changing state from 0 to 2&lt;/li&gt;
&lt;li&gt;Concurrently, Remote copy performs &lt;code class=&quot;language-text&quot;&gt;Add 3&lt;/code&gt; operation, changing state from 0 to 3&lt;/li&gt;
&lt;li&gt;Local copy send &lt;code class=&quot;language-text&quot;&gt;Add 2&lt;/code&gt; operation to remote copy&lt;/li&gt;
&lt;li&gt;Remote copy apply &lt;code class=&quot;language-text&quot;&gt;Add 2&lt;/code&gt;, changing state from 3 to 5&lt;/li&gt;
&lt;li&gt;Remote copy send &lt;code class=&quot;language-text&quot;&gt;Add 3&lt;/code&gt; operation to local copy&lt;/li&gt;
&lt;li&gt;Local copy apply &lt;code class=&quot;language-text&quot;&gt;Add 3&lt;/code&gt;, changing state from 2 to 5&lt;/li&gt;
&lt;li&gt;Finally, both copy are in sync and have the same value as 5&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;From the flow above, we can notice that local operations can happen concurrently, they will then need to be sync to remote copies, in this process, the order of operations are not the same in different copies, but we should still get the same result. This property is known as Commutative, which is where the name comes from.&lt;/p&gt;
&lt;p&gt;Now, we can enter the algebras and constraints, it can be distilled into the following rules:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;localChange&lt;/code&gt; operation, this applies a &lt;code class=&quot;language-text&quot;&gt;Local Operation&lt;/code&gt; to a &lt;code class=&quot;language-text&quot;&gt;Local Copy&lt;/code&gt;, it will update the local state&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;syncRemote&lt;/code&gt; operation, this applies a &lt;code class=&quot;language-text&quot;&gt;Remote Operation&lt;/code&gt; to a &lt;code class=&quot;language-text&quot;&gt;Local Copy&lt;/code&gt;, it will update the local state&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;localChange&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;syncRemote&lt;/code&gt; should be commutative, the order of applying them shouldn’t matter&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Encoding Algebras in code&lt;/h2&gt;
&lt;p&gt;Now that we have the algebra, let’s encode them in Scala, I am using Scala 3, I will try to be as abstract and precise as possible.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; CmRDT&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; RemoteOp
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; LocalOp
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ProjectValue
  extension &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; syncRemote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;op&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; RemoteOp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; change&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;op&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LocalOp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RemoteOp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; read&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ProjectValue
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here, we model CmRDT as a typeclass, let’s inspect all elements:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;type param &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, we are implementing it as typeclass, so &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; represent any data type that can be CmRDT&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; type member, this represents all possible Remote Operations&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;LocalOp&lt;/code&gt; type member, this represents all possible Local Operations&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;ProjectValue&lt;/code&gt; type member, this wasn’t mention on the section above, it represents the value we want to read from CmRDT without all of the metadata, its purpose will be more apparent later when we look at testing&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;All 3 methods are implemented as extension methods, this is a &lt;a href=&quot;https://docs.scala-lang.org/scala3/book/ca-extension-methods.html&quot;&gt;new feature&lt;/a&gt; from Scala 3&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;syncRemote&lt;/code&gt; applies a &lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; to a local copy, and return a new A, this means it can be implemented as pure function&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;change&lt;/code&gt; applies a &lt;code class=&quot;language-text&quot;&gt;LocalOp&lt;/code&gt; to a local copy, it returns &lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, it returns &lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; because for every local operation applied, we need to apply a corresponding &lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; to remote copies, which will come from this method&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt; returns the &lt;code class=&quot;language-text&quot;&gt;ProjectValue&lt;/code&gt;, this is useful because sometimes &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; can be a relatively complicated data structure that stores metadata like nodeId etc, but our consumer code only care about the projected value, for example, an array or a set.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These is all we need to describe a CmRDT without committing to specific implementation details. Encoding algebra as typeclass allows us to verify checks against it.&lt;/p&gt;
&lt;h2&gt;Implementing test using encoded algebra&lt;/h2&gt;
&lt;p&gt;How do we test CmRDT? The rules are quite simple, we just need to make sure operations are commutative, ie. the order of operations does not affect the final results.&lt;/p&gt;
&lt;p&gt;Informally, we can encode it as &lt;code class=&quot;language-text&quot;&gt;f(g(x)) == g(f(x))&lt;/code&gt; where x is the State, and &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;g&lt;/code&gt; are both operations.&lt;/p&gt;
&lt;p&gt;Now we want to implement these rules using automated checks, let’s start with pseudo-code:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Initialize a collection of &lt;code class=&quot;language-text&quot;&gt;N&lt;/code&gt; CmRDT to the same value, for each CmRDT we also need to keep a buffer of remote Op, initialized to empty buffer&lt;/li&gt;
&lt;li&gt;Randomly pick one of the data structure A&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Randomly choose between performing a local change, or syncing a remote operation&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Note that we will need the ability to randomly generate a local change, this is where property-based test framework like Scalacheck comes handy&lt;/li&gt;
&lt;li&gt;We dont need to randomly generate Remote operation, because they are produced by &lt;code class=&quot;language-text&quot;&gt;def change(op: LocalOp): (RemoteOp, A)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;If there’s no remote operation to be sync for &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, it should be no-op&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;If we decide to perform a local change, we will generate a local operation, apply of &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, then store the corresponding &lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; alongside every other copies&lt;/li&gt;
&lt;li&gt;If we decide to sync remote operations, then we should randomly consume &lt;code class=&quot;language-text&quot;&gt;Q&lt;/code&gt; remote op from the remote Op buffer, and apply them one by one to &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Repeat step 2 to step 5 for &lt;code class=&quot;language-text&quot;&gt;k&lt;/code&gt; times&lt;/li&gt;
&lt;li&gt;Then we should clear all remaining &lt;code class=&quot;language-text&quot;&gt;RemoteOp&lt;/code&gt; in each CmRDT’s remote op buffer, this is to ensure we eventually applies all operations to all copies&lt;/li&gt;
&lt;li&gt;Assert that all CmRDT copies return the same value from &lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt; operation, here we can finally explain the purpose of &lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt; operation, the rule here is that all CmRDT copies must converge to the same value, but they only have to converge on their ProjectValue, not necessarily everything, and this is captured by &lt;code class=&quot;language-text&quot;&gt;read&lt;/code&gt; operation&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Now, we can see how it works in code, we will start by declaring a test module&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;State
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;Eval
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;syntax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;all&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;_
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;instances&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;list&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;_

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;org&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scalacheck&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;_
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;org&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scalacheck&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;rng&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;Seed

&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; CmRDTTestModule&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initData&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; seed&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; repetition&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;using &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; crdtEvi&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CmRDT&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; localOpGen&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Gen&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;crdtEvi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LocalOp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; TestState&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      seed&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Seed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      dataWithNetwork&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; UnreliableNetwork&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;crdtEvi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;RemoteOp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;empty
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Thanks to Scala3, traits can now take parameters, &lt;code class=&quot;language-text&quot;&gt;Data&lt;/code&gt; refers to the CRDT types, and initData is the collection of initial values, &lt;code class=&quot;language-text&quot;&gt;seed&lt;/code&gt; is passed in as well, so that we can simulate randomness deterministically, &lt;code class=&quot;language-text&quot;&gt;repetition: Int&lt;/code&gt; controls the no of loop we perform.&lt;/p&gt;
&lt;p&gt;The traits also expect &lt;code class=&quot;language-text&quot;&gt;val crdtEvi: CmRDT[Data]&lt;/code&gt;, to prove that &lt;code class=&quot;language-text&quot;&gt;Data&lt;/code&gt; is CmRDT. There is also 1 abstract method &lt;code class=&quot;language-text&quot;&gt;def localOpGen(dt: Data): Gen[crdtEvi.LocalOp]&lt;/code&gt; that should be implemented by concrete implementation, this allow us to generate &lt;code class=&quot;language-text&quot;&gt;LocalOp&lt;/code&gt;, the method takes a &lt;code class=&quot;language-text&quot;&gt;Data&lt;/code&gt; as input because sometimes we can only generate valid &lt;code class=&quot;language-text&quot;&gt;LocalOp&lt;/code&gt; with respect to existing state, for example in a KV store, it might be invalid to delete a non-existing key.&lt;/p&gt;
&lt;p&gt;Then we have an inner case class &lt;code class=&quot;language-text&quot;&gt;TestState&lt;/code&gt;, it represents all the state within the test flow, worth noting that it contains a list of &lt;code class=&quot;language-text&quot;&gt;(Data, UnreliableNetwork[crdtEvi.RemoteOp])&lt;/code&gt;, each tuple represent one CRDT with its corresponding RemoteOp buffer.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/qingwei91/crdt-scala3/blob/07e60e7f1306f01a7ecd7cdb76f2ff935f1737be/modules/crdt/src/test/scala/crdt/UnreliableNetwork.scala#L6&quot;&gt;UnreliableNetwork&lt;/a&gt; is a buffer of RemoteOp, it has some helper methods to help us manage the state. For simplicity, I wont show the full definition here.&lt;/p&gt;
&lt;p&gt;Now let’s look at the actual flow:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; CmRDTTestModule&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initData&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; seed&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; repetition&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;using &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; crdtEvi&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CmRDT&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Data&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  
  &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; opsAreCommutative&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; randomizedLoop&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; State&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;TestState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; to &lt;span class=&quot;token namespace&quot;&gt;repetition&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foldLeft&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;State&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;empty&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;TestState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;st&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        st&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flatMap&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_ &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; randomLocalChangeOrRemoteSync&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;


    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resultState&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; TestState&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
      randomizedLoop&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flatMap&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_ &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; clearRemainingRemoteOps&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initTestState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value


    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; finalData &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; resultState&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dataWithNetwork&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    assert&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;finalData&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;toSet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;def opsAreCommutative&lt;/code&gt; is our assertion method, before looking into the implementation, I wish point out that I implemented the flow using &lt;a href=&quot;https://typelevel.org/cats/datatypes/state.html&quot;&gt;State Monad&lt;/a&gt;, this allows us to model state mutation without side effect. It is easier this way because everytime we generate a random value, we need to mutate the &lt;code class=&quot;language-text&quot;&gt;Seed&lt;/code&gt; value to ensure the whole flow is deterministic. It is entirely possible to do without State monad and just mutate variable local to the trait, I just didnt do it that way.&lt;/p&gt;
&lt;p&gt;Now let’s look at the method, really it just performs 3 steps:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Randomly perform local change or remote sync for &lt;code class=&quot;language-text&quot;&gt;repetition&lt;/code&gt; times, &lt;code class=&quot;language-text&quot;&gt;repetition&lt;/code&gt; is a Int argument, every time we will randomly pick a copy from all CRDT values&lt;/li&gt;
&lt;li&gt;Clear remaning remote ops for every CRDT data&lt;/li&gt;
&lt;li&gt;Check that all CRDT data converges&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I wont show all of the code for this test module because they are too noisy, if you’re interested, you can find them &lt;a href=&quot;https://github.com/qingwei91/crdt-scala3/blob/07e60e7f1306f01a7ecd7cdb76f2ff935f1737be/modules/crdt/src/test/scala/crdt/CmRDTSpec.scala#L106&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I think the more interesting part is that once we’ve implemented the TestModule in an abstract way, we can reuse the same test implementation to many different CRDT implementation with low overhead.&lt;/p&gt;
&lt;p&gt;Let’s look at the simplest CRDT, &lt;code class=&quot;language-text&quot;&gt;Counter&lt;/code&gt;, it is implemented this way:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;opaque &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Counter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Double&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; Counter &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Double&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Counter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;
  extension &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Counter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Double&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  given counterCRDT&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CmRDT&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Counter&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Increment             &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Double&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; RemoteOp     &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Increment
    &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; LocalOp      &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Increment
    &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ProjectValue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Counter

    extension &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;counter&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Counter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; syncRemote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;op&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Increment&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Counter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; counter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; op

      &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; change&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;delta&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LocalOp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RemoteOp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Counter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        delta &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;counter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; delta&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; read&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ProjectValue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; counter
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here, we implement &lt;code class=&quot;language-text&quot;&gt;Counter&lt;/code&gt; as an opaque type, this is another new feature of &lt;a href=&quot;https://docs.scala-lang.org/scala3/book/types-opaque-types.html&quot;&gt;Scala 3&lt;/a&gt;. Basically we are saying Counter is a Double, but it can only be modified using methods defined here.&lt;/p&gt;
&lt;p&gt;We can see that the RemoteOp and LocalOp are the same, and they are just Increment. Then we can use our TestModule to test &lt;code class=&quot;language-text&quot;&gt;Counter&lt;/code&gt; this way.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;  test&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Counter is CRDT&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; counterIsCrDT &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; CmRDTTestModule&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Counter&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        initData &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Counter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Counter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Counter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        seed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        repetition &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; Expectations&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Helpers &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; localOpGen&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Counter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Gen&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;crdtEvi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LocalOp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
          Gen&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;double&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;asInstanceOf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;crdtEvi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LocalOp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    
    counterIsCrDT&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;opsAreCommutative
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we define &lt;code class=&quot;language-text&quot;&gt;CmRDTTestModule&lt;/code&gt; for Counter, and all we need to provide are &lt;code class=&quot;language-text&quot;&gt;initData&lt;/code&gt; &lt;code class=&quot;language-text&quot;&gt;seed&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;repetition&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;localOpGen&lt;/code&gt;, they can all be provided trivially. Then we just need to execute the assertion method to verify that our Counter CmRDT is implemented correctly.&lt;/p&gt;
&lt;p&gt;Let’s look at a 2nd example of CRDT, Multi-Value Register, it is a very simple data structure that represents a single value, the special thing is that it can detect concurrent edit, and when this occurs it will keep all concurrent values and allow reader to resolve the conflict.&lt;/p&gt;
&lt;p&gt;It is represented using this fairly simple data structure&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; MVRegister&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    pid&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ProcessId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    existing&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Set&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; VersionVector&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Clock&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    clock&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; VersionVector&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Clock
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The full implementation of MVRegister CRDT is available &lt;a href=&quot;https://github.com/qingwei91/crdt-scala3/blob/07e60e7f1306f01a7ecd7cdb76f2ff935f1737be/modules/crdt/src/main/scala/crdt/MVRegister.scala#L6&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Then we can look at the test&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;  test&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;MVRegister is CRDT&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; registerIsCRDT &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; CmRDTTestModule&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;MVRegister&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      initData &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        MVRegister&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        MVRegister&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        MVRegister&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      seed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1002L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      repetition &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; Expectations&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Helpers &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; localOpGen&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; MVRegister&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Gen&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;crdtEvi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LocalOp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
        Gen&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;long&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;toInt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;asInstanceOf&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;crdtEvi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LocalOp&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    
    registerIsCRDT&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;opsAreCommutative
    
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can see this test is very similar to the one we had for Counter, the main difference is the &lt;code class=&quot;language-text&quot;&gt;initData&lt;/code&gt; which is trivially different, and &lt;code class=&quot;language-text&quot;&gt;localOpGen&lt;/code&gt; is implemented differently.&lt;/p&gt;
&lt;p&gt;So we now have a very cheap way to test all CmRDT, provided that we can implement &lt;code class=&quot;language-text&quot;&gt;CmRDT[A]&lt;/code&gt; typeclasse for the type.&lt;/p&gt;
&lt;h1&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;I hope this exercise shows the usefulness of distilling a problem into its absolute essence and encode into using a powerful expressive type system. &lt;/p&gt;
&lt;p&gt;It helps us to reason about problem and solution without much noise, for instance, we know that for a type to be a CmRDT, it needs to provide 3 methods and fulfill the commutative property of 2 of those methods. We can then compose these algebra to that provides interesting properties, an example here is our ability to leverage the typeclass to implement property check.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[My thoughts of being a Manager in Software Development]]></title><description><![CDATA[Overview I wish to organize my random thoughts on the topic of becoming an Engineering Manager, after being a manager for 2 years. Structure…]]></description><link>https://qingwei91.github.io/management/guide/</link><guid isPermaLink="false">https://qingwei91.github.io/management/guide/</guid><pubDate>Thu, 07 Apr 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;Overview&lt;/h1&gt;
&lt;p&gt;I wish to organize my random thoughts on the topic of becoming an Engineering Manager, after being a manager for 2 years.&lt;/p&gt;
&lt;h1&gt;Structure of this article&lt;/h1&gt;
&lt;p&gt;I will break the responsibilities of an Engineering Manager into a few areas, for each area, we will discuss manager’s mission on each area, surprising observations in those area and lastly some applicable technique.&lt;/p&gt;
&lt;p&gt;While different organizations, or even the same organizations at different stages might need managers to do different thing, I think we can still summarize them into a few areas.&lt;/p&gt;
&lt;p&gt;Before that, I wish to define the ultimate goal of being a manager, I see 2 parts in it:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Help business to utilize resources to achieve its business goal that can be achieved using software technology&lt;/li&gt;
&lt;li&gt;Help the team (or whatever subunit you’re in) to be reasonably happy and/or fulfilled&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The 1st one is pretty self-explanatory, I specifically want to call out the 2nd point, it is probably more of my own belief than universal truth, but I really think it is important to keep people happy when we can.
Obviously there will inevitably be some tension between these 2 goals, and that’s fine, managers just need to keep this in mind, remember we are people 1st, then only we are engineers, workers, economic actors.&lt;/p&gt;
&lt;p&gt;With these 2 goals, I believe the following areas are relevant:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Team management&lt;/li&gt;
&lt;li&gt;Project/Work management&lt;/li&gt;
&lt;li&gt;People’s Growth&lt;/li&gt;
&lt;li&gt;Expectation management&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Team Management&lt;/h2&gt;
&lt;p&gt;Let’s start team, it quite difficult to precisely define what is a Team, so I wont try, but I think the following has to be true in most cases:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;You have a Team Mission&lt;/li&gt;
&lt;li&gt;You work closely with each other within the team, than with people outside of the team &lt;/li&gt;
&lt;li&gt;You understand what each team member is working on with greater details than people outside of the team&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I believe Teams are fundamental unit in Software Engineering organization, thus its worth spending time to talk about how they work.&lt;/p&gt;
&lt;p&gt;As a manager, you should be creating an environment so that your team can thrive, this will be our focus in this part.&lt;/p&gt;
&lt;h3&gt;Building a Team&lt;/h3&gt;
&lt;p&gt;A big part of a manager role is to build and maintain the team. Note that in most cases, manager should involve the Team when deciding these fundamental construct of the team, after all we designed all these constructs to help the team and they are the best person to judge.&lt;/p&gt;
&lt;h4&gt;1. Define the Team’s mission&lt;/h4&gt;
&lt;p&gt;Manager should make sure the team has a clear mission, and make sure everyone in the team understands the mission with as little ambiguities as possible. A clear mission is the cornerstone of a team, it allows the team to judge relevancy of work (and potential work), and act more autonomously.&lt;/p&gt;
&lt;h4&gt;2. Engineer the desired Team Dynamic and corresponding Principles&lt;/h4&gt;
&lt;p&gt;We should pay attention on Team Dynamic, this includes how people interact, and how people perceive stuff. I deliberately used the term engineer to indicate it is more than defining a list of goals and expectations. Team dynamic depends on incentive and the feedback people receives in their day to day, it is dynamic.&lt;/p&gt;
&lt;p&gt;The exact desired team dynamic differs across business and domains. However, I wish to propose a few ideas that I think are generally useful.&lt;/p&gt;
&lt;p&gt;First, we should build &lt;code class=&quot;language-text&quot;&gt;trust&lt;/code&gt; within a team, I think a trusting team tends to outperform a team that lacks trust, it also make workplace a better place to be in. To achieve this, a manager should first communicate the desire to the team, encourage openness and discourage overly judgemental behavior. For example, encouraging people to raise concern and dont be dismissal.&lt;/p&gt;
&lt;p&gt;We should also encourage ownership and autonomy, I expect my team to feel empowered to do their job, to own it. Autonomy makes people to feel more accomplished, and reduces management overhead. If people can and willing to make decisions on their own, you as a manager dont have to do it.
I also believe decisions should be made by people with the most information and insights, and in many cases, that’s not the manager.&lt;/p&gt;
&lt;p&gt;Note that Team Dynamic is difficult to fully expressed in words, and it is something that changes overtime, manager should always pay attention to it and adjust. &lt;/p&gt;
&lt;p&gt;1 tool I find useful is the &lt;a href=&quot;http://theteamcanvas.com/&quot;&gt;Team Canvas&lt;/a&gt; ceremony (or equivalent), a team can start by stating what we expect from each other and try to form consensus when we can. One thing worth noting is that Team Canvas is only suitable for stating the expectations and identify alignment and misalignment, it is not advised to try resolving conflict as that can often be too time consuming for it.&lt;/p&gt;
&lt;h4&gt;3. Establish Team activities/rituals&lt;/h4&gt;
&lt;p&gt;Manager should help the team to define regular activities and mechanism. For example, a team needs to define the frequency of Stand up meeting (if they need one?) and how to do it collectively.&lt;/p&gt;
&lt;p&gt;Personally, I think Standup, Planning and Retrospective are all valuable activities, Retrospective is especially crucial because it explicitly expect the team to self-adjust/improve. It is important to have a common understanding on what each activities is about, for example, a team might agree that Standup is only to surface keep people in the loop and not for discussion, then the team is responsible on enforcing such constraints.&lt;/p&gt;
&lt;p&gt;These mechanisms exists to help the team to achieve certain goal, and if they are starting to get in the way, we can always adjust.&lt;/p&gt;
&lt;h4&gt;4. Capacity Management&lt;/h4&gt;
&lt;p&gt;Another responsibility most if not all managers have is hiring, I am calling it capacity management as that is closer to the intent. We need to have a good grasp on the team’s capacity and be able to make some forecast to know when to hire.&lt;/p&gt;
&lt;p&gt;To execute this well, we need to know if the team’s demand matches the current capacity or not, you also need to know if there’s any future events that might change this balance, for example, a key member is going for a multi-months leave, or if there’s any upcoming large project.&lt;/p&gt;
&lt;p&gt;Manager also have to drive the interview process, typically there will already be a process in place as that’s how you’re hired in the 1st place, but you might still want to adjust it based on your need.&lt;/p&gt;
&lt;p&gt;I have a few opinions on hiring, I think that when hiring software engineers we should focus on the following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Meet minimum technical requirement. In my line of work this means ability to create software, and have good understanding on computers, over times I am leaning towards normalizing this aspect with candidate’s professional career. If someone is relatively new to the field, it is okay that they know less.&lt;/li&gt;
&lt;li&gt;Clarity in thoughts and communication. In the long run, not able to think and communicate clearly becomes a burden to the team. I find the ability to distill information, ideas or knowledge effectively is a great indicator. It can often reveals one’s ability to reason about different level of abstractions.&lt;/li&gt;
&lt;li&gt;Being reasonable, this means knowing when to compromise between ideal and practical, and able to debate and be convinced with logical arguments.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I havent gain enough data about what’s the best way to interview engineers, so far I think take home exercise with decent complexity plus a review is pretty good. But I’ve also heard complaints that people with a job and family wouldnt want to do that, probably something to test and adjust.&lt;/p&gt;
&lt;h4&gt;5. Manage the talent-domain fit&lt;/h4&gt;
&lt;p&gt;We should also keep an eye of the team formation, do we have a good mix of skills and expertise for the problem on hands. Occasionally, a team might take on new challenges that requires new skills, manager should then try to acquire those skills either by upskilling existing teams or hiring or some other ways.&lt;/p&gt;
&lt;h3&gt;Work/Project management&lt;/h3&gt;
&lt;p&gt;Working on projects seems to be how most team spend their time, it is therefore useful to define how the team should tackle work, and what is the role of manager here.&lt;/p&gt;
&lt;p&gt;Following Andy Grove’s famous book High Output Management, we can think of the output of a manager to be the total output of her team. We should be thinking about how to maximize the output. &lt;/p&gt;
&lt;p&gt;Note: we should also ensure we are working on the right thing, but this topic is too broad and will need its own document.&lt;/p&gt;
&lt;p&gt;There are a handful of things we need to nail.&lt;/p&gt;
&lt;p&gt;First, the team needs to be able to focus, or at the very least manage distractions within an acceptable range. Sometimes, focus means willing to do less at 1 time, in hope to finish things quicker, we should try to allocate more people on tasks until we hit diminishing return. For example, building a new CRUD app can be done by 1, 3, or 5 people, and we might decide 3 is the sweet spot and having 5 people might hurt productivity. &lt;/p&gt;
&lt;p&gt;Letting the team to be able to focus on fewer things have a few consequences. First, people get to build shared context, and shared context is what makes a team great. This will greatly improve system quality and communication bandwidth, the team will be able to ship things quicker in the long run. In many cases, optimizing for shipping earlier over total throughput is better in terms of overall value delivery, assuming you work in a dynamic environment and need to respond to change rather quickly. It also increases bus factor, making delivery more robust and predictable.&lt;/p&gt;
&lt;p&gt;We also need to manage other sources of distractions, for example issues raised by customer, and request from other teams. Feature request is relatively easy to deal with, they fit into regular prioritizing and planning process, bugs and issues are trickier and can easily go out of hands when not being managed. Obviously the best approach is to not ship many bugs, but sometimes you need to deal with the existing circumstance. So far, the most effective approach I’ve used is to allocate X number of people on a rotation to handle these issues, this effectively creates a separate backlog which is not ideal, but it is easier to execute and stick to because it is purely mechanical.&lt;/p&gt;
&lt;p&gt;Another important element is clarity, in my experience, clarity is crucial for productivity. Having a plan allow people to focus on execution, instead of trying to plan while executing. We dont have all knowledge required upfront, this is why we need to plan, plan for the known factors and also the unknown factors, build a common understanding among the team on how to handle unknown.&lt;/p&gt;
&lt;p&gt;While we might not always stick to the plan, the action of planning is crucial here, we should not implement anything non-trivial without a plan.&lt;/p&gt;
&lt;p&gt;Lastly, I want to highlight the need of risk management, from my own painful experience. It is important to think about the risk of the work, and make sure its communicated to relevant people, including stakeholders, doing so gives everyone wiggle room to adjust or change plan later if an idea does not work out.&lt;/p&gt;
&lt;h3&gt;People’s Growth&lt;/h3&gt;
&lt;p&gt;WIP&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Summary of Good Strategy Bad Strategy]]></title><description><![CDATA[Knowing Good Strategy What is strategy? (State the obivous) Strategy is sometime used interchangeable as Plan, but it is actually greater…]]></description><link>https://qingwei91.github.io/books-summary/good-bad-strategy/</link><guid isPermaLink="false">https://qingwei91.github.io/books-summary/good-bad-strategy/</guid><pubDate>Sat, 20 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;Knowing Good Strategy&lt;/h1&gt;
&lt;h2&gt;What is strategy? (State the obivous)&lt;/h2&gt;
&lt;p&gt;Strategy is sometime used interchangeable as Plan, but it is actually greater than that, the book summarize it using 3 components&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Diagnosis&lt;/li&gt;
&lt;li&gt;Guiding Policy&lt;/li&gt;
&lt;li&gt;A set of coherent actions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It is the 3rd point that is the plan, but the 1st and 2nd point are equally important, in my own words, Strategy is a plan made by deliberately consider the challenge and anticipate how environment will react to your action. It is most effective when you exploit some sort of leverage/insights that are unique to you.&lt;/p&gt;
&lt;h2&gt;What is bad strategy? (or Non-strategy trying to disguise as one)&lt;/h2&gt;
&lt;p&gt;There are many bad strategy or really non-strategy that business leaders like to use:&lt;/p&gt;
&lt;h3&gt;Confusing Goals with Strategy&lt;/h3&gt;
&lt;p&gt;Many business leaders confuse goals setting and strategy creation, goal setting states what you want, but strategy needs to provide the how, if leaders fail to articulate how to achieve their goal, they are not doing much better than praying.&lt;/p&gt;
&lt;h3&gt;Fail to define the challenge&lt;/h3&gt;
&lt;p&gt;All strategy should starts with a clearly defined challenge, if you cannot clearly define the challenge, you risk shifting the goal post all the time, losing focus and really not knowing what to optimize for, it becomes a disaster for execution.&lt;/p&gt;
&lt;h3&gt;Bad strategic objectives&lt;/h3&gt;
&lt;p&gt;The book tries to differentiate Goals with Objectives, where goals are high-level and often obvious, for example all for-profit company has a goal to be profitable, where objectives are a breakdown of goals that a level lower and typically reveal a company’s strategy (or the lack thereof).&lt;/p&gt;
&lt;p&gt;Bad strategic objectives are either setting at the wrong level, or just outright bad and does not form coherency with the rest of the objectives or even the original goal. Sometimes its too ambitious, or sometimes it tries to cover everything and makes it impossible to follow and/or execute.&lt;/p&gt;
&lt;p&gt;There’s a key idea here that if the objective set by Leader is not making things easier (ie. increasing the chance of solving the challenge), then the leader is not doing his/her job well.&lt;/p&gt;
&lt;p&gt;Personal note: determining the right level when setting objective is really context-sensitive, and I think being a good leader is to be able to determine the level of granularity needed when strategizing, knowing what is key and what isnt, what needs to be in tight control and what can be delegated or pass to subordinate is key skill of a leader.&lt;/p&gt;
&lt;h3&gt;Why bad strategy happens?&lt;/h3&gt;
&lt;p&gt;Personal note: I think the most obvious reason is that the knowledge Strategy isnt widespread, and most people dont get a chance to practice.&lt;/p&gt;
&lt;p&gt;The book gives the following reason:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Inability to choose, this is a big one, willingness to sarcrifice is something I find important when comes to focus, not able to focus is terrible, and real world sometimes give you a false sense that you can do everything all at once.&lt;/li&gt;
&lt;li&gt;Template style strategy, you can almost call this laziness, basically assumes strategy is just a blank to be filled following some sort of template without thinking critically, one example is that some strategies simply state the obvious without providing additional information.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Leverage&lt;/h3&gt;
&lt;p&gt;Leverage are points that gives an organization outcome that are disproportionate with the input, leverage is fundamental to strategy, in the simplest term, you want to leverage your strength to maximize the outcome. &lt;/p&gt;
&lt;p&gt;One thing that’s important through out the book is the idea of concentrated coordination, it is important for all the actions you do to work towards a common goal and help each other, it sounds easier than done, because its mostly hard work, but when executed correctly it will produce outcome quicker and cheaper.&lt;/p&gt;
&lt;h3&gt;Proximate objectives&lt;/h3&gt;
&lt;p&gt;Proximate objectives are objective that are reachable by the group while simultaneously move us closer to the strategy. This concept further reinforce the idea that leaders need to assess feasibility. This implies the leaders need to be down to earth and they need to know how. Without knowing how, they wont be able to add much value because without knowing how it is hard to consistently set objectives that are both useful and achievable.&lt;/p&gt;
&lt;p&gt;Personal note: Another thing that comes to my mind is to build up your strategic position that opens up possibilities, some strategy takes a long time and a long play to play out, and in the process you are not always working on the end goal directly, but instead you might just be building your position so that you can perform the perfect strike when the time comes, and it is important to figure out the whole plan, understand what activities is to build up strategic advantages versus activities that perform the strike. Good position provides options, but we shouldnt treat generating options a goal though&lt;/p&gt;
&lt;h3&gt;Chain-linked System&lt;/h3&gt;
&lt;p&gt;The book introduces me the idea of Chain-linked system which is really interesting, it is a fragile system where all parts of the chains need to perform for the function to work well. I said its fragile because in software system we tend to call this system with a single failure point, but in business world it can bring in something interesting.&lt;/p&gt;
&lt;p&gt;If your business forms a chain-linked system, it becomes harder to replicate, it is a form of moat. Note that most business form chain-linked system almost naturally, chain-linked system basically means the parts (ie. every link) are closely related to some other parts of the system, and this is usually the case because any complex business requires coordination of different groups of people with different skills and expertise.&lt;/p&gt;
&lt;p&gt;Being able to identify such system and understand bottleneck is useful, and arguably a fundamental benefit you get by learning to think systematically.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[A reflection of my journey as a manager uptill Dec 2021]]></title><description><![CDATA[I wish write down things I’ve learned by being a manager in a systematic way, so that it can be used to guide my future development and…]]></description><link>https://qingwei91.github.io/management/manager-overview/</link><guid isPermaLink="false">https://qingwei91.github.io/management/manager-overview/</guid><pubDate>Sat, 20 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;I wish write down things I’ve learned by being a manager in a systematic way, so that it can be used to guide my future development and execution.&lt;/p&gt;
&lt;h1&gt;Observations&lt;/h1&gt;
&lt;h2&gt;Personal Preferences&lt;/h2&gt;
&lt;p&gt;I learned that I dont like to do things like organizing Team Socials, or organizing meetings, I am not sure if anyone enjoy such activities, but I certainly dont.&lt;/p&gt;
&lt;p&gt;I dont like to spend most of my time fighting complexity with pre-existing software system that I have little context of, it sometimes feel unproductive and pointless, it is not glorious, and I dont take pride doing those work, plus its very taxing and stressful.&lt;/p&gt;
&lt;p&gt;I really enjoy doing system design work, and here system isnt limited to software system, but also organization system, I particularly enjoy the exercise of forming a theory/hypothesis and test it out quickly.&lt;/p&gt;
&lt;h2&gt;Weak area&lt;/h2&gt;
&lt;p&gt;I failed to build a good relationship with a PM, I think it boils down to my refusal to deal with that person, which in a way is saying I am super flexible and sometimes be a bit stubborn, presumably because I think I have choices.&lt;/p&gt;
&lt;p&gt;I am also not doing a good enough job to push back strongly, and can sometimes create false image of agreement, although I dont feel this problem when interacting with most people, I am definitely not able to do it well with certain people, this suggests I need the right environment with the right people to perform well.&lt;/p&gt;
&lt;p&gt;I am good at overriding decision and call for halt on projects, 2 of my biggest mistakes both stem from it, when I delegate, I tend to let delgatee make the call, while I have a gut feeling that’s not the right call, I am always hesitant to make strong intervention. Thinking deeper into this, I think it mostly comes from my desire to rely on working experience over my 10-feet-pole away view. This can work against me occasionally, especially when dealing with less-experienced subordinate. I am not sure if I need to change here, if I were to, I will need to figure out a way to identify when to override with high precision.&lt;/p&gt;
&lt;p&gt;Another failure was my incorrect commitment to an effort that goes nowhere, on my defense, I didnt have enough information to understand where we are going but was still required to do something with it. But I really should have done it better by collaborating better with the team, or to be more risk-averse and dont work on platform-ish improvement. I prefer to not treat this as area of improvement but instead try to get into places that this isnt a big concern, ie. get more autonomy, have enough structure and vision in place so that I can actually plan for future.&lt;/p&gt;
&lt;p&gt;Another major weak area I had was delegation, on hindsight, I made quite a few bad mistakes on not delegating more aggresively, there are a few reasons of it:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Not giving most reactive work to the team because I didnt want to force them to switch context&lt;/li&gt;
&lt;li&gt;Not giving reactive work to the team because they dont have enough context&lt;/li&gt;
&lt;li&gt;Not giving management work to the team because I am worried they cannot handle them&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I think only reason 3 is valid, and 1 and 2 are poor solution, for 1, instead I should let the team share the burden, feel the pain, and then motivate us to fix the underlying issue, really we are underpower and forced to own way too many things. For reason 2, I should let them learn. &lt;/p&gt;
&lt;p&gt;Another issue I had was that I dont know how to delegate when it comes complex issue like project management, there are too many moving parts and I dont always know what to delegate and when to intervene. The best case is to fully delegate and ask delegatee to be accountable for outcome, but not everyone is capable of doing this, maybe I should just not delegate.&lt;/p&gt;
&lt;p&gt;On hindsight, a better model would be to keep a trail of the most complex issue a person had handled, and then based on that determine the task to be delegated.&lt;/p&gt;
&lt;p&gt;I am also not very good at complaining, there are a few important issues that I’ve raised but I didnt communicate its importance enough, I think there’s also a part where I dont want to be too negative, but I think the final outcome is much worse.&lt;/p&gt;
&lt;p&gt;I also failed at distributing the right amount of focus across multiple projects at the same time, I should have delegate stuff that I already know how to do, and spend most of my effort on what I dont know how to do. I think on the project I dont feel and thus not acting like an owner. This insight is important because it might happen in the future on my subordinate too.&lt;/p&gt;
&lt;h2&gt;Strong area&lt;/h2&gt;
&lt;p&gt;I think I am good at designing software system with flexibility in mind, as I tend to care alot on interface and conceptual clarity, but this isnt necessarily the top priority for the business. I need to learn when to apply this.&lt;/p&gt;
&lt;p&gt;I am also quite good at process improvement, I’ve either made or help with a few improvement in the company, I think my approach is mostly emotional driven, I pay a lot of attention to my emotional reaction, if there’s something that does not feel right, I tend to look deeper and analyse it, this opens opportunity to fix them, but doesnt guarantee.&lt;/p&gt;
&lt;p&gt;I think I am also decent at organizing people to reach certain goal, I know how to reduce effort from people and I know how to identify conflict and bring focus to them, in general I am quite good and summarizing.&lt;/p&gt;
&lt;h2&gt;Area of Improvement&lt;/h2&gt;
&lt;todo&gt;
&lt;h2&gt;Management&lt;/h2&gt;
&lt;p&gt;I think (or hope) I’ve learned a few things about Management, borrowing from High Output Management, the output of a manager is the total output of her team. &lt;/p&gt;
&lt;p&gt;I think a manager is expected to meet 2 objectives in general:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Maximize the team’s output to meet business need&lt;/li&gt;
&lt;li&gt;Grow the team to fulfill a greater mission over time&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In order to maximize the team’s output, a manager need to:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Distribute the work according to people’s strength and weaknesses&lt;/li&gt;
&lt;li&gt;Setup a coordination framework so that the team member have common understanding on how to coordinate work&lt;/li&gt;
&lt;li&gt;Set the right goals for the team, that are achievable and impactful&lt;/li&gt;
&lt;li&gt;Provide information and knowledge to the team for them to carry their responsibilities&lt;/li&gt;
&lt;li&gt;Install feedback loop so that the team can know how they are performing and adjust when needed&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In order to grow the team over time, a manager need to:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Understand everyone’s motivation, preferences and cultural bias, essentially build a good model of people&lt;/li&gt;
&lt;li&gt;Understand where the industry is trending towards, have a rough idea on what to invest on&lt;/li&gt;
&lt;li&gt;Install training program for the team&lt;/li&gt;
&lt;li&gt;Determine the team’s long term vision&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Capacity Management&lt;/h3&gt;
&lt;p&gt;One aspect of keeping the operation smooth is to make sure the team has the right capacity, a manager is responsible for staffing. One important thing here is to have a good model of people, including their skill, knowledge and style of working. Remember people are not fungible, this is more important for complex project.&lt;/p&gt;
&lt;p&gt;This is something I still do poorly of, largely being reactive here. I need to develop a way to be more proactive here.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;TODO: develop a system to measure capacity&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;Process Management&lt;/h3&gt;
&lt;p&gt;One of manager’s job is to keep the operation running smoothly. Process is a tool you almost cant avoid, by setting up processes, you setup some level of expectations among team members, and provide some level of predictability into everyone’s day to day life.&lt;/p&gt;
&lt;p&gt;As a new manager, I think the right way of going with it is to start with little processes, experiment and only add process where needed, preferably with consensus.&lt;/p&gt;
&lt;p&gt;I sometimes overlooked a benefit of simple but non-efficient processes, which is the ease of implementation, a process might not be the most efficient one, but if it is alot easier to implement when compared to alternative, it can be quite appealing. One example I have is the way a team deal with Escalation ticket, at the very beginnig I was pretty much against the idea of fix allocation to deal with issue, for example every Friday is bug day, because it ignores a lot of intricacy in real world, like not all bugs are equal, and many bugs take more than 1 day to complete, but I am now changing my view and see it as a legit approach due to its simplicity in implementation. I still think it is not great, but there are cases where it can work great when you dont have enough attention to fix it&lt;/p&gt;
&lt;h3&gt;Goal and Priority Management&lt;/h3&gt;
&lt;p&gt;As a manager, you’re responsible for the output of the team, its your responsibility to understand and/or determine the most important objectives for the team, one needs to manage multiple dimensions of it.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Determine the impact and importance of different objectives&lt;/li&gt;
&lt;li&gt;Ensure their feasibility and risk, and manage them accordingly&lt;/li&gt;
&lt;li&gt;Understand how each objectives relates to each other and fit into the bigger picture&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;IMO, a tech company (or any company that I want to work with) should pursue 2 traits:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Innovation, the ability to create new stuff, or new method to differentiate one with competitors&lt;/li&gt;
&lt;li&gt;Leverage compound effect, the ability to build advantage by making use of prior resources&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;People Management&lt;/h3&gt;
&lt;p&gt;A manager is also generally expected to help with subordinate’s growth, there are a few parts of it&lt;/p&gt;
&lt;h4&gt;Mentoring/Training&lt;/h4&gt;
&lt;p&gt;In general, it is better for a manager to actually know how, so that one can help improve your subordinate’s skills and knowledge by mentoring. There are situation where this isnt the case, in such cases I’ve tried to learn the domain and failed miserably, I think the right thing to do is to trust the expert and manage by listening and delegation, focus on the outcome and let the expert to figure the how.&lt;/p&gt;
&lt;h4&gt;The feedback loop&lt;/h4&gt;
&lt;p&gt;Part of managing people is really to manage their expectations ,and to communicate your expectations of them to them, and stick to it. Be clear what is rewarded and what is being punished for, be consistent, and this will help people to grow or maintain at a level you need them to.&lt;/p&gt;
&lt;h4&gt;Build a good model of every reportee&lt;/h4&gt;
&lt;p&gt;I think a key about being a good manager is to understand your reportee to a good enough level. That includes understanding how they react to complexity, ambiguities and uncertainty. Understand their preferences, communication style and openness, understand their motivation is important and it helps you get the most value out of them.&lt;/p&gt;
&lt;h4&gt;Build a trusting environment&lt;/h4&gt;
&lt;p&gt;There are many reasons why trust is important, but personally it is simply an environment I want to be in. From a practical viewpoint, the more complex and ambiguous the works are, the more trust we need within the group so that people support and cover each other when needed. You want a team that people are willing to do extra when needed.&lt;/p&gt;
&lt;h3&gt;Technology advancement&lt;/h3&gt;
&lt;p&gt;Should a manager focus on keeping on top of technology advancement? How?&lt;/p&gt;</content:encoded></item><item><title><![CDATA[The cost of using an event streaming model to share state]]></title><description><![CDATA[The problem of sharing state This article expresses my thoughts on Event Streaming approach for sharing state. It is largely based on my…]]></description><link>https://qingwei91.github.io/learnings/event-streaming-cons/</link><guid isPermaLink="false">https://qingwei91.github.io/learnings/event-streaming-cons/</guid><pubDate>Fri, 12 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;The problem of sharing state&lt;/h1&gt;
&lt;p&gt;This article expresses my thoughts on Event Streaming approach for sharing state. It is largely based on my limited experience.&lt;/p&gt;
&lt;p&gt;Let’s start by defining the high-level problem.&lt;/p&gt;
&lt;p&gt;In modern software system, with ever-increasing complexity, it is very common for different parts of the system to share/exchange information, I am going to frame it as &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;State sharing problem in distributed system&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There are a few key components in this problem:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;State implies change, ie. the information that are being shared are dynamic, they changes over time&lt;/li&gt;
&lt;li&gt;Information need to be shared between components across network, in many cases, the components might be owned by different groups&lt;/li&gt;
&lt;li&gt;Information need to be shared in a timely manner, with minimum downtime&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Sharing state in distributed system is a well-studied field, in fact it pretty much define the field, however today I want to put some focus on the social aspect of it, and explore how information sharing mechanims affects day to day operation beyond CAP theorem.&lt;/p&gt;
&lt;h2&gt;My experience so far&lt;/h2&gt;
&lt;p&gt;I’ve experienced event-driven approach once, and it was quite troublesome for the org. We made a few mistakes:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Keeping data in Postgres while simultaneously using events for state sharing, this is a mistake because the org relies heavily on adhoc modification on DB level to fix issues, the database wasnt clean.&lt;/li&gt;
&lt;li&gt;Not having clearly defined contract on the event interface, this has made things hard to change when the expected behavior isnt clar&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Sharing state on demand via request-response model&lt;/h2&gt;
&lt;p&gt;In my experience, this way of sharing information is the most common way of sharing information. There are different ways of implementing it, it can HTTP, GRPC or SOAP protocol, the point being that information are being shared when consumer of information has a demand, its demand driven.&lt;/p&gt;
&lt;p&gt;There are also quite a bit of implicit assumption that goes into such model, its not always stated but pretty much assumed in most use cases:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Information provider provides the contract of data model, wherea information consumer depends on it&lt;/li&gt;
&lt;li&gt;If a request failed, consumer can try to call it again sometime later&lt;/li&gt;
&lt;li&gt;Information provider can make changes to the data model without coordination as long as its not breaking changes, what is consider breaking change depends on contract, but typically adding new information is not considered a breaking change, whereas removing is considered one&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Sharing state by publish subscribe model&lt;/h2&gt;
&lt;p&gt;Another way of sharing state is via publish-subscribe model, where the information provider publishes messages, and consumer subscribe to messages.&lt;/p&gt;
&lt;p&gt;A key defining feature of this method is that actions are triggered by provider instead of consumer, ie. its supply driven and not demand driven.&lt;/p&gt;
&lt;p&gt;This approach has a lot of benefits, one key thing being that consumers can react to information change which isnt possible in request response model, and this approach fits many use-cases when consumer need to react to changes.&lt;/p&gt;
&lt;p&gt;But there’s an important difference when compared to the request response model, publish-subscribe model impose a stricter constraints on information provider.&lt;/p&gt;
&lt;p&gt;In request response model, the information shared are typically consider transient, meaning it is normally only valid within a session, while the consumer is free to maintain a local copy (eg. a cache), the local should be treated as non-essential. This means if something gone wrong, the recovery can be as simple as follow:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Provider fix their data&lt;/li&gt;
&lt;li&gt;Consumer fetch data again and optionally rebuild their local copy&lt;/li&gt;
&lt;li&gt;Problem fixed&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;However, when using a publish-subscribe model, things are more complicated, because data provider only provides an update when there’s a change, it is generally assumed that consumer need to maintain a local copy that is essential for its operation, so when there’s a bad message, it is not clear how to fix it.&lt;/p&gt;
&lt;p&gt;In theory, we can make it as simple as request response model by doing 2 things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Contain full state in the message, and not delta&lt;/li&gt;
&lt;li&gt;Expect all subscribers to treat message as transient&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Then, when things gone wrong, the publisher can just force publish messages and consumer will get the new info and recover&lt;/p&gt;
&lt;p&gt;But in my experience, this is not always the case, there are technological reason and also adhoc reason, for one, if subscriber receive a broken message, its not always clear how it should handle it, and more often than not, the consumer will break. This is less of a concern for request response model, because failure mode tends to be more straightforward in those cases, chances are the consumer will retry of propagate the failure to upstream because its demand driven.&lt;/p&gt;
&lt;p&gt;But in a publish-subscribe model, there are more possibilites, and thus requires more coordination to do the right thing, a subscriber can choose to keep reprocess the message, ignore it, or throw it into a dead-letter queue, and the right decision depends on the contract by the provider.&lt;/p&gt;
&lt;p&gt;I feel like part of the problem is that publish-subscribe model is inherently more powerful, and thus are more likely to get wrong, and as a design principle we should avoid it unless necessary, many state sharing problem can be solved by request response model just fine, it might not be the most efficient approach but unless you’re dealing with a lot of information, it is probably fine.&lt;/p&gt;
&lt;p&gt;If you really need to implement some sort of publish subscribe model, how to recover from failure should absolutely be one of your top consideration, it is very hard to retrofit such thing.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Thoughts on organization structure]]></title><description><![CDATA[What is organization structure? Organization structure refers to the way we group people in an organization.
This grouping decides some of…]]></description><link>https://qingwei91.github.io/thoughts/structure/</link><guid isPermaLink="false">https://qingwei91.github.io/thoughts/structure/</guid><pubDate>Mon, 08 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;What is organization structure?&lt;/h2&gt;
&lt;p&gt;Organization structure refers to the way we group people in an organization.
This grouping decides some of the most important thing in an organization.&lt;/p&gt;
&lt;p&gt;The group is typically implemented using abstract concepts plus a set of mechanism, for example members in Marketing are grouped together by the team name, and assigned with relevant responsibilities, and the team tends to have well established communication channel and pattern, and there’s probably also some scheduled meetings every now and then.&lt;/p&gt;
&lt;h3&gt;Cost of communication&lt;/h3&gt;
&lt;p&gt;An organization typically exists to producing something, either products or services. And it provides them by carry out activities. The need of organization is based on the fact that the final outcome requires combination and/or coordination of multiple activities, ie. it cannot be done by a single person while meeting the needs.&lt;/p&gt;
&lt;p&gt;As a results, coordination is inevitable, and as organizations scale, it tends to be one of the biggest cost.&lt;/p&gt;
&lt;h2&gt;Goals of organization structure&lt;/h2&gt;
&lt;p&gt;The goals of organization should be &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;to optimize to reduce global communication cost&lt;/li&gt;
&lt;li&gt;to encourage innovation by reducing communication cost among people that have similar interest or can form synergy&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In order to achieve them, the designer needs a few bits of knowledge:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;How information flow through the organization, and understand where is the bottleneck and where do we have untap capacity (potential waste)&lt;/li&gt;
&lt;li&gt;Which group of people when grouped together can have better synergy&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;One way to look at Communication is to treat it as information flow, I’d like to think of information flow as a stream, the upstream and downstream needs to coordinate and have similar capacity so that the flow is smooth, when there’s huge imbalance then it results in waste. As a leader/org designer, you need to see the workflow yourself to fully understand the situation.&lt;/p&gt;
&lt;p&gt;To give an example, in a software development workflow, Product Manager typically perform the function of gathering client requirements and share it with Engineering Team, if Product Manager is not producing the requirement fast enough, it indicates Product Manager is the bottleneck. Or if Product Manager produces more information than Engineering Team can digest and process, then bottleneck is on Engineering Team. This is not always an organization problem, sometimes its just a capacity problem, ie. you dont have enough manpower.&lt;/p&gt;
&lt;p&gt;There might also be ways to measure communication effectiveness but I’ve never seen it put in place, and I am skeptical about its effectiveness.&lt;/p&gt;
&lt;p&gt;On 2nd point, to group people to exploit synergy, I think this is the most interesting part of the design. &lt;/p&gt;
&lt;p&gt;In a business there are typically multiple activities that when coordinated produce Value Streams, there can be a single or multiple Value Streams in a business.&lt;/p&gt;
&lt;p&gt;Value Streams requires coordination of, and coordination implies communication. The game here is to figure out ways to group people that maximize their value or strength, and minimize integration risk.&lt;/p&gt;
&lt;p&gt;For example:
&lt;img src=&quot;../../assets/value-stream.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;Here I sketched out the value stream of software creation, let’s assume you have multiple value streams running at the same time. We can then think about different strategy to organize people.&lt;/p&gt;
&lt;p&gt;There are a few dimensions to consider:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Expertise, we need to make sure people are leveraging their skills and expertise&lt;/li&gt;
&lt;li&gt;Communication cost&lt;/li&gt;
&lt;li&gt;Integration risk&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I’d like to elaborate on communication cost and integration risk, they are really 2 side of the same coin, the goal here is to reduce complexity at integration point, the simpler the integration point/process/interface is, the less risk and the smaller the communication cost is.&lt;/p&gt;
&lt;p&gt;This means we should encapsulate complex process closely together, and aim to provide simple interface whenever some sort of context boundary.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Forming thoughts on how to run Software Teams]]></title><description><![CDATA[Goal I wish to produce a framework on describe how software development should be managed and its relationship to other departments in an…]]></description><link>https://qingwei91.github.io/thoughts/process/</link><guid isPermaLink="false">https://qingwei91.github.io/thoughts/process/</guid><pubDate>Mon, 08 Nov 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;Goal&lt;/h1&gt;
&lt;p&gt;I wish to produce a framework on describe how software development should be managed and its relationship to other departments in an organization.
It will mainly be drawn from my experience and thus be biased, but I will try to challenge myself so that I avoid making blanket statement.&lt;/p&gt;
&lt;h2&gt;Guiding questions&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;How to run software development, Waterfall, Kanban, Scrum&lt;/li&gt;
&lt;li&gt;How to run software research?&lt;/li&gt;
&lt;li&gt;How should Product and Engineering collaborate and engage?&lt;/li&gt;
&lt;li&gt;How should software development team report?&lt;/li&gt;
&lt;li&gt;How should software development team evaluate self?&lt;/li&gt;
&lt;li&gt;How should a tech company organize itself? (what is a tech company)&lt;/li&gt;
&lt;/ol&gt;
&lt;h1&gt;Core concepts&lt;/h1&gt;
&lt;h2&gt;Software company&lt;/h2&gt;
&lt;p&gt;Let’s categorize Software Companies as companies that build focus on delivering value by building and operating Software Product.&lt;/p&gt;
&lt;h2&gt;Typical Process&lt;/h2&gt;
&lt;p&gt;Software company is a very broad categories, I will hereby arbitrarily define the key competency of Software Company as being able to iterate quickly to test different hypothesis.&lt;/p&gt;
&lt;h3&gt;Idea Generation&lt;/h3&gt;
&lt;p&gt;This is a creative process, sometimes people identify a problem that isnt obvious, sometimes people come up with a solution to a long-standing problem.&lt;/p&gt;
&lt;p&gt;Creative process is difficult if not impossible to be converted into pure algorithm, but I think its worth to point out some conditions that can help:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Good understanding on the business, this is obvious.&lt;/li&gt;
&lt;li&gt;Common understanding on the business among people, this might be less obvious, I hypothesize that cost of communication has a big impact on group’s creativity, they need to have enough of shared contexts to be able and willing to build ideas on top of each others, if sharing an idea requires sharing 20 other concepts as a pre-requisite, people will prefer to not talk about it or keep it to themselves.&lt;/li&gt;
&lt;li&gt;Willingness to challenge ideas, even from authority, good ideas withstand scrutiny.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Idea refinement&lt;/h3&gt;
&lt;p&gt;This is an operational process, it is more rigid and typically discipline is more important.
We need to figure out how to convert the idea into actionable plan&lt;/p&gt;
&lt;h2&gt;My random thoughts&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Efficient organization should be organized like clean code, leader should be able to use people like an API, where implementation details are hidden, and only results are reported back&lt;/li&gt;
&lt;li&gt;Code architecture is more important than code style&lt;/li&gt;
&lt;li&gt;Sometimes you have to make decision without all information you need, this is almost always better than not making decision&lt;/li&gt;
&lt;li&gt;The fundamental benefits of software is that software is extremely malleable, and we should focus on flexibility when building software&lt;/li&gt;
&lt;li&gt;Ability to write well is key to scaling engineering organization&lt;/li&gt;
&lt;li&gt;Knowledge is one of the most important asset of a software engineering organization, organization should have a strategy to store, retrieve, and communicate knowledge, and code is NOT the best way &lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[A failed attempt to visualize linearizability check]]></title><description><![CDATA[Lately, I am learning  algorithm, which is a kind of algorithm to check if a particular system is linearizable or not. Informally, a system…]]></description><link>https://qingwei91.github.io/learnings/rec-scheme-for-tree/</link><guid isPermaLink="false">https://qingwei91.github.io/learnings/rec-scheme-for-tree/</guid><pubDate>Sun, 12 Jan 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Lately, I am learning &lt;code class=&quot;language-text&quot;&gt;Linearizability check&lt;/code&gt; algorithm, which is a kind of algorithm to check if a particular system is linearizable or not.&lt;/p&gt;
&lt;p&gt;Informally, a system is linearizable if concurrent operations against the system can be arranged in a sequential way (called lineage) such that the lineage is &lt;strong&gt;consistent&lt;/strong&gt; with a sequential model of the system.&lt;/p&gt;
&lt;p&gt;That’s quite a mouthful, it might be easier to grasp by using examples, say you have a system X that is capable of storing an integer value (ie. a registry), and 2 clients A, and B that can read and write the value.&lt;/p&gt;
&lt;p&gt;Below is the operations that A and B execute respectively.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;A&lt;/th&gt;
&lt;th&gt;B&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Set 2&lt;/td&gt;
&lt;td&gt;Set 3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Read 2&lt;/td&gt;
&lt;td&gt;Read 3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Read 3&lt;/td&gt;
&lt;td&gt;Set 1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Let’s assume operations within a process needs to happens in the given order, but operations between processes can happen in any order, and our goal is to find a specific order that is consistent with a sequential model, for example&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;A Set 2 -&gt; B Set 3 -&gt; B Read 3 -&gt; A Read 2 -&gt; A Read 3 -&gt; B Set 1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;is a lineage that is not correct because we should not be reading &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt; at the 4th operation, it should be &lt;code class=&quot;language-text&quot;&gt;3&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;A Set 2 -&gt; A Read 2 -&gt; B Set 3 -&gt; B Read 3 -&gt; A Read 3 -&gt; B Set 1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;is a valid lineage.&lt;/p&gt;
&lt;p&gt;If we are able to find a lineage that is correct, then the history is linearizable, note that this does not means that the system is linearizable, like all example based test, linearizable test is not able to proof there’s no bug, nevertheless it is still very useful.&lt;/p&gt;
&lt;h2&gt;How it works?&lt;/h2&gt;
&lt;p&gt;There are many different algorithms to test for linearizability.&lt;/p&gt;
&lt;p&gt;Essentially, it is a kind of Constrained Satisfiable Problem, some smart people managed to prove that it is a NP-hard problem.&lt;/p&gt;
&lt;p&gt;The algorithm is about how to find a valid lineage in a massive search space.&lt;/p&gt;
&lt;p&gt;Like many search algorithm, it can leverage backtracking, here’s the logic.&lt;/p&gt;
&lt;p&gt;The input is a collection of operations called &lt;code class=&quot;language-text&quot;&gt;history&lt;/code&gt;, each operation contains&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;request&lt;/li&gt;
&lt;li&gt;response&lt;/li&gt;
&lt;li&gt;requestor (eg. process id)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We also need a &lt;code class=&quot;language-text&quot;&gt;sequential model&lt;/code&gt;, which specify how the system under test should behaves if all operations happen sequentially. For the logic below, we will assume model is immutable, and every operation produces a new model&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lin_check&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;history&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; model&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; linearized&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; history&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;finished&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; linearized
    minOps &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; history&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getMinOps

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; minO &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; minOps&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;updatedModel&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; model&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minO&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;matches&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minO&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;response&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;# recursively check until it terminates&lt;/span&gt;
            res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lin_check&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                history&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;remove&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minO&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
                updatedModel&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
                linearized&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;minO&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;notErr&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; res
            &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; error&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Nothing works&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;minimumOps is a list of operations that are possible to be the next operation, this means the operation cannot happen AFTER any of operation in  &lt;code class=&quot;language-text&quot;&gt;history&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;This is a backtracking algorithm, it performs a depth 1st search and backtracks if it reaches failure, to try the next possible operation.&lt;/p&gt;
&lt;p&gt;One challenge is that it is hard to tell if I implemented it correctly, I decided to visualize it.&lt;/p&gt;
&lt;h2&gt;My plan&lt;/h2&gt;
&lt;p&gt;Web is the best UI platform that I know about, thus I decided to start from there.&lt;/p&gt;
&lt;p&gt;The idea is to visualize the search as&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Things to consider when building distributed system]]></title><description><![CDATA[Define Distributed System (Informally) In this document,  refers to Stateful software systems where there exists at least 1 operation that…]]></description><link>https://qingwei91.github.io/system-design/distributed-system/</link><guid isPermaLink="false">https://qingwei91.github.io/system-design/distributed-system/</guid><pubDate>Mon, 23 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Define Distributed System (Informally)&lt;/h2&gt;
&lt;p&gt;In this document, &lt;code class=&quot;language-text&quot;&gt;Distributed Systems&lt;/code&gt; refers to &lt;strong&gt;Stateful&lt;/strong&gt; software systems where there exists at least 1 operation that involves network call. In practice, distributed systems are normally concurrent.&lt;/p&gt;
&lt;h2&gt;Things to consider&lt;/h2&gt;
&lt;h3&gt;Consistency model&lt;/h3&gt;
&lt;p&gt;Consistency models attempt to answer the following question:&lt;/p&gt;
&lt;p&gt;Does our system preserve orders of operations? Under what constraints. Eg. If we write &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, then &lt;code class=&quot;language-text&quot;&gt;B&lt;/code&gt; into a registry, are we guaranteed to observe the data in the same sequence?&lt;/p&gt;
&lt;p&gt;This is important because in a stateful system, order of operations affect the state. In general, &lt;code class=&quot;language-text&quot;&gt;Operation A, Operation B&lt;/code&gt; is not equal to &lt;code class=&quot;language-text&quot;&gt;Operation B, Operation A&lt;/code&gt;. It is useful for participants of the system to be able observe operations in correct order.&lt;/p&gt;
&lt;p&gt;There are many different consistency models, eg&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Linearizability&lt;/li&gt;
&lt;li&gt;Sequential consistency&lt;/li&gt;
&lt;li&gt;Read your writes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;and many more, &lt;a href=&quot;https://jepsen.io/consistency&quot;&gt;aphyr&lt;/a&gt; documented a lot of them&lt;/p&gt;
&lt;p&gt;Consistency model is likely one of the most complicated part of a distributed system, not only because the vast number of different models, but also because it tends to span across multiple operations, when talking about consistency model, we are talking about how multiple operations interact with a state, and what kind of guarantee are we giving to each of those operations.&lt;/p&gt;
&lt;h3&gt;Synchronous vs Asynchronous&lt;/h3&gt;
&lt;p&gt;Here I am referring to the &lt;code class=&quot;language-text&quot;&gt;user interaction&lt;/code&gt; with our system, if user have to wait for a result, then the interaction is synchronous, if user does not need to wait for result, then it is asynchronous.&lt;/p&gt;
&lt;p&gt;Normally, synchronous interaction implies stronger requirement in terms of latency, as we normally want to minimize wait time of our user.&lt;/p&gt;
&lt;p&gt;Note: Different operations in a system can have different interaction mode&lt;/p&gt;
&lt;h3&gt;Atomicity&lt;/h3&gt;
&lt;p&gt;Atomicity guarantee an operation either completed or never happen, there should be no &lt;code class=&quot;language-text&quot;&gt;observable&lt;/code&gt; intermediate state.&lt;/p&gt;
&lt;p&gt;In the context of distributed system, it is not uncommon to have partial failure, eg. if an operation requires 2 stateful network call to complete it’s job, what should we do if 1 call succeeded and the other failed?&lt;/p&gt;
&lt;p&gt;This problem is fairly difficult to solve, and solution likely depends on your problem domain, possible solution includes 2PC, Saga Pattern.&lt;/p&gt;
&lt;h3&gt;Dependency of system time&lt;/h3&gt;
&lt;p&gt;Be aware on dependency of system time, in theory distributed system should rely on system time for correctness, but it is ok to depend on system time for other purpose like live-ness or debugging. We just need to keep in mind that clock drift is real.&lt;/p&gt;
&lt;h3&gt;Availability&lt;/h3&gt;
&lt;p&gt;Availability refers to the ability of the system to continue it’s operation even when part of the system is down.&lt;/p&gt;
&lt;h3&gt;Timeout&lt;/h3&gt;
&lt;p&gt;In distributed system, it is inevitable to have timeout, because network partition can happen anytime. Timeout brings a lot of complexity to our system because when an operation timed out on the caller, the operation might actually finished, or failed on the callee, or worse it might finished later, which the caller has no visibility at all.&lt;/p&gt;
&lt;h3&gt;Idempotency&lt;/h3&gt;
&lt;p&gt;It is typically for client to retry, thus it is crucial for api to be idempotent.&lt;/p&gt;
&lt;h2&gt;Trade off&lt;/h2&gt;
&lt;p&gt;In general, the stronger the consistency model you need, the worse throughput, latency and availability you will get.&lt;/p&gt;
&lt;p&gt;If you need extra mechanism to enforce atomicity, it is likely to worsen throughput, latency and availability too.&lt;/p&gt;
&lt;h2&gt;Checklist&lt;/h2&gt;
&lt;p&gt;This is a list of questions to ask when building distributed system:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;What happen if your system have network partition between your servers?&lt;/li&gt;
&lt;li&gt;What happen if multiple operations interleave with each other? (Concurrency)&lt;/li&gt;
&lt;li&gt;What happen if a message is delivered multiple times?&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[Summary of Business Dynamics]]></title><description><![CDATA[Chapter 1 In complex system, one cannot just do 1 thing, and everything is connected with everything  learning about complex systems while…]]></description><link>https://qingwei91.github.io/books-summary/business-dynamics/</link><guid isPermaLink="false">https://qingwei91.github.io/books-summary/business-dynamics/</guid><pubDate>Fri, 20 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Chapter 1&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;In complex system, one cannot just do 1 thing, and everything is connected with everything &lt;/li&gt;
&lt;li&gt;learning about complex systems while living in them is difficult&lt;/li&gt;
&lt;li&gt;System dynamics is interdisciplinary&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[Make backtracking algorithm cancellable (Scala)]]></title><description><![CDATA[This article is a follow up for my previous post: How to make a loop cancellable?, in previous post we discussed a special loop construct to…]]></description><link>https://qingwei91.github.io/cancel-loop/backtracking/</link><guid isPermaLink="false">https://qingwei91.github.io/cancel-loop/backtracking/</guid><pubDate>Wed, 18 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;This article is a follow up for my previous post: &lt;a href=&quot;../&quot;&gt;How to make a loop cancellable?&lt;/a&gt;, in previous post we discussed a special loop construct to make a long running loop cancellable. &lt;/p&gt;
&lt;p&gt;In this post, I will show how to make a recursive backtracking algorithm cancellable. I wrote this post specifically for backtracking algorithm because backtracking algorithm is not tail recursive, so it is not obvious how to apply non-tail-rec algorithm to the &lt;code class=&quot;language-text&quot;&gt;cancellableLoop&lt;/code&gt; we created earlier.&lt;/p&gt;
&lt;p&gt;Side note: I bumped into this problem when implementing a &lt;a href=&quot;https://github.com/qingwei91/lolipop/blob/test-distributed-system/core/src/test/scala/raft/proptest/checker/LinearizationCheck.scala#L52&quot;&gt;linearizability checker&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;What is backtracking?&lt;/h2&gt;
&lt;p&gt;Backtracking is a technique commonly found in algorithm with a huge search space, the idea is that when the algorithm is exploring the search space, if there is sufficient information to indicate a subpath and all of subsequent paths are invalid, then those path can be skip by returning the control (and possibly the error) to the previous step, this action of returning control to previous step is called backtrack. It is typically used as a form of optimization.&lt;/p&gt;
&lt;p&gt;One way think about it is to visualize a search space as a tree, and the goal is to find specific path (or node) in the tree based on some condition, eg.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;     E
    /  \ 
   A    P
  / \   / \
 O  Q  U   L&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If there exhibit some inductive property that allow us to invalidate a subtree without fully exploring it, then we can prune the search space and improve efficiency.&lt;/p&gt;
&lt;p&gt;For example, with the tree above, try to find a path starting from &lt;code class=&quot;language-text&quot;&gt;root&lt;/code&gt; where all nodes are vowel. We are starting with &lt;code class=&quot;language-text&quot;&gt;E&lt;/code&gt;, which is a vowel, next we will try the paths. If we start with the right hand path, which is &lt;code class=&quot;language-text&quot;&gt;P&lt;/code&gt;, notice that &lt;code class=&quot;language-text&quot;&gt;P&lt;/code&gt; is not a vowel, then we can skip all path after &lt;code class=&quot;language-text&quot;&gt;P&lt;/code&gt;, (ie. P-U, P-L), and instead try a different path.&lt;/p&gt;
&lt;p&gt;Backtracking algorithms are normally expressed in a recursive way as the general pattern is to try a path and if it does not work, try another path, where each step is recursive. &lt;/p&gt;
&lt;p&gt;They are also not tail-recursive as tail recursive indicate there is no way to return control to a previous step.&lt;/p&gt;
&lt;p&gt;The entry on wikipedia for &lt;a href=&quot;https://en.wikipedia.org/wiki/Backtracking&quot;&gt;Backtracking&lt;/a&gt; is very comprehensive, please refer to it if you like to know more.&lt;/p&gt;
&lt;h3&gt;How recursion works?&lt;/h3&gt;
&lt;p&gt;Before get into solution, it is useful to revisit how recursion actually works under the hood.&lt;/p&gt;
&lt;p&gt;Recursion works by having a function that calls itself. Function calls are typically managed by programming language using stack data structure, called the call stack. &lt;/p&gt;
&lt;p&gt;Each call is modelled by a stack frame, that contains the parameter of the function call, the actual function code, and a return address.  When the language runtime process a stack frame, it does something like the following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Compute the result using function params and code from the stack frame&lt;/li&gt;
&lt;li&gt;Pop the stackframe from the call stack&lt;/li&gt;
&lt;li&gt;Return the result to the return address&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;A recursive function is a function that repeatedly push stackframes to the call stack, which is why it can sometime cause stack overflow.&lt;/p&gt;
&lt;h3&gt;Cancellable backtracking algorithm&lt;/h3&gt;
&lt;p&gt;Reminder: to make an loop cancellable, we are using the function below that was discussed in &lt;a href=&quot;../&quot;&gt;previous post&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cancellableLoop&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    step&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopCtx &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Either&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;init&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; cs&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ContextShift&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; monad&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Monad&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        cs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;shift&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flatMap&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_ &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        step&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cont&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cont&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Right&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pure&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;init&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We will try to solve the problem of &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Finding a path in a binary tree where every node is a vowel letter.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Note: The input is a binary tree and every node has 2 children, and it is not ordered&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; Tree
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Node&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Tree&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Tree&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Tree
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Leaf&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/*
 * Return type is Option[List[Char]]
 * - None if there is no such path
 * - Some(ls) if there is at least 1 path that match our condition
 */&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; findAllVowelPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tree&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Tree&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Option&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  tree &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Node&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isVowel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; resultA &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; findAllVowelPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        resultA &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vowelsA&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt; vowelsA&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
            &lt;span class=&quot;token comment&quot;&gt;// point of backtracking&lt;/span&gt;
            findAllVowelPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;vowelsB&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt; vowelsB&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
              &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; None
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        None    
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Leaf&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isVowel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt; Nil&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      None
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The code above is a tree traversal algorithm, it tries to traverse a tree. When it finds a non-vowel character, it &lt;code class=&quot;language-text&quot;&gt;returns the control&lt;/code&gt; to the previous step by returning a None, if it find a vowel character, it will save the value, once it reach the end of a sub-tree, it returns all vowel characters collected when traversing.&lt;/p&gt;
&lt;p&gt;Our goal is to transform this recursive method into a shape that fits &lt;code class=&quot;language-text&quot;&gt;cancellableLoop&lt;/code&gt; signature, which looks like this: &lt;code class=&quot;language-text&quot;&gt;LoopCtx =&gt; Either[LoopCtx, A]&lt;/code&gt;, as discussed earlier, this type signature expresses recursion.&lt;/p&gt;
&lt;p&gt;We can first determine the concrete type of &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, it is the result type we want, so it will be &lt;code class=&quot;language-text&quot;&gt;Option[List[Char]]&lt;/code&gt;. &lt;/p&gt;
&lt;p&gt;What should &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt; be? For this step function to work, &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt; needs to fulfill the following requirements:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Contain all data needed to perform a step, ie. it needs to have &lt;code class=&quot;language-text&quot;&gt;Tree&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;It needs to allow backtracking, remember backtracking is the action to return control and result to previous step, so that previous step can continue a different path.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;  We can leverage the knowledge we learned from how recursion works, in essence, we need to manage the call stack using the &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt; type. &lt;/p&gt;
&lt;p&gt;  Assuming we are talking about recursion in terms of 2 steps, the &lt;code class=&quot;language-text&quot;&gt;previous&lt;/code&gt; step and the &lt;code class=&quot;language-text&quot;&gt;current&lt;/code&gt; step, then previous step is responsible to create a return address (or multiple depends on your algorithm) and current step will have to return the result using the return address provided. &lt;/p&gt;
&lt;p&gt;let’s try to define the step function&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; LoopContext

&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Root&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tree&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Tree&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; LoopContext

&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PathA&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tree&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Tree&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; prevContext&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopContext&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; accVowels&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; LoopContext

&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PathAFailed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prevContext&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; LoopContext

&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PathB&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tree&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Tree&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; prevContext&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopContext&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; accVowels&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; LoopContext

&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; PathBFailed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prevContext&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; LoopContext
 
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Either&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;LoopContext&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Option&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;List&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Char&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ctx &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Root&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tree&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        tree &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Node&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
              &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isVowel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathA&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                Right&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;None&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;    
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Leaf&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isVowel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              Right&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt; Nil&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              Right&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;None&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; curr&lt;span class=&quot;token annotation punctuation&quot;&gt;@PathA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tree&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; prev&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; accVowels&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
        tree &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Node&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
              &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isVowel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathA&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; curr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; accVowels &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathAFailed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prev&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tree&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Leaf&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;isVowel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              Right&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;accVowels &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathAFailed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;prev&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tree&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; PathAFailed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;curr&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        curr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tree &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathB&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; curr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; accVowels &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;


    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[How to make a loop cancellable? (Scala)]]></title><description><![CDATA[Problem: I have a long running loop that I wish to cancelled if it does not finished after X seconds. Solution 1: Bake termination condition…]]></description><link>https://qingwei91.github.io/cancel-loop/</link><guid isPermaLink="false">https://qingwei91.github.io/cancel-loop/</guid><pubDate>Sun, 08 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h3&gt;Problem:&lt;/h3&gt;
&lt;p&gt;I have a long running loop that I wish to cancelled if it does not finished after X seconds.&lt;/p&gt;
&lt;h3&gt;Solution 1: Bake termination condition into our loop&lt;/h3&gt;
&lt;p&gt;It turns out to be an interesting problem for me, as I never had such need until recently.&lt;/p&gt;
&lt;p&gt;The simplest solution would be to code the logic into the loop, eg.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; loop&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stopsAfter&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; start&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Instant &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Instant&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;now&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;after&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;stopsAfter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; Instant&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;now&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; NonTerminatingError&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// do your thing&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In each loop, we can check if loop had run too long, and terminates if it had executed for too long. Below are some pros and cons of the approach&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Flexible on termination condition, as you can do whatever you want in your loop&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;This is not a generic solution, for every loop that you want to cancel, you have to make similar ad-hoc change to you loop&lt;/li&gt;
&lt;li&gt;This is not really cancellation/interruption, as there is no way to signal the loop to stop after the loop has started&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is not as flexible as I would like it to be, let see how we can do better.&lt;/p&gt;
&lt;h3&gt;Solution 2: Leverage IO which are cancellable&lt;/h3&gt;
&lt;p&gt;The 1st approach isn’t great, we want something more general.&lt;/p&gt;
&lt;p&gt;It turns out some Effect types in Scala support cancellation, we will leverage &lt;a href=&quot;https://typelevel.org/cats-effect/datatypes/io.html&quot;&gt;IO from cats-effect&lt;/a&gt; in this article. &lt;/p&gt;
&lt;p&gt;IO monad has auto-cancellable &lt;code class=&quot;language-text&quot;&gt;flatMap&lt;/code&gt; chain if there’s a logical fork in your IO, for example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; retryIfNone&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;innerIO&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; IO&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Option&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; IO&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  innerIO&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flatMap &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
      println&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;something&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// used to show some output when testing &lt;/span&gt;
      IO&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pure&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; 
      println&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;nothing&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// used to show some output when testing&lt;/span&gt;
      retryIfNone&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;innerIO&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The method above call itself until &lt;code class=&quot;language-text&quot;&gt;innerIO&lt;/code&gt; return a result, this is what I meant by &lt;code class=&quot;language-text&quot;&gt;flatMap&lt;/code&gt; chain, it can potentially creates an infinite loop if &lt;code class=&quot;language-text&quot;&gt;innerIO&lt;/code&gt; never return a result.&lt;/p&gt;
&lt;p&gt;We can then cancel an infinite loop like the following&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;effect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;_
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;scala&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;concurrent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;ExecutionContext&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;global

&lt;span class=&quot;token comment&quot;&gt;// needed to perform logical fork&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; IO&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contextShift&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;global&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// an infinite `flatMap` chain as the innerIO always return None&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; myIO &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; retryIfNone&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;IO&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;None&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// perform a logical fork using `.start`, this to allow cancellation&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; fiber&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Fiber&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IO&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; myIO&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unsafeRunSync

&lt;span class=&quot;token comment&quot;&gt;// cancel the forked fiber&lt;/span&gt;
fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cancel&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unsafeRunSync&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With this approach, to make any arbitrary loop cancellable, we need to convert the loop into a recursive loop, and wrap each step in an IO, then we are able to cancel the loop using the approach shown above. &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Applicable to all recursion loops&lt;/li&gt;
&lt;li&gt;Does not requires cancellation specific logic in loop&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Incurs non-trivial overheads, every &lt;code class=&quot;language-text&quot;&gt;flatMap&lt;/code&gt; incurs some cost&lt;/li&gt;
&lt;li&gt;It is less readable that regular loop due to the addition &lt;code class=&quot;language-text&quot;&gt;flatMap&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;IO&lt;/code&gt; wrapping &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This approach is suitable if you dont need great performance or if each step of your loop is already effectful to begin with, eg. a loop that repeated hit an api is a good fit &lt;/p&gt;
&lt;h3&gt;Custom cancellable loop&lt;/h3&gt;
&lt;p&gt;The loop I wish to cancel isn’t effectful and it should be fast, thus the approach above is not sufficient, but it does give me a good idea to proceed.&lt;/p&gt;
&lt;p&gt;IO is cancellable based on the idea of &lt;code class=&quot;language-text&quot;&gt;cancellable boundary&lt;/code&gt;, meaning during the evaluation of IO monad, there are certains places where it checks for cancellation signal. We can implement a looping construct with the same idea, but do it without excessive &lt;code class=&quot;language-text&quot;&gt;flatMap&lt;/code&gt; calls&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cancellableLoop&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    step&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopCtx &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Either&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;init&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; cs&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ContextShift&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; monad&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Monad&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; LoopCtx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        cs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;shift&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;flatMap&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_ &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        step&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cont&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cont&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Right&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pure&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    inner&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;init&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above is the solution I came up with, the idea is that by limiting user to specify the semantic of their loop using a step function, we can control the actual mechanism of loop and insert cancellation boundary in a way that is transparent to user.&lt;/p&gt;
&lt;p&gt;Note: I am using &lt;code class=&quot;language-text&quot;&gt;user&lt;/code&gt; here as &lt;code class=&quot;language-text&quot;&gt;api caller&lt;/code&gt;&lt;/p&gt;
&lt;h4&gt;step: &lt;code class=&quot;language-text&quot;&gt;LoopCtx =&gt; Either[LoopCtx, A]&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;The 1st argument is a step that takes in a &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt; and either return a &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt; or a result &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;, if it returns &lt;code class=&quot;language-text&quot;&gt;Right(a)&lt;/code&gt;, it means we have reach the end, and &lt;code class=&quot;language-text&quot;&gt;Left(nextCtx)&lt;/code&gt; means we have to continue, by having &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt; as part of the result type   &lt;/p&gt;
&lt;p&gt;Note: this is similar to the &lt;code class=&quot;language-text&quot;&gt;tailRecM&lt;/code&gt; method on &lt;code class=&quot;language-text&quot;&gt;Monad&lt;/code&gt; from &lt;code class=&quot;language-text&quot;&gt;cats&lt;/code&gt; library.&lt;/p&gt;
&lt;h4&gt;init: &lt;code class=&quot;language-text&quot;&gt;LoopCtx&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;The second param is &lt;code class=&quot;language-text&quot;&gt;init&lt;/code&gt;, this is needed as we need a starting point to be able to call our &lt;code class=&quot;language-text&quot;&gt;step&lt;/code&gt; param&lt;/p&gt;
&lt;h4&gt;inner loop method&lt;/h4&gt;
&lt;p&gt;This is the meat of our method, it calls the &lt;code class=&quot;language-text&quot;&gt;step&lt;/code&gt; function repeatedly and recursively until it finds a result, at the same time, it tracks the number of loop and injects a cancellation boundary using &lt;code class=&quot;language-text&quot;&gt;ContextShift::shift&lt;/code&gt; method on every 2000 loop. &lt;/p&gt;
&lt;p&gt;Note that the number of 2000 is picked randomly   &lt;/p&gt;
&lt;h4&gt;Usage&lt;/h4&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// create non-terminating loop&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cancellable &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cancellableLoop&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;IO&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;println&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a step&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;Left&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; fiber &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cancellable&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unsafeRunSync
fiber&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cancel&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unsafeRunSync&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that the &lt;code class=&quot;language-text&quot;&gt;step&lt;/code&gt; params map nicely to tail recursive function, so if you have a tail recursive function, it is trivial to make it cancellable using this &lt;code class=&quot;language-text&quot;&gt;cancellableLoop&lt;/code&gt; construct.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;This solution applies to many different loops&lt;/li&gt;
&lt;li&gt;It is faster than our previous solution as there are less flatMap &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It forces user to write their algorithm in a specific form, ie. a step function&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;The last approach is where I ended with, I haven’t benchmark it performs against 2nd solution. Anecdotally, my algorithm now runs a lot faster. &lt;/p&gt;
&lt;p&gt;Hope you find this post useful.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Fix point type for GADT (Scala)]]></title><description><![CDATA[Prerequisite This article assumes the reader already know about Higher Kinded type (HKT) Fix point type Fix point type is a type that…]]></description><link>https://qingwei91.github.io/higher-fix/</link><guid isPermaLink="false">https://qingwei91.github.io/higher-fix/</guid><pubDate>Fri, 08 Feb 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Prerequisite&lt;/h2&gt;
&lt;p&gt;This article assumes the reader already know about&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Higher Kinded type (HKT)&lt;/li&gt;
&lt;li&gt;Fix point type&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Fix point type is a type that generically describes recursive data. By abstracting over a recursive data structure, we can define a generic operation that works on any recursive data structure.&lt;/p&gt;
&lt;p&gt;To learn more about HKT and Fix point type, check these links.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://typelevel.org/blog/2016/08/21/hkts-moving-forward.html&quot;&gt;Typelevel blogs for HKT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=7xSfLPD6tiQ&quot;&gt;Rob Norris’s awesome video about Fix Point Type and more&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://free.cofree.io/2017/11/13/recursion/&quot;&gt;Recursion Schemes in Scala&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Setup&lt;/h2&gt;
&lt;p&gt;You can run all code snippets in &lt;a href=&quot;https://ammonite.io&quot;&gt;ammonite-repl&lt;/a&gt;, for ADT definition, you need to enclose them in a curly brace like &lt;code class=&quot;language-text&quot;&gt;{ ...adt definition }&lt;/code&gt; before pasting to ammonite repl.&lt;/p&gt;
&lt;p&gt;You can find all of the code used in this post &lt;a href=&quot;https://gist.github.com/qingwei91/8079d8c731d352259e2d6334b2135300&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;What is this post about?&lt;/h2&gt;
&lt;p&gt;This post aims to document how to retain type information of Generalized Algebraic Data Type (GADT) with Fix point type. I will illustrate the technique by refactoring a GADT with direct recursion into another GADT without recursion and implement &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt; method for it.&lt;/p&gt;
&lt;p&gt;This technique can be useful when the type param of your original recursive GADT propagates through the layers of your recursive data structure. It might not make sense now, I suggest carry on reading :)&lt;/p&gt;
&lt;p&gt;The following code snippet shows a GADT that describes how to query a recursive data (e.g., JSON). It is super simple, it can only query String or Boolean by path, but we can add things like QueryByWithCondition later (not in the scope of this article).&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// simplified&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryString &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryBool &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// sample data&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   &quot;oh&quot;: {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//     &quot;my&quot;: &quot;zsh&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   }&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// }&lt;/span&gt;


&lt;span class=&quot;token comment&quot;&gt;// expression to query _.oh.my from JSON above&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; expression &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you might have noticed, the &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt; ADT is recursive, and the type param &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; is recursive too, when constructing &lt;code class=&quot;language-text&quot;&gt;QueryPath&lt;/code&gt; which extends &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt;, the type param is determined by the &lt;code class=&quot;language-text&quot;&gt;next&lt;/code&gt; argument of &lt;code class=&quot;language-text&quot;&gt;QueryPath&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; typeMatch&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; B&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; B&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; eq&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; A&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;B&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; queryString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; queryNestedString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

typeMatch&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;queryString&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; queryNestedString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// compiles&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Having a type param is useful because, for any recursive query, we can &lt;code class=&quot;language-text&quot;&gt;know the result type statically without traversing the tree&lt;/code&gt;, which is a runtime property.&lt;/p&gt;
&lt;p&gt;The following steps are common when applying recursion schemes.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Refactor Recursive ADT to abstract recursion away&lt;/li&gt;
&lt;li&gt;Construct recursive data structure using Fix Point Type&lt;/li&gt;
&lt;li&gt;Define a Functor instance for the new Non-Recursive ADT&lt;/li&gt;
&lt;li&gt;Implement (or use them from a library) operations like &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;anamorphism&lt;/code&gt; on our recursive data structure&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;(For common use cases, we can use operations from recursion schemes library, e.g. &lt;a href=&quot;https://github.com/slamdata/matryoshka&quot;&gt;Matryoshka&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;We are going to follow the same steps here.&lt;/p&gt;
&lt;h3&gt;Step 1: Refactor GADT to remove recursion&lt;/h3&gt;
&lt;p&gt;The goal of this step is to remove recursion from our ADT, in our case, &lt;code class=&quot;language-text&quot;&gt;QueryPath&lt;/code&gt; should no longer refer to &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt; in its definition&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;sealed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryStringF &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Nothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; QueryBoolF &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Nothing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above is the GADT after transformation, they are suffixed by &lt;code class=&quot;language-text&quot;&gt;F&lt;/code&gt; to differentiate with the previous GADT, few things to note&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We added a Higher Kinded Type (HKT) param &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; to &lt;code class=&quot;language-text&quot;&gt;Query&lt;/code&gt; base trait, and make it a covariant&lt;/li&gt;
&lt;li&gt;On &lt;code class=&quot;language-text&quot;&gt;QueryStringF&lt;/code&gt;, we specify &lt;code class=&quot;language-text&quot;&gt;Nothing&lt;/code&gt; on the &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; position, so that &lt;code class=&quot;language-text&quot;&gt;QueryStringF&lt;/code&gt; is a subtype of &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;, same for &lt;code class=&quot;language-text&quot;&gt;QueryBoolF&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;We removed the recursion on &lt;code class=&quot;language-text&quot;&gt;QueryPathF&lt;/code&gt;, by abstracting &lt;code class=&quot;language-text&quot;&gt;next: QueryF[A]&lt;/code&gt; into &lt;code class=&quot;language-text&quot;&gt;next: F[A]&lt;/code&gt;, this is why we have to introduce &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; on &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;, so that we can abstract over the original &lt;code class=&quot;language-text&quot;&gt;Query[A]&lt;/code&gt; which is a HKT.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Now let’s see how to form a query using the new ADT.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// compiles with `-Ypartial-unification` compiler flag&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; expression &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; QueryStringF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see, it’s similar to our previous example, which is a hint that our new generic representation is as powerful as the previous, more concrete representation in terms of expressivity.&lt;/p&gt;
&lt;h3&gt;Step 2: Construct recursive data structure using Fix Point Type&lt;/h3&gt;
&lt;p&gt;Let’s revise what Fix Point Type is, &lt;code class=&quot;language-text&quot;&gt;fix&lt;/code&gt; is a structure that conforms to the following rule:&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;fix(f) = f(fix(f)) for all f&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The rule above is abstract, in the sense that it can apply to different domain, for example when &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt; is function, then &lt;code class=&quot;language-text&quot;&gt;fix&lt;/code&gt; is commonly known as &lt;code class=&quot;language-text&quot;&gt;Y-combinator&lt;/code&gt; which describes recursive function, when &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt; is a type then we get &lt;code class=&quot;language-text&quot;&gt;Fix Point Type&lt;/code&gt; which describe recursive type.&lt;/p&gt;
&lt;p&gt;Below is a straight forward way to define &lt;code class=&quot;language-text&quot;&gt;Fix point type&lt;/code&gt; in Scala:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Fix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;unfix&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Fix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It follows the rule above in that every &lt;code class=&quot;language-text&quot;&gt;Fix[F]&lt;/code&gt; is equivalent to &lt;code class=&quot;language-text&quot;&gt;F[Fix[F]]&lt;/code&gt; for all F.&lt;/p&gt;
&lt;p&gt;Unfortunately, we cannot use this definition of &lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; to construct a recursive version of &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// does not compile&lt;/span&gt;
Fix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;key&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Fix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryStringF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Because the type signature does not match, &lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; constructor takes a type param with &lt;code class=&quot;language-text&quot;&gt;* -&gt; *&lt;/code&gt; kind (commonly pronounce as Star to Star), encoded as &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; in Scala, but &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt; has kind of &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt;, as it takes a &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; and returns a proper type (ie. a Star type)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Insights: Fundamentally, &lt;code class=&quot;language-text&quot;&gt;Fix point&lt;/code&gt; exists for any kind of functions. The regular &lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; type is actually a fix point of &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; which is a type level function, it takes a &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; and produce &lt;code class=&quot;language-text&quot;&gt;F[Fix[F]]&lt;/code&gt; &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The solution for this problem is to create a different &lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; type that can handle &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;, which is a different function.&lt;/p&gt;
&lt;p&gt;We can start by writing out the kind/shape of &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;, it looks like this: &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt;, meaning it takes a type level function and a proper type and returns a proper type.&lt;/p&gt;
&lt;p&gt;The fix point of such a kind should takes this type as an input, and Scala is powerful enough to express such idea using HKT syntax&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;F[_[_], _]&lt;/code&gt; is the syntax to represent a type level function with this kind: &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt;, then our special HFix for QueryF will looks like below:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;unfix&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This looks a bit scary, let’s try to break it down.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the 1st type param &lt;code class=&quot;language-text&quot;&gt;F[_[_], _]&lt;/code&gt; is a type constructor that takes 2 type params, a HKT &lt;code class=&quot;language-text&quot;&gt;* -&gt; *&lt;/code&gt; and a proper type &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;2nd type param is just a proper type, bind to symbol &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;unfix&lt;/code&gt; becomes &lt;code class=&quot;language-text&quot;&gt;F[HFix[F, ?], A]&lt;/code&gt;, remember &lt;code class=&quot;language-text&quot;&gt;F&lt;/code&gt; takes a &lt;code class=&quot;language-text&quot;&gt;* -&gt; *&lt;/code&gt; on 1st type param, which is the kind of &lt;code class=&quot;language-text&quot;&gt;HFix[F, ?]&lt;/code&gt;, the 2nd type param would then be &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt; so that we propagate it across layers of recursion&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;How do we determine the shape of &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt; ?&lt;/h3&gt;
&lt;p&gt;To determine the shape of &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt;, let’s go back to basic:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;fix(f) = f(fix(f))&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;With this formula, we use algebra to solve:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;QF = ((* -&gt; *) -&gt; * -&gt; *)&lt;/li&gt;
&lt;li&gt;Fix = QF -&gt; k where QF(k) = k&lt;/li&gt;
&lt;li&gt;QF(k) = k if k = * -&gt; *&lt;/li&gt;
&lt;li&gt;Fix = QF -&gt; * -&gt; * = &lt;code class=&quot;language-text&quot;&gt;((* -&gt; *) -&gt; * -&gt; *) -&gt; * -&gt; *&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The shape of HFix should be &lt;code class=&quot;language-text&quot;&gt;((* -&gt; *) -&gt; * -&gt; *) -&gt; * -&gt; *&lt;/code&gt;, the key is to figure out what &lt;code class=&quot;language-text&quot;&gt;k&lt;/code&gt; should be&lt;/p&gt;
&lt;p&gt;I think it’s worth to emphasize 2 points&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;It allows us to relate an extra type param between layers, ie. both &lt;code class=&quot;language-text&quot;&gt;HFix[F[_[_], _], A]&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;F[HFix[F, ?], A]&lt;/code&gt; contains type &lt;code class=&quot;language-text&quot;&gt;A&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;It abstracts over a type with this shape &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt;, encoded as &lt;code class=&quot;language-text&quot;&gt;F[_[_], _]&lt;/code&gt;, which match our &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt; type&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Sample usage of &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; queryString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryStringF&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Query&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; queryBool &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryBoolF&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Query&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; queryPath&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; next&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    queryString
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

res32&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryStringF&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Cool, so we can create a recursive structure that expresses querying a string at path &lt;code class=&quot;language-text&quot;&gt;oh.my&lt;/code&gt;, note the type of this structure is &lt;code class=&quot;language-text&quot;&gt;HFix[QueryF, String]&lt;/code&gt;, which is great because we retain the knowledge that it results in a &lt;code class=&quot;language-text&quot;&gt;String&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;Step 3: Define Functor instance for GADT&lt;/h3&gt;
&lt;p&gt;Defining a Functor instance is essential, it describes how to transform recursive data structure. Unfortunately, due to the usage of GADT, a standard Functor wouldn’t work, it’s similar to the issue with standard Fix Point type.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; Functor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above is the interface of Functor, we can define &lt;code class=&quot;language-text&quot;&gt;Functor&lt;/code&gt; for any type with kind &lt;code class=&quot;language-text&quot;&gt;* -&gt; *&lt;/code&gt;, but Query has a type of &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt; as we’ve seen earlier.&lt;/p&gt;
&lt;p&gt;The solution is similar to how to solve the issue with Fix; we need to define another Functor like structure that fit our type.&lt;/p&gt;
&lt;p&gt;When using ordinary ADT, we want a Functor instance so that we can transform the type param of our ADT, eg. &lt;code class=&quot;language-text&quot;&gt;F[A] =&gt; F[B]&lt;/code&gt;, but now we have &lt;code class=&quot;language-text&quot;&gt;QueryF[F[_], A]&lt;/code&gt;, which contains 2 type params, what should we transform?&lt;/p&gt;
&lt;p&gt;The most generic way would be to transform both type params but to simplify the problem, we are only transforming the 1st type param, e.g., &lt;code class=&quot;language-text&quot;&gt;QueryF[F[_], A] =&gt; QueryF[G[_], A]&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; $ivy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;`org&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;typelevel&lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt;cats&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;core&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1.6&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;`

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;cats&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; hmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; I &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This typeclass describes the ability transform the 1st type param of an arbitrary type F, where F has kind of &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt;, which is what we need.&lt;/p&gt;
&lt;p&gt;Next, we need to implement an instance of &lt;code class=&quot;language-text&quot;&gt;HFunctor&lt;/code&gt; for &lt;code class=&quot;language-text&quot;&gt;QueryF&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; queryHFunctor&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; hmap&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nt&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; I &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; J&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;J&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          a &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryStringF            &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; QueryStringF
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryBoolF              &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; QueryBoolF
            &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; query&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nt&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The implementation is relatively straight-forward, basically we try to handle every case of GADT and change the &lt;code class=&quot;language-text&quot;&gt;F[_]&lt;/code&gt; type param, for bottom type (ie. when F is Nothing), we dont have to change anything because we define F as covariant.&lt;/p&gt;
&lt;h3&gt;Step 4: Implement catamorphism&lt;/h3&gt;
&lt;p&gt;Finally, after all the ceremony, we are in the position to define &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;On a high-level view, &lt;code class=&quot;language-text&quot;&gt;catamorphism&lt;/code&gt; is an operation that collapses a recursive structure into a single value by collapsing each layer of the data structure recursively.&lt;/p&gt;
&lt;p&gt;It is generic in that user can define how to collapse each layer.&lt;/p&gt;
&lt;p&gt;It looks like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;G&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; G

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; hCata&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;_&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; I&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;alg&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;hfix&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; I&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;implicit&lt;/span&gt; F&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFunctor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;I&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; inner &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hfix&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;unfix
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; nt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; F&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hmap&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HFix&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;F&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; G&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hCata&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;alg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fa&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;inner&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  alg&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The flow of &lt;code class=&quot;language-text&quot;&gt;hCata&lt;/code&gt; is similar to normal &lt;code class=&quot;language-text&quot;&gt;cata&lt;/code&gt; method, by trying to peel off the outer layer of &lt;code class=&quot;language-text&quot;&gt;HFix[F, I]&lt;/code&gt;, we recursively dive into the inner-most layer of the recursive structure, then we apply &lt;code class=&quot;language-text&quot;&gt;HAlgebra&lt;/code&gt; while traversing back to the top layer.&lt;/p&gt;
&lt;p&gt;Note: You can try to implement anamorphism and other operations :D&lt;/p&gt;
&lt;p&gt;We defined everything we need, let’s try to use it.&lt;/p&gt;
&lt;p&gt;We’ll go through 2 examples, using the query we created earlier.&lt;/p&gt;
&lt;p&gt;a) Print recursive query in a human-readable format&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; nestedQuery &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                    &lt;span class=&quot;token string&quot;&gt;&quot;oh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    queryPath&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                      &lt;span class=&quot;token string&quot;&gt;&quot;my&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                      queryString
                    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// a trick to fold into String, this is interesting as it shows that&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// generalized type constructor is super powerful; it can represent a&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// more specialized type easily&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;String&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// important part: convert each layer of query into a string&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; print&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;JustString&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; JustString&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    fa &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryStringF                 &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;as[String]&quot;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryBoolF                   &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;as[Bool]&quot;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;JustString&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; s&lt;span class=&quot;token string&quot;&gt;&quot;${q.path}.${q.next}&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

hCata&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;print&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nestedQuery&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// res44: JustString[String] = &quot;oh.my.as[String]&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;b) Convert our query description a circe Decoder&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; $ivy&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;`io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;circe&lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt;circe&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;parser&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.10&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;`

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;circe&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;Decoder

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; toDecoder&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; HAlgebra&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;QueryF&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fa&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Decoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fa &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryBoolF   &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decodeBoolean
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; QueryStringF &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decodeString
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; QueryPathF&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Decoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; A&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
      Decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;instance &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; cursor &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        cursor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;q&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hCata&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;toDecoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; nestedQuery&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; parse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
    {
      &quot;oh&quot;: {
        &quot;my&quot;: &quot;20202&quot;
      }
    }
&quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;right&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get

decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Right(&quot;20202&quot;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I tried to use simpler examples, for more complicated examples, check these projects:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/nuttycom/xenomorph/blob/master/modules/argonaut/src/main/scala/xenomorph/argonaut/FromJson.scala#L51&quot;&gt;Xenomorph&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/qingwei91/basil/blob/master/core/src/main/scala/basil/parser/JsonParse.scala#L447&quot;&gt;Basil&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Conclusion:&lt;/h2&gt;
&lt;p&gt;We’ve walked through how to apply recursion schemes on a GADT. The basic idea is similar to applying recursion schemes on ordinary ADT; the main difference is that we need to operate on higher order types, eg.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Functor&lt;/code&gt; that takes a function (&lt;code class=&quot;language-text&quot;&gt;* -&gt; *&lt;/code&gt;) becomes HFunctor that takes natural transformation &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; (* -&gt; *)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Fix&lt;/code&gt; with shape &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; *&lt;/code&gt; becomes &lt;code class=&quot;language-text&quot;&gt;HFix&lt;/code&gt; with shape &lt;code class=&quot;language-text&quot;&gt;((* -&gt; *) -&gt; (* -&gt; *)) -&gt; (* -&gt; *)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;Algebra&lt;/code&gt; with &lt;code class=&quot;language-text&quot;&gt;(* -&gt; *) -&gt; * -&gt; *&lt;/code&gt; becomes HAlgebra &lt;code class=&quot;language-text&quot;&gt;((* -&gt; *) -&gt; (* -&gt; *)) -&gt; (* -&gt; *) -&gt; (* -&gt; *)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Notice there’s a common theme, the number of stars doubled in the process, I haven’t fully understood why but I hope this article is still useful.&lt;/p&gt;
&lt;h2&gt;Credit&lt;/h2&gt;
&lt;p&gt;I learn most of the techniques described here from &lt;a href=&quot;https://github.com/nuttycom/xenomorph&quot;&gt;Xenomorph&lt;/a&gt; by Nuttycom, I find it interesting and thought would be good to write it down.&lt;/p&gt;
&lt;p&gt;Thanks Nuttycomb for sharing his idea with the open source world! I also wish to thanks my coworker &lt;a href=&quot;https://github.com/Baccata/&quot;&gt;Olivier&lt;/a&gt; for introducing the idea of recursion scheme to me, and Alex for correcting me on notation of higher kinded type.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[My reflection for 2018]]></title><description><![CDATA[2018 Reflection What went well? More responsibility at work Getting more responsibility is stressful and fun at the same time, luckily my…]]></description><link>https://qingwei91.github.io/2018-reflection/</link><guid isPermaLink="false">https://qingwei91.github.io/2018-reflection/</guid><pubDate>Tue, 25 Dec 2018 00:00:00 GMT</pubDate><content:encoded>&lt;h1&gt;2018 Reflection&lt;/h1&gt;
&lt;h2&gt;What went well?&lt;/h2&gt;
&lt;h3&gt;More responsibility at work&lt;/h3&gt;
&lt;p&gt;Getting more responsibility is stressful and fun at the same time, luckily my team leads and project manager are good at helping me.&lt;/p&gt;
&lt;p&gt;One of the main changes when leading is that my decision starts to impact a larger part of the project, for better or worse. This means that I need to be more cautious when making decision, and strike a better balance between ensuring safety and making progress.&lt;/p&gt;
&lt;h3&gt;I learned a lot more about functional programming&lt;/h3&gt;
&lt;p&gt;I am thankful to be in the same team with Olivier, which he taught us a lot about functional programming. In addition, our team leads have been open with advanced technique which allow us to learn things on our job.&lt;/p&gt;
&lt;h4&gt;Recursion Schemes&lt;/h4&gt;
&lt;p&gt;I’ve learn some basic of recursion schemes, and manage to apply it in an open source project &lt;a href=&quot;https://github.com/qingwei91/basil&quot;&gt;basil&lt;/a&gt;&lt;/p&gt;
&lt;h4&gt;Tagless Final&lt;/h4&gt;
&lt;p&gt;I am starting to appreciate interpreter pattern more. By separating definition and execution, one can gain a lot of power without paying huge refactoring cost.&lt;/p&gt;
&lt;p&gt;Example: Execute a program with &lt;code class=&quot;language-text&quot;&gt;debounce&lt;/code&gt; Effect to prevent rate limit exception from a remote API&lt;/p&gt;
&lt;h3&gt;Wrote an interesting library: &lt;a href=&quot;https://github.com/qingwei91/basil&quot;&gt;basil&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;I wrote this library out of curiosity, and learn a lot in the process, I’ve learn about &lt;code class=&quot;language-text&quot;&gt;higher kinded fix&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;FreeApplicative&lt;/code&gt; and a lot more.&lt;/p&gt;
&lt;p&gt;It’s cool to (re)discover that I am most motivated when exploring new stuff, even if it’s not useful.&lt;/p&gt;
&lt;h3&gt;Reboot my own blog: &lt;a href=&quot;https://qingwei91.github.io&quot;&gt;https://qingwei91.github.io&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;While my company blog undergone some changes which makes it harder to submit a blogpost, I decided to start my own blog again.&lt;/p&gt;
&lt;p&gt;I didn’t write as many blog as I wanted, let’s hope I will do it more in the coming year.&lt;/p&gt;
&lt;h3&gt;Formed a habit to gym&lt;/h3&gt;
&lt;p&gt;I am very happy that I am going to gym more often, it’s started to form a habit. This &lt;a href=&quot;https://www.youtube.com/user/JDCav24/featured&quot;&gt;youtube channel&lt;/a&gt; is one of my favorite channel about working out, thanks Jeff !&lt;/p&gt;
&lt;h3&gt;Enhanced my culinary skills&lt;/h3&gt;
&lt;p&gt;I enjoy cooking and have been trying out different recipes, hurray !&lt;/p&gt;
&lt;h2&gt;What went wrong?&lt;/h2&gt;
&lt;h3&gt;Investment went deep down, I mean deep down&lt;/h3&gt;
&lt;p&gt;I made a couple of big mistakes:&lt;/p&gt;
&lt;p&gt;a) Invest (speculate ?) without knowing how to make valuation
b) Not knowing to cut-loss and take profit
c) Putting all pressure on my wife which is an amateur&lt;/p&gt;
&lt;p&gt;these combined with uncertainty brought by trade war, and slow down of global economy means a bad year for our investment&lt;/p&gt;
&lt;h3&gt;Mistakes in work due to carelessness&lt;/h3&gt;
&lt;p&gt;I realized I get carried away rather easily, there’s a part of me that behaves like an enthusiastic dog that is eager to do whatever I am tasked to do :D&lt;/p&gt;
&lt;p&gt;While being enthusiastic is not a bad thing, it certainly isn’t an excuse for recklessness, I need to be more mindful when making decision or taking actions.&lt;/p&gt;
&lt;h3&gt;Fail to develop an arbitrage software I planned earlier of the year&lt;/h3&gt;
&lt;p&gt;I wanted to build an arbitrage engine but didn’t finish it, couple of reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the project turns out to be quite difficult and messy due to external api changes&lt;/li&gt;
&lt;li&gt;I didn’t have a clear plan when developing&lt;/li&gt;
&lt;li&gt;It’s not as fun as I originally envision&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I need to work on my energy management and be more focus on my goal, it’s ok to give up but there has to be a good reason&lt;/p&gt;
&lt;h2&gt;Action Points&lt;/h2&gt;
&lt;h3&gt;Improve my investment skills&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Develop a methodology to evaluate a stock&lt;/li&gt;
&lt;li&gt;Develop a strategy to take profit and cut loss&lt;/li&gt;
&lt;li&gt;Iterate the strategy by learning from historical actions&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Be more careful and cautious&lt;/h3&gt;
&lt;p&gt;I think it’s hard to suddenly become a careful person, I can however starts with some actionable things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Double check a decision with experts&lt;/li&gt;
&lt;li&gt;Think thrice when pulling a dependency, a dependency is a backdoor waiting to happen&lt;/li&gt;
&lt;li&gt;Act slower when you’re dealing with something new that you aren’t familiar&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Scalameta tutorial: Cache decorator]]></title><description><![CDATA[This is a tutorial to show how to use Scalameta to develop a generic, parameterized annotation.
To know how to setup a project to use…]]></description><link>https://qingwei91.github.io/scalameta-tut/</link><guid isPermaLink="false">https://qingwei91.github.io/scalameta-tut/</guid><pubDate>Sat, 06 May 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;This is a tutorial to show how to use Scalameta to develop a &lt;strong&gt;generic, parameterized annotation&lt;/strong&gt;.
To know how to setup a project to use &lt;code class=&quot;language-text&quot;&gt;scalameta&lt;/code&gt;, refer to &lt;a href=&quot;http://scalameta.org/tutorial/#Setup&quot;&gt;official docs&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;What is scalameta?&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://scalameta.org/&quot;&gt;Scala-meta&lt;/a&gt; is the de-facto toolkit for metaprogramming in Scala. For those who are new to metaprogramming, it means programming against code/syntax/&lt;a href=&quot;https://en.wikipedia.org/wiki/Abstract_syntax_tree&quot;&gt;AST&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Metaprogramming is very useful when you notice a repeating pattern in your code, but you are not able to refactor it due to limitations of the programming language.&lt;/p&gt;
&lt;p&gt;Conceptually, scalameta allows you to access your code as data (Abstract Syntax Tree), and manipulate it at compile time.&lt;/p&gt;
&lt;h2&gt;Problem: Caching&lt;/h2&gt;
&lt;p&gt;Caching is a common technique that almost all programmers are familiar with. In this tutorial, we will develop a &lt;code class=&quot;language-text&quot;&gt;cache&lt;/code&gt; macro that&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;has low syntatic overhead, ie. it should not change the cached function much&lt;/li&gt;
&lt;li&gt;able to support different cache storage, eg. In memory cache, elastic search etc&lt;/li&gt;
&lt;li&gt;able to cache methods with multiple arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Naive implementation&lt;/h2&gt;
&lt;p&gt;Let’s start with a simple implementation without using macro&lt;/p&gt;
&lt;p&gt;Code to support cache function&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; CacheBackEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; mutable&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Map&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// ignore the fact it is not thread safe&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// `compute` is a function, only evaluated in case of cache miss&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; getOrElse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; compute&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; V &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; Some&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; v       &lt;span class=&quot;token comment&quot;&gt;// cache hit&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; compute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        v
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fn&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheStorage&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; CacheBackEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; V &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
    cacheStorage&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;getOrElse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Calling cache function&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// this is slow .....&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; n &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cacheBackend &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; CacheBackEnd&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cachedFib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fib&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheBackend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// alternatively, we can inline the logic&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; cachedFib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cache &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; n &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheBackend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Analysis&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it’s simple and easy to understand&lt;/li&gt;
&lt;li&gt;it supports different cache storage&lt;/li&gt;
&lt;li&gt;able to work on methods of different arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It is a bit intrusive, notice the implementation of &lt;code class=&quot;language-text&quot;&gt;cachedFib&lt;/code&gt; needs to be changed&lt;/li&gt;
&lt;li&gt;It is awkward to work with functions with multiple arguments, because our CacheBackend can only takes in &lt;code class=&quot;language-text&quot;&gt;K, V&lt;/code&gt; as type param, so if you have a function with signature &lt;code class=&quot;language-text&quot;&gt;def fn(x: Int, y: Int): Int&lt;/code&gt; , you need to combine &lt;code class=&quot;language-text&quot;&gt;x&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;y&lt;/code&gt; into &lt;code class=&quot;language-text&quot;&gt;(Int, Int)&lt;/code&gt; so that it fit into CacheBackend’s type signature&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s see how we can improve it using scala meta.&lt;/p&gt;
&lt;h2&gt;Scalameta Implementation 1&lt;/h2&gt;
&lt;p&gt;Here, we are going to implement cache function as a macro, the end goal is to support syntax like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// the signature is slightly different, as our macro need to access `get` and `put` method, but not `getOrElse`&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// you can implement both signature though&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;trait&lt;/span&gt; SyncCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Option&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; put&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;k&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cacheBackend &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; SyncCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token annotation punctuation&quot;&gt;@cache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheBackend&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; n &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; fib&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Before we jump into implementation, we can observe a few difference with previous implementation&lt;/p&gt;
&lt;h3&gt;Observations&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;The syntax is cleaner, it does not change the method’s definition at all&lt;/li&gt;
&lt;li&gt;It also supports different cache storage&lt;/li&gt;
&lt;li&gt;Too much MAGIC, how does it even work?&lt;/li&gt;
&lt;li&gt;Does it support function with multiple arguments?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s answer the 1st question, how does it works?&lt;/p&gt;
&lt;p&gt;Below is the implementation of the &lt;code class=&quot;language-text&quot;&gt;cache&lt;/code&gt; macro, let’s go through the comments to understand what it does&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// @param backend - parameter for `cache` annotation&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; cache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;backend&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; SyncCache&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;K&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; V&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; scala&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;annotation&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;StaticAnnotation &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// @param defn - the annotated method (it can also be other scala building block like class, but we are restricting here&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;//               using some checks below&lt;/span&gt;
  inline &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; apply&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;defn&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Any&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; meta &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    defn &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// this annotation should only be annotate on `method`, represented as `Defn.Def` in scalameta&apos;s AST&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; defn&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Defn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Def &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// this represent the instatiated annotation, ie. `@cache(xxx)`&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

          &lt;span class=&quot;token comment&quot;&gt;// Quasiquote in action, it&apos;s a way to pattern match scala AST&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `new`               match instantiation&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `$_`                match the name of the annotation&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `[..$tpr]`          match type params and bind to `tpr`&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//  - `($backendParam)`   match SINGLE argument used in instatiation and bind to `backendParam`&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//                        Note: To match multiple arguments or multiple arguments list (curried), you need different                                           syntax&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token string&quot;&gt;&quot;new $_[..$tpr]($backendParam)&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;

            &lt;span class=&quot;token comment&quot;&gt;// we use the element we captured to generate code we want, we will look into details next&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; body&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Term &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; CacheMacroImpl&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expand&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tpr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; backendParam&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; defn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

            &lt;span class=&quot;token comment&quot;&gt;// we only want to replace the method body, so this will do&lt;/span&gt;
            defn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;copy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;body &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; x &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
            abort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token string&quot;&gt;&quot;Unrecognized pattern $x&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; _ &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;
        abort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;This annotation only works on `def`&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// abort if annotated to anything other than methods&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So here is quite some amount of info, especially around quasiquote. You might have a few questions, like what is the type signature of &lt;code class=&quot;language-text&quot;&gt;tpr&lt;/code&gt; that we’ve captured? I will go through them in next section, but here I wish you get familiar with the general flow, basically we are trying to&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;use pattern matching to capture relevant information from the AST [Compile Time]&lt;/li&gt;
&lt;li&gt;perform transformation on the AST [Compile Time]&lt;/li&gt;
&lt;li&gt;transformed AST will then get compiled into artifact that is invoked at runtime&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;if you’re interested to know more about quasiquote, &lt;a href=&quot;https://github.com/scalameta/scalameta/blob/master/notes/quasiquotes.md&quot;&gt;here&lt;/a&gt; is the reference for all quasiquote syntax&lt;/p&gt;
&lt;p&gt;Now let’s inspect the implementation of AST transformation logic, ie. &lt;code class=&quot;language-text&quot;&gt;CacheMacroImpl.expand(tpr, backendParam, defn)&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;object&lt;/span&gt; CacheMacroImpl &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;/**
    *
    * @param fnTypeParams - Type params of annotation instance, remember our cache macro is generic `class cache[K, V]`,
                            this will capture Seq(K, V)
    * @param cacheExpr    - Argument pass to `cache` macro, should be type of `CacheBackEnd[K, V]`
    * @param annotatedDef - Methods that is annotated
    */&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; expand&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fnTypeParams&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Seq&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Type&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cacheExpr&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Arg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; annotatedDef&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Defn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Def&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Term &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; cache &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cacheExpr&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;syntax&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// convert Term.Arg to Term.Name&lt;/span&gt;

    annotatedDef &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// Another Quasiquote pattern match&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `..$_`                   match any modifier&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `def`                    match only method&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `$methodName`            bind method name to $methodName&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `[..$tps]`               match some type params of method and bind to $tps&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `(..$nonCurriedParams)`  match non-curried argument list and binf to $nonCurriedParams&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `$rtType`                bind return type to $rtType&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// - `$expr`                  bind method&apos;s body to $expr&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; q&lt;span class=&quot;token string&quot;&gt;&quot;..$_ def $methodName[..$tps](..$nonCurriedParams): $rtType = $expr&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// here is the trick to handle different arg size&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nonCurriedParams&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;size &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

          &lt;span class=&quot;token comment&quot;&gt;// if only 1 arg, use the arg as key of cache&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; paramAsArg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;nonCurriedParams&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;head&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          q&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
            // here we are generating code that call the CacheBackend
            val result: ${rtType} = $cache.get($paramAsArg) match {
              case Some(v) =&gt; v
              case None =&gt;
                val value = ${expr}
                $cache.put($paramAsArg, value)
                value
            }
            result
           &quot;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; paramAsArg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; nonCurriedParams&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; Term&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Name&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          q&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;

            // if there are multiple arg, convert them in tuple, as use the tuple as key
            val result: ${rtType} = $cache.get((..$paramAsArg)) match {
              case Some(v) =&gt; v
              case None =&gt;
                val value = ${expr}
                $cache.put((..$paramAsArg), value)
                value
            }
            result
           &quot;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; other &lt;span class=&quot;token keyword&quot;&gt;=&gt;&lt;/span&gt; abort&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token string&quot;&gt;&quot;Expected non-curried method, got $other&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I hope the implementation is not too intimidating, it does the following&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Check if the annotation methods is allowed or not (curried method is not allowed)&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Check the number of arguments&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If 1, use it as is&lt;/li&gt;
&lt;li&gt;If multiple, convert them into a tuple, and use the tuple as key of cache&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Try to get data from cache using &lt;code class=&quot;language-text&quot;&gt;cache.get(key)&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If cache hit, return the cached value&lt;/li&gt;
&lt;li&gt;If cache miss, evaluate the original annotated method, cache the result using &lt;code class=&quot;language-text&quot;&gt;cache.put(k, v)&lt;/code&gt;, and return the result&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Analysis&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Pros&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it supports different cache storage, eg. you could implement a Cache Backend that support TTL&lt;/li&gt;
&lt;li&gt;it has almost zero syntatic overhead on caller&lt;/li&gt;
&lt;li&gt;able to work on methods of different arguments&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Cons&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It is more complicated to implement&lt;/li&gt;
&lt;li&gt;The implementation is harder to debug&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Here we end this tutorial, as we shown how could you create a generic, parameterize macro using scalameta.
The code is availble &lt;a href=&quot;https://github.com/buaya91/scala-cache&quot;&gt;here&lt;/a&gt;
As an exercise for readers, you can try to improve the cache so that it support async get and put.&lt;/p&gt;
&lt;p&gt;Note: I am not claiming &lt;code class=&quot;language-text&quot;&gt;cache&lt;/code&gt; annotation is a good use-case of macro, ultimately it depends on your team and problem on hand. Nonetheless, I believe everyone should learn a bit of it to enhance your skills, and also to have better understanding on how compiler view your code.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[How multiplayer game sync their state? (Part 2)]]></title><description><![CDATA[Recap In part 1 of the series, we discussed the following: Challenges faced in multiplayer game How to solve unresponsive UI by client…]]></description><link>https://qingwei91.github.io/multiplayer-game2/</link><guid isPermaLink="false">https://qingwei91.github.io/multiplayer-game2/</guid><pubDate>Mon, 01 May 2017 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Recap&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;In &lt;a href=&quot;./multiplayer-game1&quot;&gt;part 1 of the series&lt;/a&gt;, we discussed the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Challenges faced in multiplayer game&lt;/li&gt;
&lt;li&gt;How to solve unresponsive UI by client predictions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I did however gloss over essential server implementation details, which
we will focus on in this article.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Disclaimer: I am not a professional game developer, most of
the knowledge shared is based on what I read and my experience of
small hobby projects. The main goal of this article is to provide
an easy to understand introduction for networking in a multiplayer 
game.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;What’s the role of server?&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Let’s start by defining what a server should do, typically a server should serve as&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;a) Connection point for players&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;In a multiplayer game, players need to access a common endpoint
to reach each other, this is one of the roles of a server
program, even in the P2P communication model, there will be a
connection point for players to exchange their network
information before a P2P connection can be established.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;b) Processing unit&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;In many cases, the server runs the game simulation code, process all
inputs from player and updates the game state. Note that this is not
always the case, some modern games offload lots of processing to the
client side. In this article we will assume it&apos;s the server&apos;s
responsibility to process the game, ie. Make the game tick.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;c) Single source of truth on game state&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;In many multiplayer games, the server program also has authority on 
game state, the main reason is to prevent cheating, and it&apos;s also
easier to reason about when there&apos;s is a single point to get the
correct game state.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Naive Server Implementation&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Let’s start to implement the server in the most straightforward fashion,
then improve from there.&lt;/p&gt;
&lt;p&gt;The core of the game server is a loop that keeps updating the GameState
using a player’s input, commonly know as a TICK, the function signature
is as follows:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff6600;&quot;&gt;(STATE&lt;sub&gt;n&lt;/sub&gt; , INPUT&lt;sub&gt;n&lt;/sub&gt;) =&gt; STATE&lt;sub&gt;n+1&lt;/sub&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;A simplified server code snippet would looks like this&lt;/p&gt;
&lt;h3&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Discussion&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;I hope the code snippets look intuitive and straightforward, the server simply take all inputs from the buffer and applies them in the next &lt;code class=&quot;language-text&quot;&gt;TICK&lt;/code&gt; function to get new GameState. Let’s call this approach &lt;code class=&quot;language-text&quot;&gt;Greedy Game Loop&lt;/code&gt;, as it tries to process things as fast as it could. It is all good, until we think about our lovely universe where sunlight takes 8 minutes to  reach the earth. &lt;/p&gt;
&lt;p&gt;Latency strikes again!&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn2.hubspot.net/hubfs/323094/qingwei/speed_of_light_meme.jpg&quot; title=&quot;speed_of_light_meme.jpg&quot;&gt;&lt;/p&gt;
&lt;p&gt;The fact that the server processes all input from buffer in every &lt;code class=&quot;language-text&quot;&gt;TICK&lt;/code&gt;,
means the GameState will depends on network latency. Diagram
below illustrates why this is a problem&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-side-latency-issue-single.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;The image shows 2 clients sending inputs to server, we observe 2
interesting facts.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Requests took different time from different client to server, 
&lt;strong&gt;1&lt;/strong&gt; unit of time from &lt;span style=&quot;background-color: #fab9d9;&quot;&gt;Client A&lt;/span&gt; to &lt;span style=&quot;background-color: #ccffcc;&quot;&gt;Server&lt;/span&gt;,  &lt;strong&gt;1.5&lt;/strong&gt; unit of time from &lt;span style=&quot;background-color: #ccffff;&quot;&gt;Client B&lt;/span&gt; to &lt;span style=&quot;background-color: #ccffcc;&quot;&gt;Server&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Requests took different time from same client to server,
1st request took &lt;strong&gt;1&lt;/strong&gt; unit of time, 2nd request took &lt;strong&gt;2&lt;/strong&gt; unit of time.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In short, latency is inconsistent, even on the same connection.&lt;/p&gt;
&lt;p&gt;Inconsistent latency combined with &lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;Greedy Game Loop&lt;/code&gt;&lt;/strong&gt; gives several problems, let look at these further.&lt;/p&gt;
&lt;table style=&quot;border-color: #000000; background-color: #ffffff;&quot; border=&quot;3&quot; cellpadding=&quot;5&quot;&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;h4 style=&quot;padding-left: 30px;&quot;&gt;Client Side Prediction will&amp;nbsp;not work&lt;/h4&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;p style=&quot;text-align: left;&quot;&gt;
                    &lt;span style=&quot;font-size: 13px;&quot;&gt;
                    If&amp;nbsp;we cannot predict when the&amp;nbsp;server would
                    receive input (due to latency), we can&apos;t make any
                    predictions with high accuracy. (Forgot how Client
                    Side Prediction works? read&amp;nbsp;
                    &lt;a href=&quot;http://www.cakesolutions.net/teamblogs/how-does-multiplayer-game-sync-their-state-part-1#client-side-prediction&quot;&gt;here&lt;/a&gt;)
                    &lt;/span&gt;
                &lt;/p&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;h4 style=&quot;padding-left: 30px;&quot;&gt;Low latency players&amp;nbsp;get advantages&lt;/h4&gt;
            &lt;/td&gt;
            &lt;td style=&quot;width: 642px;&quot;&gt;
                &lt;span style=&quot;font-size: 13px;&quot;&gt;
                If input takes a shorter time to reach server, it will
                be processed sooner, creating unfair advantage for
                players with fast networks. eg. Two players
                shoot&amp;nbsp;each other at the same time,
                they are supposed to kill each other at the same time,
                but Player B has a lower latency thus killed Player A
                before Player A&apos;s&amp;nbsp;command is processed.
                &lt;/span&gt;
            &lt;/td&gt;
         &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;There is a simple solution to mitigate inconsistent latency,
&lt;a href=&quot;./multiplayer-game1#lockstep&quot;&gt;Lockstep State Update&lt;/a&gt; that we discussed in the previous article. The idea is that server does not proceed until it received input from all players, it has 2 benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it does not require client side prediction&lt;/li&gt;
&lt;li&gt;all players will appear to have the same latency as the slowest
player, removing the advantage we mentioned&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;However, it does not work for fast-paced action games as the
responsiveness is low. (More details can be found on previous article,
thus I will not repeat here.)&lt;/p&gt;
&lt;p&gt;Next section, we will talk about how to make the server side work for
fast paced games.&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Server Reconcilation&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;To solve the problem of inaccurate client side predictions, 
we need to make the client-server interaction more predictable 
from the client point of view. When a Player presses a key on client
side, the client program needs to know when this input would being
processed on server side.&lt;/p&gt;
&lt;p&gt;One possible way is to &lt;strong&gt;let the client suggest when the input should
be applied&lt;/strong&gt;, this way, client side would be able to predict it
reliably. The term &lt;code class=&quot;language-text&quot;&gt;suggest&lt;/code&gt; is used as server might reject the
suggestion if it’s invalid, for example trying to cast a magic when 
your magic power is empty.&lt;/p&gt;
&lt;p&gt;The input should be applied shortly after user input, ie.
&lt;span style=&quot;color: #993366;&quot;&gt;&lt;strong&gt;T&lt;sub&gt;input&lt;/sub&gt; + X&lt;/strong&gt;&lt;/span&gt;,
where X is the delay. The exact value depends on game, normally less
than 100ms to be responsive. Note X can also be zero, in this case
it should happen immediately after user provides input.&lt;/p&gt;
&lt;p&gt;Let’s say we choose X = 30ms, which translates into roughly 1 frame
for 30fps (frame per second), and it takes 150ms for input to travel
to server, there’s a good chance when input reaches the server,
the target frame for input had passed.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-side-independent-latency.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;Looking at the diagram, User A pressed a key at &lt;strong&gt;T&lt;/strong&gt;, which supposed
to be processed at &lt;strong&gt;T + 30ms&lt;/strong&gt;, but the input is received by server
at &lt;strong&gt;T + 150ms&lt;/strong&gt;, due to latency, which already passed &lt;strong&gt;T + 30ms&lt;/strong&gt;.
This is the problem we are going to solve in this section&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;How does server apply input that should happen in the past?&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;The Concept&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;You might have recalled client side prediction has a similar issue of
incorrect predictions due to lacking information of opponents, and
the incorrect predictions will later be corrected by state updates
from server using &lt;strong&gt;&lt;a href=&quot;./multiplayer-game1#reconcilation&quot;&gt;Reconcilation&lt;/a&gt;&lt;/strong&gt;.
The same technique can be used here, the only difference is that
we are correcting the GameState on server using user input from clients.&lt;/p&gt;
&lt;p&gt;All user input needs to be tagged with a timestamp, this timestamp will then be used to tell the server when to process this input.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-side-reconcilation1.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;sub&gt;Note: On the first dotted line, it’s &lt;span style=&quot;color: #000000;&quot;&gt;&lt;strong&gt;Time X&lt;/strong&gt;&lt;/span&gt; on Client side, but &lt;span style=&quot;color: #000000;&quot;&gt;&lt;strong&gt;Time Y&lt;/strong&gt;&lt;/span&gt; on Server side, this is an interesting nature of multiplayer game (and many other distributed system), as client and server &lt;g class=&quot;gr_ gr_201 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace&quot; id=&quot;201&quot; data-gr-id=&quot;201&quot;&gt;runs&lt;/g&gt; independently, the time of client and server typically will be different,  our algorithm will handle the difference.&lt;/sub&gt;&lt;/p&gt;
&lt;p&gt;Diagram above shows interaction between 1 Client and the Server,&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Client sends an Input with timestamp telling server this input of
Client A should happen on &lt;span style=&quot;color: #ff0000;&quot;&gt;Time X&lt;/span&gt;. &lt;/li&gt;
&lt;li&gt;Server received the request on &lt;span style=&quot;color: #008000;&quot;&gt;Time Y&lt;/span&gt;,
let’s assume Time X is older than Time Y for the sake of discussion.
When developing our algorithm, we should not
assume &lt;span style=&quot;color: #008000;&quot;&gt;Time Y&lt;/span&gt; is bigger or less
than &lt;span style=&quot;color: #ff0000;&quot;&gt;Time X&lt;span style=&quot;color: #000000;&quot;&gt;,
this will give us more flexibility.&lt;/span&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
The &lt;span style=&quot;color: #ff0000;&quot;&gt;&lt;strong&gt;RED BOX&lt;/strong&gt;&lt;/span&gt; is where
reconcilation happens, the server needs to apply the Input X to the
latest game state so that it appears that input X happens
on &lt;span style=&quot;color: #ff0000;&quot;&gt;Time X&lt;/span&gt;.&lt;/li&gt;
&lt;li&gt;GameState from server also includes timestamp, which is required 
for both server side and client side reconcilation.&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;Details of Reconcilation (&lt;strong&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;the RED BOX&lt;/span&gt;&lt;/strong&gt;)&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Server needs to maintain&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;span style=&quot;color: #000000;&quot;&gt;GameStateHistory        &lt;/span&gt;&lt;/strong&gt;&lt;span style=&quot;color: #000000;&quot;&gt;- history of GameState within a time frame &lt;strong&gt;P&lt;/strong&gt;, eg. all GameState since a second ago&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ProcessedUserInput&lt;/strong&gt; - history of UserInput processed within a time frame &lt;strong&gt;P&lt;/strong&gt;, ie. same value as time frame of GameStateHistory&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;UnprocessedUserInput&lt;/strong&gt; - UserInput received, but not processed yet, also within time frame &lt;strong&gt;P&lt;/strong&gt;
&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-buffer0.png?raw=true&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When server received an input from user, it should be inserted into the &lt;strong&gt;UnprocessedUserInput&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-buffer1.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Next, when server ticks, &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Check if there is any user input in the &lt;strong&gt;UnprocessedUserInput&lt;/strong&gt; which is older than the current frame&lt;/li&gt;
&lt;li&gt;If not, you are good, simply run the game logic with latest GameState and corresponding Inputs (if any), and broadcast to clients.&lt;/li&gt;
&lt;li&gt;If yes, it means some of the game states generated previously are wrong due to missing information, we need to correct it&lt;/li&gt;
&lt;li&gt;First we need to find the oldest unprocessed user input, let say it is on Time N, (Tips: this operation is fast if the **UnprocessedUserInput **is sorted).&lt;/li&gt;
&lt;li&gt;Then we need to obtain the corresponding GameState on Time N from &lt;strong&gt;GameStateHistory&lt;/strong&gt;, and the processed user input on Time N from &lt;strong&gt;ProcessedUserInput&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Using these 3 pieces of data, we can create a new GameState which is more accurate.
&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-buffer2.png?raw=true&quot;&gt;&lt;/li&gt;
&lt;li&gt;Then move the Unprocessed Input N to ProcessedUserInput, so that we can use it for reconcilation in the future.&lt;/li&gt;
&lt;li&gt;Update the GameState N in &lt;strong&gt;GameStateHistory&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Repeat step 4 to 7, for &lt;code class=&quot;language-text&quot;&gt;N+1, N+2 ...&lt;/code&gt;, until we get latest GameState.&lt;/li&gt;
&lt;li&gt;Server sends out the latest frame to all players. &lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Discussion&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;Server side reconcilation suffers similar problems as client side
reconcilation, when we reconcile, it means we did something wrong,
and we are correcting by changing history. This means we cannot apply
irreversible outcomes, i.e, killing a players, such irreversible
outcomes will only be applied when it goes out of the
&lt;strong&gt;GameStateHistory&lt;/strong&gt;, ie. when it cannot be rewriten anymore.&lt;/p&gt;
&lt;p&gt;In addition, the incorrect GameState sometime causes awful UI jump.
Diagram below illustrate how it happens&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-error0.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;Entity starts at top left corner, it is moving toward
right hand side, 5 ticks later, it shifted towards right, but
then server received the user input saying that the entity changed
direction on Tick N, so the server reconciles the game state, and
now suddenly the entity &lt;strong&gt;jumps&lt;/strong&gt; to the bottom left on the canvas.&lt;/p&gt;
&lt;p&gt;I might be exaggerating the effect, sometimes entity does not move
that much, thus the jump would less obvious, but it is still noticeable
in many cases. We can control the jump by changing the size
of &lt;strong&gt;GameStateHistory&lt;/strong&gt;, &lt;strong&gt;UnprocessedUserInput&lt;/strong&gt; and &lt;strong&gt;ProcessedUserInput&lt;/strong&gt;,
the smaller the buffer size, the less jump there would be, because
we would be less tolerant on input that arrives late, eg. If Input
that is late for more than 100ms is ignored, player with ping &gt; 200ms
wont be able to play the game.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;We can trade &lt;strong&gt;network latency tolerance&lt;/strong&gt; for more &lt;strong&gt;accurate game state update&lt;/strong&gt;,
or vice versa.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;One popular technique to overcome the problem of inaccurate Game State 
is &lt;strong&gt;Entity Interpolation&lt;/strong&gt;, the idea is to smoothen the jump by
spreading it out within a short amount of time.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/server-error1.png?raw=true&quot;&gt;&lt;/p&gt;
&lt;p&gt;I will not include implementation details of &lt;strong&gt;Entity Interpolation&lt;/strong&gt;
in this article, however some references will be provided at the bottom of article.&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Wrapping Up&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;We have talked about how both client and server might work in a multiplayer game.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/buaya91/image-storage/blob/master/multiplayer-game-networking/wrapup.png?raw=true&quot;&gt;In general, a multiplayer game has 3 loosely coupled loops, &lt;strong&gt;Server Game Loop&lt;/strong&gt;, &lt;strong&gt;&lt;g class=&quot;gr_ gr_149 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace&quot; id=&quot;149&quot; data-gr-id=&quot;149&quot;&gt;Client side&lt;/g&gt; prediction Loop&lt;/strong&gt;, and &lt;strong&gt;&lt;g class=&quot;gr_ gr_150 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace&quot; id=&quot;150&quot; data-gr-id=&quot;150&quot;&gt;Client side&lt;/g&gt; UI Rendering Loop&lt;/strong&gt;. By having some sort of buffer in between them, their execution can be decoupled, giving us &lt;g class=&quot;gr_ gr_205 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace&quot; id=&quot;205&quot; data-gr-id=&quot;205&quot;&gt;flexibility&lt;/g&gt; to create better gaming experience.&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Here ends my article on Multiplayer games, I learned much of this
knowledge from experts in this field, building a 
&lt;a href=&quot;https://github.com/buaya91/scalajs-snake&quot;&gt;simple multiplayer game&lt;/a&gt; also helps a lot.
I’ve only show one way to implement a multiplayer server,
there are more other ways, depending on what kind of game you’re
building, I encourage you to explore some of those ideas by building a simple game.&lt;/p&gt;
&lt;p&gt;Thanks for reading, happy hacking !&lt;/p&gt;
&lt;h2&gt;&lt;span style=&quot;text-decoration: underline;&quot;&gt;&lt;strong&gt;References and Further Reading&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;[Entity Interpolation] - &lt;a href=&quot;http://www.gabrielgambetta.com/fpm3.html&quot;&gt;http://www.gabrielgambetta.com/fpm3.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://gafferongames.com/networked-physics/snapshots-and-interpolation/&quot;&gt;&lt;span&gt;[Entity Interpolation] - &lt;/span&gt;http://gafferongames.com/networked-physics/snapshots-and-interpolation/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;[Lag Compensation] - &lt;a href=&quot;https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking#Lag_compensation&quot;&gt;https://developer.valvesoftware.com/wiki/Source&lt;em&gt;Multiplayer&lt;/em&gt;Networking#Lag_compensation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Fantastic meetings and where to find them]]></title><description><![CDATA[Anecdotally most people in the software industry hate meetings; a meeting is a soul-sucking dementor. Jokes aside, I think it’s fair to say…]]></description><link>https://qingwei91.github.io/meetings/</link><guid isPermaLink="false">https://qingwei91.github.io/meetings/</guid><pubDate>Sat, 01 Apr 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Anecdotally most people in the software industry hate meetings; a meeting is a soul-sucking dementor. Jokes aside, I think it’s fair to say that people feel meetings are taking too much time and the process is often painful.&lt;/p&gt;
&lt;p&gt;In this post, I’ll try to provide a few rules of thumb that I believe can make meetings less painful and more efficient.&lt;/p&gt;
&lt;h2&gt;Rule 1: Always reiterate your goal before start&lt;/h2&gt;
&lt;p&gt;How many times do you attend a meeting without a goal in mind?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Me: Dozens of them&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The &lt;code class=&quot;language-text&quot;&gt;why&lt;/code&gt; is the first question you should answer before stepping into a meeting room. If you can’t tell why are we are having a meeting, there is something missing in your communication process. You should fix it ASAP.&lt;/p&gt;
&lt;p&gt;In many cases, only a few people know the goal clearly. If we conduct a meeting without communicating the goal to the rest of team, one or more of the following might happen:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;People realize they don’t know the goal and start asking questions to figure it out&lt;/li&gt;
&lt;li&gt;The rest of the team thought they knew the goal well enough and are using this incorrect understanding to make decisions&lt;/li&gt;
&lt;li&gt;People who feel the goal isn’t clear and then tend to follow an other’s opinion&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In first case, you lost time but still can reach the goal eventually. For #2 and #3 it gets worse:
you will get false sense of validation or invalidation on a decision as people agree (or disagree) without enough information.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A quick remedy for this problem is to simply reiterate the goal in a straightforward manner before meeting start.&lt;/strong&gt; This will likely be a responsibility of meeting initiator. If you call for a meeting, you should make it clear why to have one. If you are attending a meeting without a goal, ask for one to be added to the invite.&lt;/p&gt;
&lt;p&gt;This extra step only cost you a few minutes but the benefit is huge. It’s important to discover what people don’t know as soon as possible (like catching bug in software).&lt;/p&gt;
&lt;h2&gt;Rule 2: Limit the level of details in discussion&lt;/h2&gt;
&lt;p&gt;A common theme in meetings is &lt;code class=&quot;language-text&quot;&gt;discussion&lt;/code&gt;. Software development is largely about making decisions. Quite often individuals can make decisions on things on their own but sometimes a decision happens to have bigger implications. This warrants a meeting among the team or between several teams.&lt;/p&gt;
&lt;p&gt;It is important to conduct discussion in an efficient way. Unsurprisingly, this is not the case for many organizations.&lt;/p&gt;
&lt;p&gt;From my admittedly limited experience, one big problem in meeting is that people tends to open up related questions before a discussion point is concluded.&lt;/p&gt;
&lt;p&gt;For example, when we are trying to reach agreement on domain model, an engineer might unconciously start asking questions about implementation, eg. how does a domain model map into relational model of our favorite RDBMS.&lt;/p&gt;
&lt;p&gt;Sometimes, derail is a necessary evil. Some high level decisions depend on some very specific details of low level components, for example when deciding what latency a service should guarantee. We must consider technical feasibility to make informed decision.&lt;/p&gt;
&lt;p&gt;However, in general, it is completely avoidable.&lt;/p&gt;
&lt;p&gt;To avoid this problem, we have to &lt;strong&gt;scope the level of detail during discussion&lt;/strong&gt;. There are several techniques can be used:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Assign someone to guide the direction of discussion and try to resolve discussion point by point&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Be explicit throughout the process (like a sport commentator) by&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Repeating the discussion point (preferably in question form) before start&lt;/li&gt;
&lt;li&gt;Note sub-conclusion points whenever an agreement/disagreement is reached&lt;/li&gt;
&lt;li&gt;Note a conclusion to close the discussion before proceeding to next point&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Derailment is only allowed if justification is provided, e.g. we need to discuss project budget first as it affects our decision of team resource distribution.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; The &lt;code class=&quot;language-text&quot;&gt;sub-conclusion&lt;/code&gt; can be really simple. Just reiterate on every significant progress in the meeting, eg. “It seems like no one thinks option B is going to work, so we are left with option A and C. Let’s focus on A first to see if it fits our usecase”&lt;/p&gt;
&lt;p&gt;Despite it’s simplicity, you’ll be surprised how effective point #2 is when put into practice. By explicitly stating the progress of meeting, you’ll be able to grab people’s attention and give the team a sense of progress by having fast feedback loop (We all love feedback loop!)&lt;/p&gt;
&lt;h2&gt;Rule 3: Always have an agenda&lt;/h2&gt;
&lt;p&gt;We’ve talked about having clear goals and limit the discussion. It’s natural to think about meeting agendas, I believe having a meeting agenda facilitates earlier points we’ve discussed.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;An agenda should be derived from the goal(s) of the meeting and be arranged in a logical way that eventually leads to the goal&lt;/strong&gt; (this sounds recursive, bear with me).&lt;/p&gt;
&lt;p&gt;For example, if we are trying to decide what protocol to be used for multiple microservices, the agenda might look like this&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;* Problem to be solved including requirements
* Proposals
* Benefit cost analysis of each proposal
* Discussion and decisions&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By trying to come out with an agenda, you will discover more details before having a meeting. Items like analysis and proposals should really be prepared before the meeting; people only care about the result of the analysis, not the progress. It is easier for people to prepare before meeting with a clear agenda.&lt;/p&gt;
&lt;p&gt;The agenda definition can be driven by meeting initiator and collaboration with the team, allowing the rest of the team to add missing points in advance.&lt;/p&gt;
&lt;p&gt;Things like this may sounds obvious but still it was frequently neglected and causes unnecessary confusion.&lt;/p&gt;
&lt;h2&gt;Rule 4: Choose the right people to be in the meeting&lt;/h2&gt;
&lt;p&gt;Another common problem of meetings is that it involves the wrong people. Sometimes we include more people than necessary. Sometimes we leave out important people that can provide crucial information. Sometimes both.&lt;/p&gt;
&lt;p&gt;People are sometimes lazy to figure out who to invite and invite the whole team. Such a strategy might work but it is not very efficient. People specialize for a reason and letting people focus on their expertise is more productive.&lt;/p&gt;
&lt;p&gt;On the other hand, it’s also easy to leave out important people, especially when they are in different team, and we need to make a decision involving cross team effort.&lt;/p&gt;
&lt;p&gt;Choosing the correct people is only possible if you have a clear understanding on what to discuss and more importantly what NOT to discuss (see #1 and #2).&lt;/p&gt;
&lt;p&gt;This rule, when executed properly, will save your organization substantial amount of time.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;To summarize, a fantastic meeting usually consists of&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Clear goal&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Well defined agenda&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Close to zero derailment&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;People with the right information&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I hope you find this post useful. Feedback is welcome. Feel free to drop me a message =)&lt;/p&gt;</content:encoded></item><item><title><![CDATA[How multiplayer game sync their state? (Part 1)]]></title><description><![CDATA[The main problem in multiplayer game In multiplayer game, one of the most complex issue is to keep all player’s state in sync with server…]]></description><link>https://qingwei91.github.io/multiplayer-game1/</link><guid isPermaLink="false">https://qingwei91.github.io/multiplayer-game1/</guid><pubDate>Wed, 01 Mar 2017 00:00:00 GMT</pubDate><content:encoded>&lt;h3&gt;The main problem in multiplayer game&lt;/h3&gt;
&lt;p&gt;In multiplayer game, one of the most complex issue is to keep all player’s state in sync with server state.
There are a few good articles around this topic on the internet. However, some details are missing here and there, which may be confusing for beginners in field of game programming, I hope I can clear things up in this article.&lt;/p&gt;
&lt;p&gt;I’ll present a few techniques commonly used in this problem space.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Before&lt;/strong&gt; we jump into the problem, let’s have an overview on how multiplayer game generally works.&lt;/p&gt;
&lt;p&gt;Typically, a game program needs to simulate&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the changes in an environment with respect of time and players input&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Game is stateful program, it depends on time (be it real or logical time), for example, PACMAN is simulating an environment that ghosts will keep moving.&lt;/p&gt;
&lt;p&gt;A multiplayer game is no exception, just that the complexity is higher due to interaction between multipler players.&lt;/p&gt;
&lt;p&gt;Let’s use the classic Snake Game as an example, assume we use a server-client settings. The core game logic works like this&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Read user inputs which can be one of [←, ↑, →, ↓], to change the direction of snake.&lt;/li&gt;
&lt;li&gt;Apply user input if any, which change the direction of snake.&lt;/li&gt;
&lt;li&gt;Move snake by 1 unit space&lt;/li&gt;
&lt;li&gt;Check if any snakes bump into enemy/wall/self, remove them from the game.&lt;/li&gt;
&lt;li&gt;Repeat&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This logic will be run at a fixed interval on server side, as below, each loop is a called a &lt;code class=&quot;language-text&quot;&gt;frame&lt;/code&gt; or a &lt;code class=&quot;language-text&quot;&gt;tick&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Unit&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/**
      * 1. Read user inputs which can be one of [←, ↑, →, ↓], to change the direction of snake.
      * 2. Apply user input if any, which change the direction of snake.
      * 3. Move snake by 1 unit space
      * 4. Check if any snakes bump into enemy/wall/self, remove them from the game.
      * 5. Broadcast the new game state to all clients
      */&lt;/span&gt;
      Thread&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sleep&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the simplest client would just listen to server update and render every frame received to players.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;scala&quot;&gt;&lt;pre class=&quot;language-scala&quot;&gt;&lt;code class=&quot;language-scala&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; Client &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; onServerUpdate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; GameState&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      renderGameState&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;The problem&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;How do we sync the game world between server and different players in real time?&lt;/p&gt;
&lt;h2&gt;Lockstep State update&lt;/h2&gt;
&lt;h3&gt;Concept&lt;/h3&gt;
&lt;p&gt;To make sure all client are in sync, the simplest way is to let client send update to server in a fixed interval,
let’s say every 30ms. The update would contains user input, it can also represent &lt;code class=&quot;language-text&quot;&gt;no user input&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Once server gather input from &lt;strong&gt;all user&lt;/strong&gt;, it can then proceed with next tick using those inputs.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/lockstep-single.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;The image above show how one client interact with server, I hope the problem is obivous, client will stay idle from &lt;strong&gt;T0&lt;/strong&gt; to &lt;strong&gt;T1&lt;/strong&gt;, waiting for server update to proceed. The latency can range from 50ms to 500ms, depending on network quality, and human will notice any delay over 100ms, so freezing the user interface for 200ms can be big problem for some games. This is not the only issue with lockstep approach.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/lockstep-multi.png&quot; alt=&quot;img&quot;&gt;
This image is slightly more complicated, showing multi-client interaction with server, you can see that client B have a slower network connection, thus although both A and B send input to server at &lt;strong&gt;T0&lt;/strong&gt;, update from B reach server at &lt;strong&gt;T2&lt;/strong&gt; instead of &lt;strong&gt;T1&lt;/strong&gt;, server only proceed once it receive all updates which is &lt;strong&gt;T2&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This means&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the latency of the game is now the latency of the most lagged player&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;we are punishing all players because one of them is lagging, eventually all players will leave your game …&lt;/p&gt;
&lt;p&gt;Not to say there’s a possiblity that client B might be disconnected, thus will block the server until connection timeout.&lt;/p&gt;
&lt;h3&gt;Discussion&lt;/h3&gt;
&lt;p&gt;There are some problems including 2 of which we just mentioned :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Client will not be responding until receive state update from server, horrible user experience.&lt;/li&gt;
&lt;li&gt;Game responsiveness depends on the most lagged players, playing with a friend with DSL connection? Have Fun&lt;/li&gt;
&lt;li&gt;The connection would be really chatty, clients need to send some useless heartbeat data regularly so that server can confirm it have got all information needed to step forward, which is not efficient.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;First of all, certain kind of games are immune to these problems, most &lt;code class=&quot;language-text&quot;&gt;Turn-based&lt;/code&gt; game actually use some variant of
such model, as client are supposed to wait. For slow-paced game, small amount of delay is acceptable too, for example Farm Ville.&lt;/p&gt;
&lt;p&gt;A great example is &lt;strong&gt;Chess&lt;/strong&gt;, where 2 players take their own turn, assuming each turn takes 10 secs&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;user are expect to wait each other for 10 secs, they can wait&lt;/li&gt;
&lt;li&gt;2 players take turn alternatively, so lagged player does not affect other player&lt;/li&gt;
&lt;li&gt;each turn takes on average 5 secs, 1 request every 5 secs is fine&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;But for fast-paced game, like all FPS, all of these problems make lockstep approach not suitable for them.
We will see how we can solve these problem in the rest of articles.&lt;/p&gt;
&lt;h2&gt;Client Predictions&lt;/h2&gt;
&lt;p&gt;Let’s first solve the problem of user-responsiveness, game response after 500 millis after user press a key destroy
the gaming experience. How to solve this problem?&lt;/p&gt;
&lt;h3&gt;Concept&lt;/h3&gt;
&lt;p&gt;Some of you might have already have the answer, instead of waiting on server update, client can actually emulate the game by running game logic locally (ie. on the client’s machine).&lt;/p&gt;
&lt;p&gt;Let’s assume to produce game state at &lt;code class=&quot;language-text&quot;&gt;Tn&lt;/code&gt;, we need state at &lt;code class=&quot;language-text&quot;&gt;Tn-1&lt;/code&gt; and all user input at &lt;code class=&quot;language-text&quot;&gt;Tn-1&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-single.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;The idea is simple, let’s have a fixed update rate, which is &lt;code class=&quot;language-text&quot;&gt;1 unit of time&lt;/code&gt; in this example, client send input to server at &lt;strong&gt;T0&lt;/strong&gt;, and emulate the game state at &lt;strong&gt;T1&lt;/strong&gt;, so client can then render the game without having to wait the state update from server, which only arrive at &lt;strong&gt;T3&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This approach only works if&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Game state update logic is deterministic, ie. no randomness, or in some way, referentially transparent, so that server and client produce the same game state given the same input.&lt;/li&gt;
&lt;li&gt;Client have all information required to run game logic&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;1 is not always true, but we can try to make it as similar as possible, and ignore the small differences, ie. floating points computation of different platform, use the same seed for pseudo-random algorithm.&lt;/p&gt;
&lt;p&gt;2 is also not true, for example&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-multi.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;In the image above, Client A still try to emulate game state at &lt;strong&gt;T1&lt;/strong&gt; using the information it has from &lt;strong&gt;T0&lt;/strong&gt;, but Client B also submitted input at &lt;strong&gt;T0&lt;/strong&gt;, which Client A is not aware of, this means Client A’s prediction of &lt;strong&gt;T1&lt;/strong&gt; will be wrong. Luckily, since Client A still receive state of &lt;strong&gt;T1&lt;/strong&gt; from server, at &lt;strong&gt;T3&lt;/strong&gt;, client have the chance to correct it’s mistake.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Client side need to figure out if the previous emulation is correct, and how to resolve the conflicts.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The resolution of conflicts is normally called &lt;strong&gt;Reconcilation&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Implementation of &lt;strong&gt;Reconcilation&lt;/strong&gt; varies depending on use case, I’ll show a simple one, which we just throw away our prediction and replace it with the correct state from server.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Client need to maintain 2 buffers, one for predictions, one for user input, which can be used to compute predictions.
Remember, &lt;strong&gt;State Tn&lt;/strong&gt; is computed using &lt;strong&gt;State Tn-1&lt;/strong&gt; and &lt;strong&gt;Input Tn-1&lt;/strong&gt;, it will be empty at first.
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-initbuffer.png&quot; alt=&quot;img&quot;&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When player press an arrow key, the input in stored in InputBuffer, and client will also produce predictions which is then used to render the view, the prediction is stored in PredictionBuffer.&lt;/p&gt;
&lt;div&gt;
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-buffer1.png&quot;&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-buffer2.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;
&lt;p&gt;When server State0 is received, and does not match with the client Prediction0, we can replace Prediction0 with State0, and recompute Prediction1 using Input0 and State0.&lt;/p&gt;
&lt;div&gt;
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-reconciledbuffer.png&quot; style=&quot;display:block;&quot;&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;After reconcilation, we can safely removed State0 and Input0 from the buffer, as we can confirm we got it correct.
&lt;img src=&quot;https://raw.githubusercontent.com/buaya91/image-storage/master/multiplayer-game-networking/clientprediction-droppedbuffer.png&quot; alt=&quot;img&quot;&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Note: this reconcilaton comes with a drawback, there might be glitches on view if server state and client prediction differ too much, for example if we predict enemy is moving south on &lt;strong&gt;T0&lt;/strong&gt;, but at &lt;strong&gt;T3&lt;/strong&gt; we realize it move towards north, and reconcile by simply using state from server, the enemy will bounce from towards north to reflect it’s correct position. There are ways to handle this problem, but it will not be in this article.&lt;/p&gt;
&lt;h3&gt;Discussion&lt;/h3&gt;
&lt;p&gt;Client prediction technique gives us a big benefit&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Client run on it’s own update rate, independent to server update rate, so that if server is having hiccups, it does not affect client side frame rate.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It inevitably comes with some complexity :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We need to handle more state and logic on client side, (Prediction buffer, state buffer, prediction logic).&lt;/li&gt;
&lt;li&gt;We need to decide how to handle conflict between prediction and real state from server.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;And it still leave us with some problem :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;View glitches due to wrong predictions&lt;/li&gt;
&lt;li&gt;Chatty connection&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;In this article, we went through 2 ways of approaching multiplayer game networking :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Lockstep state update&lt;/li&gt;
&lt;li&gt;Client prediction&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Each comes with it’s own set of trade off, so far we havent get a closer look on the server side, which will be covered in next article some time later.&lt;/p&gt;
&lt;p&gt;Thanks for reading !&lt;/p&gt;</content:encoded></item></channel></rss>