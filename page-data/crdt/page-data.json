{"componentChunkName":"component---src-templates-blog-post-js","path":"/crdt/","result":{"data":{"site":{"siteMetadata":{"title":"All models are wrong","author":"Qing Wei"}},"markdownRemark":{"id":"2a686378-c712-58a2-837d-6e7dcf48eb66","excerpt":"Overview This article shows how to implement CRDT using typeclass in Scala 3. I used this exercise to learn more about CRDT, while picking…","html":"<h1>Overview</h1>\n<p>This article shows how to implement CRDT using typeclass in Scala 3. I used this exercise to learn more about CRDT, while picking up some new features from Scala 3.</p>\n<p>For readers who are unfamiliar to CRDT, CRDT is a kind of data structure that are replicated (typically across network), they can be updated independently and is guarantee to converge eventually without the need of a centralized controller (ie. a server).</p>\n<p>One of the most common use case is collaborative text editing.</p>\n<p>To learn more, I recommend this survey study: <a href=\"https://hal.inria.fr/inria-00555588/document\">A comprehensive study of Convergent and Commutative Replicated Data Types</a>.</p>\n<p>Note all source code used in this post can be found <a href=\"https://github.com/qingwei91/crdt-scala3/\">here</a>.</p>\n<h1>CmRDT Algebras</h1>\n<p>CmRDT (Commutative Replicated Data Types) is a type of CRDT, it is sometimes called op-based CRDT. The key characteristic of it is that changes on data are synced by operations instead of sending the whole state. This is in contrast with CvRDT, which sync by sending the whole state over the network, there are some trade-off between these 2 types, but we wont delve into them in this piece.</p>\n<p>We will explore the algebra of CmRDT, and encode them in Scala 3.</p>\n<p>To fully define CmRDT and corresponding algebra, we need to define a few concepts:</p>\n<ol>\n<li><code class=\"language-text\">State</code> refers to data structure that represents CmRDT</li>\n<li><code class=\"language-text\">Local Copy</code> refers to CmRDT’s state that is local with respect to the operations</li>\n<li><code class=\"language-text\">Local Operation</code> is data structure that represents operations on a local copy</li>\n<li><code class=\"language-text\">Remote Copy</code> refers to CmRDT’s state that is remote with respect to the operations</li>\n<li><code class=\"language-text\">Remote Operation</code> is data structure that represents operations on a remote copy, and need to be sync to a local copy</li>\n</ol>\n<p>Before defining the algebra, let’s go through the overall flow informally just to get a feel of CmRDT, I will use the most trivial CmRDT as a example, which is a Counter.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6328353ce0b4de6ed49eeb9fcdc9ab40/e088a/counter-crdt.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAABibAAAYmwFJdYOUAAAByklEQVQ4y5WS6W6jQBCE/f4vFuVHlMjK5tpFAR8BvDAwzH0AKTMOMTYiSssyoumvp3qqV/0Q1lqljLVeKd11XX8VbdsKLZRT+HfeheQqPJpGxnHx9JSkKXXOn2Ndf+xlvX3YPtxGt3fJHdc85E8wpfL9vXx+3qVp45y7ho0z62x9E93cp/dMs2O++4KhlnPNmMIPCq9le++JIKUoS14aayayQyelVb8YgvPzG1kFjlSEk4Ym5QKJw6N9XZKa0vobRrPtx45lNX3MpVEomoU5F+uEbXbZ/0P+PTMebddqKqvo4FuvtVZKwbxxeLRDRkr1uiFCme4rf5pZSmmM0UaP8wPWQ+ATyNBIDIHKMPnoc4MilF4sBpJFUaRpWg4hOAOMsgkcTkPL8RVugwQfVDhradP8S1IujkImsrshQsvjJgoxVoxhrPuzE29RvEniyZIEGTg5z/P9fp9l2cUIQctjXDOh29ZfLgmiqqrxMmaDVBQuDzcv0WsVnKANrXNyePn4YcOECL7gFkCd4LfoL9kW4pW0fbcMX60neCxJo+qk+PHkCQwBMBBKGGdcit/BwUbYA/HnPs8GBp6RHdzCt2UYizgPByeXYWg8f/0E5VTPAFi6WtkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"counter-crdt\"\n        title=\"counter-crdt\"\n        src=\"/static/6328353ce0b4de6ed49eeb9fcdc9ab40/fcda8/counter-crdt.png\"\n        srcset=\"/static/6328353ce0b4de6ed49eeb9fcdc9ab40/12f09/counter-crdt.png 148w,\n/static/6328353ce0b4de6ed49eeb9fcdc9ab40/e4a3f/counter-crdt.png 295w,\n/static/6328353ce0b4de6ed49eeb9fcdc9ab40/fcda8/counter-crdt.png 590w,\n/static/6328353ce0b4de6ed49eeb9fcdc9ab40/efc66/counter-crdt.png 885w,\n/static/6328353ce0b4de6ed49eeb9fcdc9ab40/e088a/counter-crdt.png 1015w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>We can view this sequence diagram from top to bottom.</p>\n<ol>\n<li>The system contains 2 data structures, replicated, labeled as Local copy and Remote copy respectively, both initialized to 0.</li>\n<li>Local copy performs <code class=\"language-text\">Add 2</code> operation, changing state from 0 to 2</li>\n<li>Concurrently, Remote copy performs <code class=\"language-text\">Add 3</code> operation, changing state from 0 to 3</li>\n<li>Local copy send <code class=\"language-text\">Add 2</code> operation to remote copy</li>\n<li>Remote copy apply <code class=\"language-text\">Add 2</code>, changing state from 3 to 5</li>\n<li>Remote copy send <code class=\"language-text\">Add 3</code> operation to local copy</li>\n<li>Local copy apply <code class=\"language-text\">Add 3</code>, changing state from 2 to 5</li>\n<li>Finally, both copy are in sync and have the same value as 5</li>\n</ol>\n<p>From the flow above, we can notice that local operations can happen concurrently, they will then need to be sync to remote copies, in this process, the order of operations are not the same in different copies, but we should still get the same result. This property is known as Commutative, which is where the name comes from.</p>\n<p>Now, we can enter the algebras and constraints, it can be distilled into the following rules:</p>\n<ol>\n<li><code class=\"language-text\">localChange</code> operation, this applies a <code class=\"language-text\">Local Operation</code> to a <code class=\"language-text\">Local Copy</code>, it will update the local state</li>\n<li><code class=\"language-text\">syncRemote</code> operation, this applies a <code class=\"language-text\">Remote Operation</code> to a <code class=\"language-text\">Local Copy</code>, it will update the local state</li>\n<li><code class=\"language-text\">localChange</code> and <code class=\"language-text\">syncRemote</code> should be commutative, the order of applying them shouldn’t matter</li>\n</ol>\n<h2>Encoding Algebras in code</h2>\n<p>Now that we have the algebra, let’s encode them in Scala, I am using Scala 3, I will try to be as abstract and precise as possible.</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">trait</span> CmRDT<span class=\"token punctuation\">[</span>A<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">type</span> RemoteOp\n  <span class=\"token keyword\">type</span> LocalOp\n  <span class=\"token keyword\">type</span> ProjectValue\n  extension <span class=\"token punctuation\">(</span>a<span class=\"token operator\">:</span> A<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">def</span> syncRemote<span class=\"token punctuation\">(</span>op<span class=\"token operator\">:</span> RemoteOp<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> A\n    <span class=\"token keyword\">def</span> change<span class=\"token punctuation\">(</span>op<span class=\"token operator\">:</span> LocalOp<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>RemoteOp<span class=\"token punctuation\">,</span> A<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">def</span> read<span class=\"token operator\">:</span> ProjectValue\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here, we model CmRDT as a typeclass, let’s inspect all elements:</p>\n<ul>\n<li>type param <code class=\"language-text\">A</code>, we are implementing it as typeclass, so <code class=\"language-text\">A</code> represent any data type that can be CmRDT</li>\n<li><code class=\"language-text\">RemoteOp</code> type member, this represents all possible Remote Operations</li>\n<li><code class=\"language-text\">LocalOp</code> type member, this represents all possible Local Operations</li>\n<li><code class=\"language-text\">ProjectValue</code> type member, this wasn’t mention on the section above, it represents the value we want to read from CmRDT without all of the metadata, its purpose will be more apparent later when we look at testing</li>\n<li>\n<p>All 3 methods are implemented as extension methods, this is a <a href=\"https://docs.scala-lang.org/scala3/book/ca-extension-methods.html\">new feature</a> from Scala 3</p>\n<ul>\n<li><code class=\"language-text\">syncRemote</code> applies a <code class=\"language-text\">RemoteOp</code> to a local copy, and return a new A, this means it can be implemented as pure function</li>\n<li><code class=\"language-text\">change</code> applies a <code class=\"language-text\">LocalOp</code> to a local copy, it returns <code class=\"language-text\">RemoteOp</code> and <code class=\"language-text\">A</code>, it returns <code class=\"language-text\">RemoteOp</code> because for every local operation applied, we need to apply a corresponding <code class=\"language-text\">RemoteOp</code> to remote copies, which will come from this method</li>\n<li><code class=\"language-text\">read</code> returns the <code class=\"language-text\">ProjectValue</code>, this is useful because sometimes <code class=\"language-text\">A</code> can be a relatively complicated data structure that stores metadata like nodeId etc, but our consumer code only care about the projected value, for example, an array or a set.</li>\n</ul>\n</li>\n</ul>\n<p>These is all we need to describe a CmRDT without committing to specific implementation details. Encoding algebra as typeclass allows us to verify checks against it.</p>\n<h2>Implementing test using encoded algebra</h2>\n<p>How do we test CmRDT? The rules are quite simple, we just need to make sure operations are commutative, ie. the order of operations does not affect the final results.</p>\n<p>Informally, we can encode it as <code class=\"language-text\">f(g(x)) == g(f(x))</code> where x is the State, and <code class=\"language-text\">f</code> and <code class=\"language-text\">g</code> are both operations.</p>\n<p>Now we want to implement these rules using automated checks, let’s start with pseudo-code:</p>\n<ol>\n<li>Initialize a collection of <code class=\"language-text\">N</code> CmRDT to the same value, for each CmRDT we also need to keep a buffer of remote Op, initialized to empty buffer</li>\n<li>Randomly pick one of the data structure A</li>\n<li>\n<p>Randomly choose between performing a local change, or syncing a remote operation</p>\n<ul>\n<li>Note that we will need the ability to randomly generate a local change, this is where property-based test framework like Scalacheck comes handy</li>\n<li>We dont need to randomly generate Remote operation, because they are produced by <code class=\"language-text\">def change(op: LocalOp): (RemoteOp, A)</code></li>\n<li>If there’s no remote operation to be sync for <code class=\"language-text\">A</code>, it should be no-op</li>\n</ul>\n</li>\n<li>If we decide to perform a local change, we will generate a local operation, apply of <code class=\"language-text\">A</code>, then store the corresponding <code class=\"language-text\">RemoteOp</code> alongside every other copies</li>\n<li>If we decide to sync remote operations, then we should randomly consume <code class=\"language-text\">Q</code> remote op from the remote Op buffer, and apply them one by one to <code class=\"language-text\">A</code></li>\n<li>Repeat step 2 to step 5 for <code class=\"language-text\">k</code> times</li>\n<li>Then we should clear all remaining <code class=\"language-text\">RemoteOp</code> in each CmRDT’s remote op buffer, this is to ensure we eventually applies all operations to all copies</li>\n<li>Assert that all CmRDT copies return the same value from <code class=\"language-text\">read</code> operation, here we can finally explain the purpose of <code class=\"language-text\">read</code> operation, the rule here is that all CmRDT copies must converge to the same value, but they only have to converge on their ProjectValue, not necessarily everything, and this is captured by <code class=\"language-text\">read</code> operation</li>\n</ol>\n<p>Now, we can see how it works in code, we will start by declaring a test module</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">import</span> <span class=\"token namespace\">cats<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span></span>State\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">cats<span class=\"token punctuation\">.</span></span>Eval\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">cats<span class=\"token punctuation\">.</span>syntax<span class=\"token punctuation\">.</span>all<span class=\"token punctuation\">.</span></span>_\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">cats<span class=\"token punctuation\">.</span>instances<span class=\"token punctuation\">.</span>list<span class=\"token punctuation\">.</span></span>_\n\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>scalacheck<span class=\"token punctuation\">.</span></span>_\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>scalacheck<span class=\"token punctuation\">.</span>rng<span class=\"token punctuation\">.</span></span>Seed\n\n<span class=\"token keyword\">trait</span> CmRDTTestModule<span class=\"token punctuation\">[</span>Data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>initData<span class=\"token operator\">:</span> List<span class=\"token punctuation\">[</span>Data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> seed<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> repetition<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>using <span class=\"token keyword\">val</span> crdtEvi<span class=\"token operator\">:</span> CmRDT<span class=\"token punctuation\">[</span>Data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">def</span> localOpGen<span class=\"token punctuation\">(</span>dt<span class=\"token operator\">:</span> Data<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Gen<span class=\"token punctuation\">[</span>crdtEvi<span class=\"token punctuation\">.</span>LocalOp<span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> TestState<span class=\"token punctuation\">(</span>\n      seed<span class=\"token operator\">:</span> Seed<span class=\"token punctuation\">,</span>\n      dataWithNetwork<span class=\"token operator\">:</span> List<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span> UnreliableNetwork<span class=\"token punctuation\">[</span>crdtEvi<span class=\"token punctuation\">.</span>RemoteOp<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> List<span class=\"token punctuation\">.</span>empty\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Thanks to Scala3, traits can now take parameters, <code class=\"language-text\">Data</code> refers to the CRDT types, and initData is the collection of initial values, <code class=\"language-text\">seed</code> is passed in as well, so that we can simulate randomness deterministically, <code class=\"language-text\">repetition: Int</code> controls the no of loop we perform.</p>\n<p>The traits also expect <code class=\"language-text\">val crdtEvi: CmRDT[Data]</code>, to prove that <code class=\"language-text\">Data</code> is CmRDT. There is also 1 abstract method <code class=\"language-text\">def localOpGen(dt: Data): Gen[crdtEvi.LocalOp]</code> that should be implemented by concrete implementation, this allow us to generate <code class=\"language-text\">LocalOp</code>, the method takes a <code class=\"language-text\">Data</code> as input because sometimes we can only generate valid <code class=\"language-text\">LocalOp</code> with respect to existing state, for example in a KV store, it might be invalid to delete a non-existing key.</p>\n<p>Then we have an inner case class <code class=\"language-text\">TestState</code>, it represents all the state within the test flow, worth noting that it contains a list of <code class=\"language-text\">(Data, UnreliableNetwork[crdtEvi.RemoteOp])</code>, each tuple represent one CRDT with its corresponding RemoteOp buffer.</p>\n<p><a href=\"https://github.com/qingwei91/crdt-scala3/blob/07e60e7f1306f01a7ecd7cdb76f2ff935f1737be/modules/crdt/src/test/scala/crdt/UnreliableNetwork.scala#L6\">UnreliableNetwork</a> is a buffer of RemoteOp, it has some helper methods to help us manage the state. For simplicity, I wont show the full definition here.</p>\n<p>Now let’s look at the actual flow:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">trait</span> CmRDTTestModule<span class=\"token punctuation\">[</span>Data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>initData<span class=\"token operator\">:</span> List<span class=\"token punctuation\">[</span>Data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> seed<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> repetition<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>using <span class=\"token keyword\">val</span> crdtEvi<span class=\"token operator\">:</span> CmRDT<span class=\"token punctuation\">[</span>Data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">def</span> opsAreCommutative<span class=\"token operator\">:</span> <span class=\"token builtin\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> randomizedLoop<span class=\"token operator\">:</span> State<span class=\"token punctuation\">[</span>TestState<span class=\"token punctuation\">,</span> <span class=\"token builtin\">Unit</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n      <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> to <span class=\"token namespace\">repetition</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>foldLeft<span class=\"token punctuation\">(</span>State<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">[</span>TestState<span class=\"token punctuation\">,</span> <span class=\"token builtin\">Unit</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">case</span> <span class=\"token punctuation\">(</span>st<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span>\n        st<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>_ <span class=\"token keyword\">=></span> randomLocalChangeOrRemoteSync<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">val</span> <span class=\"token punctuation\">(</span>resultState<span class=\"token operator\">:</span> TestState<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n      randomizedLoop<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>_ <span class=\"token keyword\">=></span> clearRemainingRemoteOps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>initTestState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value\n\n\n    <span class=\"token keyword\">val</span> finalData <span class=\"token operator\">=</span> resultState<span class=\"token punctuation\">.</span>dataWithNetwork<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>_1<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">)</span>\n    assert<span class=\"token punctuation\">(</span>finalData<span class=\"token punctuation\">.</span>toSet<span class=\"token punctuation\">.</span>size <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">def opsAreCommutative</code> is our assertion method, before looking into the implementation, I wish point out that I implemented the flow using <a href=\"https://typelevel.org/cats/datatypes/state.html\">State Monad</a>, this allows us to model state mutation without side effect. It is easier this way because everytime we generate a random value, we need to mutate the <code class=\"language-text\">Seed</code> value to ensure the whole flow is deterministic. It is entirely possible to do without State monad and just mutate variable local to the trait, I just didnt do it that way.</p>\n<p>Now let’s look at the method, really it just performs 3 steps:</p>\n<ol>\n<li>Randomly perform local change or remote sync for <code class=\"language-text\">repetition</code> times, <code class=\"language-text\">repetition</code> is a Int argument, every time we will randomly pick a copy from all CRDT values</li>\n<li>Clear remaning remote ops for every CRDT data</li>\n<li>Check that all CRDT data converges</li>\n</ol>\n<p>I wont show all of the code for this test module because they are too noisy, if you’re interested, you can find them <a href=\"https://github.com/qingwei91/crdt-scala3/blob/07e60e7f1306f01a7ecd7cdb76f2ff935f1737be/modules/crdt/src/test/scala/crdt/CmRDTSpec.scala#L106\">here</a></p>\n<p>I think the more interesting part is that once we’ve implemented the TestModule in an abstract way, we can reuse the same test implementation to many different CRDT implementation with low overhead.</p>\n<p>Let’s look at the simplest CRDT, <code class=\"language-text\">Counter</code>, it is implemented this way:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\">opaque <span class=\"token keyword\">type</span> Counter <span class=\"token operator\">=</span> <span class=\"token builtin\">Double</span>\n<span class=\"token keyword\">object</span> Counter <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> apply<span class=\"token punctuation\">(</span>d<span class=\"token operator\">:</span> <span class=\"token builtin\">Double</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Counter <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span>\n  extension <span class=\"token punctuation\">(</span>x<span class=\"token operator\">:</span> Counter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">def</span> value<span class=\"token operator\">:</span> <span class=\"token builtin\">Double</span> <span class=\"token operator\">=</span> x\n  <span class=\"token punctuation\">}</span>\n\n  given counterCRDT<span class=\"token operator\">:</span> CmRDT<span class=\"token punctuation\">[</span>Counter<span class=\"token punctuation\">]</span> <span class=\"token keyword\">with</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span> Increment             <span class=\"token operator\">=</span> <span class=\"token builtin\">Double</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">type</span> RemoteOp     <span class=\"token operator\">=</span> Increment\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">type</span> LocalOp      <span class=\"token operator\">=</span> Increment\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">type</span> ProjectValue <span class=\"token operator\">=</span> Counter\n\n    extension <span class=\"token punctuation\">(</span>counter<span class=\"token operator\">:</span> Counter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">override</span> <span class=\"token keyword\">def</span> syncRemote<span class=\"token punctuation\">(</span>op<span class=\"token operator\">:</span> Increment<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Counter <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> op\n\n      <span class=\"token keyword\">override</span> <span class=\"token keyword\">def</span> change<span class=\"token punctuation\">(</span>delta<span class=\"token operator\">:</span> LocalOp<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>RemoteOp<span class=\"token punctuation\">,</span> Counter<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        delta <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> delta<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">override</span> <span class=\"token keyword\">def</span> read<span class=\"token operator\">:</span> ProjectValue <span class=\"token operator\">=</span> counter\n    <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here, we implement <code class=\"language-text\">Counter</code> as an opaque type, this is another new feature of <a href=\"https://docs.scala-lang.org/scala3/book/types-opaque-types.html\">Scala 3</a>. Basically we are saying Counter is a Double, but it can only be modified using methods defined here.</p>\n<p>We can see that the RemoteOp and LocalOp are the same, and they are just Increment. Then we can use our TestModule to test <code class=\"language-text\">Counter</code> this way.</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\">  test<span class=\"token punctuation\">(</span><span class=\"token string\">\"Counter is CRDT\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span>\n    <span class=\"token keyword\">val</span> counterIsCrDT <span class=\"token operator\">=</span>\n      <span class=\"token keyword\">new</span> CmRDTTestModule<span class=\"token punctuation\">[</span>Counter<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n        initData <span class=\"token operator\">=</span> List<span class=\"token punctuation\">(</span>Counter<span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Counter<span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Counter<span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        seed <span class=\"token operator\">=</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">,</span>\n        repetition <span class=\"token operator\">=</span> <span class=\"token number\">20</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token keyword\">with</span> Expectations<span class=\"token punctuation\">.</span>Helpers <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">def</span> localOpGen<span class=\"token punctuation\">(</span>dt<span class=\"token operator\">:</span> Counter<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Gen<span class=\"token punctuation\">[</span>crdtEvi<span class=\"token punctuation\">.</span>LocalOp<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n          Gen<span class=\"token punctuation\">.</span>double<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>asInstanceOf<span class=\"token punctuation\">[</span>crdtEvi<span class=\"token punctuation\">.</span>LocalOp<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    \n    counterIsCrDT<span class=\"token punctuation\">.</span>opsAreCommutative\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we define <code class=\"language-text\">CmRDTTestModule</code> for Counter, and all we need to provide are <code class=\"language-text\">initData</code> <code class=\"language-text\">seed</code>, <code class=\"language-text\">repetition</code> and <code class=\"language-text\">localOpGen</code>, they can all be provided trivially. Then we just need to execute the assertion method to verify that our Counter CmRDT is implemented correctly.</p>\n<p>Let’s look at a 2nd example of CRDT, Multi-Value Register, it is a very simple data structure that represents a single value, the special thing is that it can detect concurrent edit, and when this occurs it will keep all concurrent values and allow reader to resolve the conflict.</p>\n<p>It is represented using this fairly simple data structure</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> MVRegister<span class=\"token punctuation\">[</span>A<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n    pid<span class=\"token operator\">:</span> ProcessId<span class=\"token punctuation\">,</span>\n    existing<span class=\"token operator\">:</span> Set<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">,</span> VersionVector<span class=\"token punctuation\">.</span>Clock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    clock<span class=\"token operator\">:</span> VersionVector<span class=\"token punctuation\">.</span>Clock\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The full implementation of MVRegister CRDT is available <a href=\"https://github.com/qingwei91/crdt-scala3/blob/07e60e7f1306f01a7ecd7cdb76f2ff935f1737be/modules/crdt/src/main/scala/crdt/MVRegister.scala#L6\">here</a>.</p>\n<p>Then we can look at the test</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\">  test<span class=\"token punctuation\">(</span><span class=\"token string\">\"MVRegister is CRDT\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span>\n    <span class=\"token keyword\">val</span> registerIsCRDT <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> CmRDTTestModule<span class=\"token punctuation\">[</span>MVRegister<span class=\"token punctuation\">[</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n      initData <span class=\"token operator\">=</span> List<span class=\"token punctuation\">(</span>\n        MVRegister<span class=\"token punctuation\">[</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        MVRegister<span class=\"token punctuation\">[</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        MVRegister<span class=\"token punctuation\">[</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      seed <span class=\"token operator\">=</span> <span class=\"token number\">1002L</span><span class=\"token punctuation\">,</span>\n      repetition <span class=\"token operator\">=</span> <span class=\"token number\">20</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">with</span> Expectations<span class=\"token punctuation\">.</span>Helpers <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">override</span> <span class=\"token keyword\">def</span> localOpGen<span class=\"token punctuation\">(</span>dt<span class=\"token operator\">:</span> MVRegister<span class=\"token punctuation\">[</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Gen<span class=\"token punctuation\">[</span>crdtEvi<span class=\"token punctuation\">.</span>LocalOp<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n        Gen<span class=\"token punctuation\">.</span>long<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>toInt<span class=\"token punctuation\">.</span>asInstanceOf<span class=\"token punctuation\">[</span>crdtEvi<span class=\"token punctuation\">.</span>LocalOp<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    \n    registerIsCRDT<span class=\"token punctuation\">.</span>opsAreCommutative\n    \n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>We can see this test is very similar to the one we had for Counter, the main difference is the <code class=\"language-text\">initData</code> which is trivially different, and <code class=\"language-text\">localOpGen</code> is implemented differently.</p>\n<p>So we now have a very cheap way to test all CmRDT, provided that we can implement <code class=\"language-text\">CmRDT[A]</code> typeclasse for the type.</p>\n<h1>Conclusion</h1>\n<p>I hope this exercise shows the usefulness of distilling a problem into its absolute essence and encode into using a powerful expressive type system. </p>\n<p>It helps us to reason about problem and solution without much noise, for instance, we know that for a type to be a CmRDT, it needs to provide 3 methods and fulfill the commutative property of 2 of those methods. We can then compose these algebra to that provides interesting properties, an example here is our ability to leverage the typeclass to implement property check.</p>","frontmatter":{"title":"CRDT implemented using Typeclass","date":"April 17, 2022"}}},"pageContext":{"slug":"/crdt/","previous":{"fields":{"slug":"/management/guide/"},"frontmatter":{"title":"My thoughts of being a Manager in Software Development"}},"next":{"fields":{"slug":"/stateful-app/"},"frontmatter":{"title":"Build Stateful with fs2, cats-effect"}}}},"staticQueryHashes":[]}