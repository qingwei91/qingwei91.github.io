{"componentChunkName":"component---src-templates-blog-post-js","path":"/sqlserver/upsert-perf/","result":{"data":{"site":{"siteMetadata":{"title":"All models are wrong","author":"Qing Wei"}},"markdownRemark":{"id":"a32fcdb7-6ee4-5446-8ebe-9e6a08a96070","excerpt":"I’ve been dealing with SQL Server lately, mostly on the write side, one of the biggest challenge is to make the write faster. Context: We…","html":"<p>I’ve been dealing with SQL Server lately, mostly on the write side, one of the biggest challenge is to make the write faster.</p>\n<p>Context: We have a simple pipeline that read from kafka and upsert the records into SQL Server, reusing the key from kafka messages.</p>\n<p>Below are some tips I’ve learned:</p>\n<h2>Do not use auto-commit when writing multiple rows</h2>\n<p>By default, MS SQL jdbc driver use implicit transaction when writing to SQL Server, this is undesirable because the overhead of transaction is very high.</p>\n<p>This is so far the most significant factor in my case.</p>\n<h2>Prefer Table Valued Parameters over single row</h2>\n<p>According to MSDN docs, table valued param should perform better than updating row by row, it makes sense from a logical standpoint, but I’ve yet observe significant differences.\nNote that to use Table Valued Parameters, you need to define your update operation using a Stored Procedure, and define a corresponding Table Type on the server.</p>\n<p>In jdbc connector, there are 3 apis that can be use to model TableValue Parameters, anedoctally, the ISQLServerDataRecord is better than SQLServerDataTable because of its streaming purpose, I am not entirely convinced and havent find evidence on this yet.</p>\n<h2>There are 2 types of batching, client side and server side</h2>\n<p>One tip that come up a lot about SQL performance is batching, but this term can mean different thing in different cases;</p>\n<p>If the application performing write is using MSSQL JDBC driver, then one can perform batching from the client, it essentially combine many commands into a single unit of work. This is useful when you are submitting many commands, but if you are using Table Value Parameters then you dont have to batch as there’s only a single command.</p>\n<p>Another type of batching happen on server side, typically defined in Stored Procedures by T-SQL.</p>\n<p>The idea is to have a stored procedure taking Table Value Parameters, and then break it into chunks and perform update in chunk in a loop.</p>\n<p>I’ve read a few articles claiming this is the best way, but I havent try it out. It sounds plausible because it has the least network overhead and looping is done on server side.</p>\n<h2>Where to find docs</h2>\n<p>Oh god, MSDN doc on SQL Server is either too verbose or not on point, at least for my usage.</p>\n<p>I did however learn to look for AzureSQL docs even if you’re not using Azure, looks like that got more love.</p>\n<h2>Concurrent commands from different clients dont work well</h2>\n<p>This is not unexpected, as SQL Server being a ACID compliant RDBMS uses locks extensively, so concurrent commands tend to create lock contentions.</p>\n<p>Depending on the batch size, SQL Server will decide to use row-level lock or table level lock, I’ve seen people suggest 5000 is the threshold that control this lock escalation.</p>\n<p>Beyond this, every row lock also correpond to a page lock because data is really stored on page, and multiple concurrent changes of different rows can still access the same page, leading to contention.</p>\n<p>If you use clustered index (which you typically should), then your rows are layout according to the index, for example, if your clustered index is defined on an Int column in ascending order, then rows are stored on pages close to each other according to their index value, row 1 and row 2 are likely to be on the same page, where row 300000 might be further away in a different page.</p>","frontmatter":{"title":"SQL Server how to write many rows quicker","date":null}}},"pageContext":{"slug":"/sqlserver/upsert-perf/","previous":{"fields":{"slug":"/coding-interview/"},"frontmatter":{"title":"Random thoughts on coding interview"}},"next":{"fields":{"slug":"/stateful-app/"},"frontmatter":{"title":"Build Stateful with fs2, cats-effect"}}}},"staticQueryHashes":[]}